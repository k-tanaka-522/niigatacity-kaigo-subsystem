# 2.4.5.2.5 TypeScriptãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆJestï¼‰

## ç›®çš„

`.claude/docs/40_standards/42_typescript.md` ã«æº–æ‹ ã—ãŸJestãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

---

## ğŸ§ª Jestã®åŸºæœ¬

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install --save-dev jest @types/jest ts-jest
```

### è¨­å®šï¼ˆjest.config.jsï¼‰

```javascript
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/tests'],
  testMatch: ['**/*.test.ts'],
  collectCoverageFrom: [
    'src/**/*.ts',
    '!src/**/*.d.ts',
    '!src/index.ts',
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
};
```

### å®Ÿè¡Œ

```bash
# ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm test

# ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãã§å®Ÿè¡Œ
npm test -- --coverage

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å®Ÿè¡Œ
npm test -- userService.test.ts
```

---

## ğŸ“ ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®

```
tests/
â”œâ”€â”€ api/
â”‚   â””â”€â”€ routes.test.ts
â”œâ”€â”€ services/
â”‚   â””â”€â”€ userService.test.ts
â””â”€â”€ utils/
    â””â”€â”€ validators.test.ts
```

**å‘½åè¦å‰‡**:
- âœ… ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: `*.test.ts`
- âœ… ãƒ†ã‚¹ãƒˆé–¢æ•°: `test()` ã¾ãŸã¯ `it()`
- âœ… ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ: `describe()`

---

## âœ… ãƒ†ã‚¹ãƒˆä½œæˆã®åŸå‰‡

### 1. AAA (Arrange-Act-Assert) ãƒ‘ã‚¿ãƒ¼ãƒ³ â­â­â­

**åŸå‰‡**:
- âœ… **Arrange**: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
- âœ… **Act**: ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®å®Ÿè¡Œ
- âœ… **Assert**: çµæœã®æ¤œè¨¼

**ä¾‹**:

```typescript
import { UserService } from '../src/services/userService';
import { User } from '../src/models/user';

describe('UserService', () => {
  describe('getUser', () => {
    test('should return user when user exists', async () => {
      // Arrange: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
      const userId = 1;
      const expectedUser: User = {
        id: 1,
        name: 'Test User',
        email: 'test@example.com',
        createdAt: new Date(),
      };

      // Act: ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®å®Ÿè¡Œ
      const userService = new UserService();
      const result = await userService.getUser(userId);

      // Assert: çµæœã®æ¤œè¨¼
      expect(result).toEqual(expectedUser);
    });
  });
});
```

---

### 2. ãƒ¢ãƒƒã‚­ãƒ³ã‚°ï¼ˆjest.mockï¼‰ â­â­â­

**åŸå‰‡**:
- âœ… å¤–éƒ¨ä¾å­˜ã‚’ãƒ¢ãƒƒã‚¯
- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€HTTP APIã¯ãƒ¢ãƒƒã‚¯
- âœ… ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã¯é«˜é€Ÿã«

**ä¾‹**:

```typescript
import { UserService } from '../src/services/userService';
import { UserRepository } from '../src/repositories/userRepository';
import { User } from '../src/models/user';

// ãƒ¢ãƒƒã‚¯ã®ä½œæˆ
jest.mock('../src/repositories/userRepository');

describe('UserService', () => {
  let userService: UserService;
  let mockUserRepository: jest.Mocked<UserRepository>;

  beforeEach(() => {
    // ãƒ¢ãƒƒã‚¯ã®ãƒªã‚»ãƒƒãƒˆ
    jest.clearAllMocks();

    // ãƒ¢ãƒƒã‚¯ã®è¨­å®š
    mockUserRepository = new UserRepository() as jest.Mocked<UserRepository>;
    userService = new UserService(mockUserRepository);
  });

  test('should return user when user exists', async () => {
    // Arrange
    const userId = 1;
    const mockUser: User = {
      id: 1,
      name: 'Test User',
      email: 'test@example.com',
      createdAt: new Date(),
    };
    mockUserRepository.findById.mockResolvedValue(mockUser);

    // Act
    const result = await userService.getUser(userId);

    // Assert
    expect(result).toEqual(mockUser);
    expect(mockUserRepository.findById).toHaveBeenCalledWith(userId);
    expect(mockUserRepository.findById).toHaveBeenCalledTimes(1);
  });
});
```

---

### 3. éåŒæœŸãƒ†ã‚¹ãƒˆ â­â­â­

**åŸå‰‡**:
- âœ… `async/await` ã‚’ä½¿ç”¨
- âœ… PromiseãŒè§£æ±ºã•ã‚Œã‚‹ã¾ã§å¾…ã¤

**ä¾‹**:

```typescript
describe('UserService', () => {
  test('should get user asynchronously', async () => {
    // Arrange
    const userId = 1;

    // Act
    const result = await userService.getUser(userId);

    // Assert
    expect(result.id).toBe(userId);
  });

  test('should throw error when user not found', async () => {
    // Arrange
    const userId = 999;
    mockUserRepository.findById.mockResolvedValue(null);

    // Act & Assert
    await expect(userService.getUser(userId)).rejects.toThrow('User 999 not found');
  });
});
```

---

## ğŸ“‹ ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: æ­£å¸¸ç³»ãƒ†ã‚¹ãƒˆ

```typescript
import { UserService } from '../src/services/userService';
import { UserRepository } from '../src/repositories/userRepository';
import { User } from '../src/models/user';

jest.mock('../src/repositories/userRepository');

describe('UserService', () => {
  let userService: UserService;
  let mockUserRepository: jest.Mocked<UserRepository>;

  beforeEach(() => {
    mockUserRepository = new UserRepository() as jest.Mocked<UserRepository>;
    userService = new UserService(mockUserRepository);
  });

  test('should return user when user exists', async () => {
    // Arrange
    const mockUser: User = {
      id: 1,
      name: 'John Doe',
      email: 'john@example.com',
      createdAt: new Date(),
    };
    mockUserRepository.findById.mockResolvedValue(mockUser);

    // Act
    const result = await userService.getUser(1);

    // Assert
    expect(result).toEqual(mockUser);
  });
});
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆï¼ˆä¾‹å¤–ï¼‰

```typescript
describe('UserService', () => {
  test('should throw UserNotFoundError when user does not exist', async () => {
    // Arrange
    mockUserRepository.findById.mockResolvedValue(null);

    // Act & Assert
    await expect(userService.getUser(999)).rejects.toThrow('User 999 not found');
  });

  test('should throw DatabaseError when database fails', async () => {
    // Arrange
    mockUserRepository.findById.mockRejectedValue(new Error('DB Error'));

    // Act & Assert
    await expect(userService.getUser(1)).rejects.toThrow('DB Error');
  });
});
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³3: HTTP APIãƒ†ã‚¹ãƒˆï¼ˆExpressï¼‰

```typescript
import request from 'supertest';
import express from 'express';
import router from '../src/api/routes';

const app = express();
app.use(express.json());
app.use('/api', router);

describe('GET /api/users/:id', () => {
  test('should return user when user exists', async () => {
    // Act
    const response = await request(app).get('/api/users/1');

    // Assert
    expect(response.status).toBe(200);
    expect(response.body).toHaveProperty('id', 1);
    expect(response.body).toHaveProperty('name');
  });

  test('should return 404 when user not found', async () => {
    // Act
    const response = await request(app).get('/api/users/999');

    // Assert
    expect(response.status).toBe(404);
  });
});
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³4: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ãƒ†ã‚¹ãƒˆ

```typescript
import { validateEmail } from '../src/utils/validators';

describe('validateEmail', () => {
  test.each([
    ['test@example.com', true],
    ['user+tag@example.co.jp', true],
    ['invalid@', false],
    ['@example.com', false],
    ['noatsign.com', false],
  ])('validateEmail(%s) should return %s', (email, expected) => {
    expect(validateEmail(email)).toBe(expected);
  });
});
```

---

## âŒ Bad Example: ãƒ†ã‚¹ãƒˆãŒä¸é©åˆ‡

```typescript
// âŒ AAAãƒ‘ã‚¿ãƒ¼ãƒ³ãªã—
test('get user', async () => {
  const result = await service.getUser(1);
  expect(result.name).toBe('Test');
});

// âŒ ãƒ¢ãƒƒã‚¯ãªã—ï¼ˆå®Ÿéš›ã®DBã«ã‚¢ã‚¯ã‚»ã‚¹ï¼‰
test('get user from db', async () => {
  const result = await userService.getUser(1);  // âŒ å®ŸDB
  expect(result).toBeTruthy();
});

// âŒ ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ãªã—
test('something', async () => {
  await service.doSomething();
  // âŒ ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ãŒãªã„
});
```

**å•é¡Œç‚¹**:
- å¯èª­æ€§ãŒä½ã„
- ãƒ†ã‚¹ãƒˆãŒé…ã„ï¼ˆå®ŸDBã‚¢ã‚¯ã‚»ã‚¹ï¼‰
- ä½•ã‚’æ¤œè¨¼ã—ã¦ã„ã‚‹ã‹ä¸æ˜

---

## âœ… Good Example: é©åˆ‡ãªãƒ†ã‚¹ãƒˆ

```typescript
import { UserService } from '../src/services/userService';
import { UserRepository } from '../src/repositories/userRepository';
import { User } from '../src/models/user';
import { UserNotFoundError } from '../src/utils/errors';

jest.mock('../src/repositories/userRepository');

describe('UserService', () => {
  let userService: UserService;
  let mockUserRepository: jest.Mocked<UserRepository>;

  beforeEach(() => {
    mockUserRepository = new UserRepository() as jest.Mocked<UserRepository>;
    userService = new UserService(mockUserRepository);
  });

  describe('getUser', () => {
    test('should return user when user exists', async () => {
      // Arrange
      const mockUser: User = {
        id: 1,
        name: 'Test User',
        email: 'test@example.com',
        createdAt: new Date(),
      };
      mockUserRepository.findById.mockResolvedValue(mockUser);

      // Act
      const result = await userService.getUser(1);

      // Assert
      expect(result).toEqual(mockUser);
      expect(mockUserRepository.findById).toHaveBeenCalledWith(1);
    });

    test('should throw UserNotFoundError when user not found', async () => {
      // Arrange
      mockUserRepository.findById.mockResolvedValue(null);

      // Act & Assert
      await expect(userService.getUser(999)).rejects.toThrow(UserNotFoundError);
    });
  });
});
```

**æ”¹å–„ç‚¹**:
- âœ… AAAãƒ‘ã‚¿ãƒ¼ãƒ³
- âœ… ãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼ˆé«˜é€Ÿï¼‰
- âœ… æ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»ã®ä¸¡æ–¹ãƒ†ã‚¹ãƒˆ
- âœ… ãƒ¢ãƒƒã‚¯ã®å‘¼ã³å‡ºã—æ¤œè¨¼

---

## ğŸ” ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸

### ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š

```bash
npm test -- --coverage
```

### ç›®æ¨™

- âœ… **ã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š** â­â­â­

---

## ğŸ“ ãƒ†ã‚¹ãƒˆä½œæˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ã‚³ãƒ¼ãƒ‰ç”Ÿæˆæ™‚ã«ç¢ºèªï¼š

1. [ ] AAAãƒ‘ã‚¿ãƒ¼ãƒ³ã§è¨˜è¿°
2. [ ] å¤–éƒ¨ä¾å­˜ã‚’ãƒ¢ãƒƒã‚¯
3. [ ] æ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»ã®ä¸¡æ–¹ãƒ†ã‚¹ãƒˆ
4. [ ] `beforeEach` ã§ãƒ¢ãƒƒã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆ
5. [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š
6. [ ] ãƒ†ã‚¹ãƒˆãŒé«˜é€Ÿï¼ˆãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼‰

---

**ä½œæˆæ—¥**: 2025-10-19
**å¯¾è±¡ãƒ•ã‚§ãƒ¼ã‚º**: å®Ÿè£…
**é‡è¦åº¦**: â­â­â­ å¿…é ˆ
