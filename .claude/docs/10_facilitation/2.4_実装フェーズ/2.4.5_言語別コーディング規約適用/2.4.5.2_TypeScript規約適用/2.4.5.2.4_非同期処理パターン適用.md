# 2.4.5.2.4 TypeScriptéåŒæœŸå‡¦ç†ãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨

## ç›®çš„

TypeScriptã®async/awaitã‚’æ­£ã—ãä½¿ç”¨ã—ã€`.claude/docs/40_standards/42_typescript.md` ã«æº–æ‹ ã—ãŸéåŒæœŸå‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

---

## ğŸ¯ async/awaitã®åŸºæœ¬

### 1. asyncé–¢æ•°ã®å®šç¾© â­â­â­

**åŸå‰‡**:
- âœ… éåŒæœŸå‡¦ç†ã‚’è¡Œã†é–¢æ•°ã¯ `async` ã‚’ä»˜ä¸
- âœ… æˆ»ã‚Šå€¤ã¯ `Promise<T>` å‹
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¯ try-catch

**ä¾‹**:

```typescript
// âœ… asyncé–¢æ•°ã®åŸºæœ¬
async function getUser(userId: number): Promise<User> {
  const user = await db.query<User>('SELECT * FROM users WHERE id = $1', [userId]);
  return user;
}

// âœ… nullè¨±å®¹
async function findUser(userId: number): Promise<User | null> {
  const user = await db.query<User>('SELECT * FROM users WHERE id = $1', [userId]);
  return user || null;
}
```

---

### 2. awaitã®ä½¿ç”¨ â­â­â­

**åŸå‰‡**:
- âœ… Promiseã‚’è¿”ã™é–¢æ•°ã«ã¯ `await` ã‚’ä½¿ç”¨
- âœ… awaitã—å¿˜ã‚Œã«æ³¨æ„
- âœ… ä¸è¦ãªawaitã¯é¿ã‘ã‚‹

**ä¾‹**:

```typescript
// âœ… awaitã‚’ä½¿ç”¨
async function processUser(userId: number): Promise<void> {
  const user = await getUser(userId);  // âœ… awaitã‚’ä½¿ç”¨
  console.log(user.name);
}

// âŒ awaitã—å¿˜ã‚Œ
async function processUserBad(userId: number): Promise<void> {
  const user = getUser(userId);  // âŒ Promise<User> ãŒè¿”ã‚‹
  console.log(user.name);  // âŒ Promiseã«nameãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ãªã„
}
```

---

### 3. ä¸¦åˆ—å‡¦ç† â­â­

**åŸå‰‡**:
- âœ… ç‹¬ç«‹ã—ãŸéåŒæœŸå‡¦ç†ã¯ä¸¦åˆ—å®Ÿè¡Œ
- âœ… `Promise.all()` ã‚’ä½¿ç”¨
- âœ… `Promise.allSettled()` ã§ã‚¨ãƒ©ãƒ¼ã‚’å€‹åˆ¥å‡¦ç†

**ä¾‹**:

```typescript
// âœ… ä¸¦åˆ—å®Ÿè¡Œï¼ˆPromise.allï¼‰
async function getUsersParallel(userIds: number[]): Promise<User[]> {
  const promises = userIds.map(id => getUser(id));
  const users = await Promise.all(promises);  // âœ… ä¸¦åˆ—å®Ÿè¡Œ
  return users;
}

// âœ… ã‚¨ãƒ©ãƒ¼ã‚’å€‹åˆ¥å‡¦ç†ï¼ˆPromise.allSettledï¼‰
async function getUsersSafe(userIds: number[]): Promise<User[]> {
  const promises = userIds.map(id => getUser(id));
  const results = await Promise.allSettled(promises);

  return results
    .filter(result => result.status === 'fulfilled')
    .map(result => (result as PromiseFulfilledResult<User>).value);
}

// âŒ ç›´åˆ—å®Ÿè¡Œï¼ˆé…ã„ï¼‰
async function getUsersSequential(userIds: number[]): Promise<User[]> {
  const users: User[] = [];
  for (const id of userIds) {
    const user = await getUser(id);  // âŒ 1ã¤ãšã¤å®Ÿè¡Œï¼ˆé…ã„ï¼‰
    users.push(user);
  }
  return users;
}
```

---

## ğŸ“‹ éåŒæœŸå‡¦ç†ãƒ‘ã‚¿ãƒ¼ãƒ³

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: åŸºæœ¬çš„ãªasync/await

```typescript
import { User } from '../models/user';
import { UserNotFoundError } from '../utils/errors';
import logger from '../utils/logger';

async function getUser(userId: number): Promise<User> {
  try {
    const user = await db.query<User>('SELECT * FROM users WHERE id = $1', [userId]);
    if (!user) {
      throw new UserNotFoundError(`User ${userId} not found`);
    }
    return user;
  } catch (error) {
    logger.error(`Failed to get user ${userId}:`, error);
    throw error;
  }
}
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: ãƒªãƒˆãƒ©ã‚¤ä»˜ãéåŒæœŸå‡¦ç†

```typescript
async function fetchWithRetry<T>(
  fn: () => Promise<T>,
  maxRetries: number = 3,
  delay: number = 1000
): Promise<T> {
  let lastError: Error;

  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await fn();
    } catch (error) {
      lastError = error as Error;
      logger.warn(`Attempt ${attempt} failed:`, error);

      if (attempt < maxRetries) {
        await new Promise(resolve => setTimeout(resolve, delay * attempt));
      }
    }
  }

  throw lastError!;
}

// ä½¿ç”¨ä¾‹
const user = await fetchWithRetry(() => getUser(1), 3, 1000);
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³3: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãéåŒæœŸå‡¦ç†

```typescript
async function withTimeout<T>(
  promise: Promise<T>,
  timeoutMs: number
): Promise<T> {
  const timeoutPromise = new Promise<never>((_, reject) => {
    setTimeout(() => reject(new Error('Timeout')), timeoutMs);
  });

  return Promise.race([promise, timeoutPromise]);
}

// ä½¿ç”¨ä¾‹
try {
  const user = await withTimeout(getUser(1), 5000);  // 5ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
} catch (error) {
  logger.error('Timeout or error:', error);
}
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³4: ã‚­ãƒ¥ãƒ¼å‡¦ç†

```typescript
class TaskQueue<T> {
  private queue: Array<() => Promise<T>> = [];
  private running = 0;

  constructor(private concurrency: number = 1) {}

  async add(task: () => Promise<T>): Promise<T> {
    return new Promise((resolve, reject) => {
      this.queue.push(async () => {
        try {
          const result = await task();
          resolve(result);
        } catch (error) {
          reject(error);
        }
      });
      this.process();
    });
  }

  private async process(): Promise<void> {
    if (this.running >= this.concurrency || this.queue.length === 0) {
      return;
    }

    this.running++;
    const task = this.queue.shift()!;

    try {
      await task();
    } finally {
      this.running--;
      this.process();
    }
  }
}

// ä½¿ç”¨ä¾‹
const queue = new TaskQueue<User>(2);  // åŒæ™‚å®Ÿè¡Œæ•°2
const users = await Promise.all([
  queue.add(() => getUser(1)),
  queue.add(() => getUser(2)),
  queue.add(() => getUser(3)),
]);
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³5: Express/Fastifyã§ã®éåŒæœŸå‡¦ç†

```typescript
import { Router } from 'express';
import { UserService } from '../services/userService';

const router = Router();
const userService = new UserService();

// âœ… async/awaitã‚’ä½¿ç”¨
router.get('/users/:id', async (req, res, next) => {
  try {
    const userId = parseInt(req.params.id);
    const user = await userService.getUser(userId);
    res.json(user);
  } catch (error) {
    next(error);  // âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«æ¸¡ã™
  }
});

// âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆæœ€å¾Œã«é…ç½®ï¼‰
router.use((error: Error, req, res, next) => {
  logger.error('API error:', error);
  res.status(500).json({ error: error.message });
});

export default router;
```

---

## âŒ Bad Example: éåŒæœŸå‡¦ç†ã®èª¤ç”¨

```typescript
// âŒ awaitã—å¿˜ã‚Œ
async function processUser(userId: number) {
  const user = getUser(userId);  // âŒ Promise<User>
  console.log(user.name);  // âŒ Error
}

// âŒ ç›´åˆ—å®Ÿè¡Œï¼ˆé…ã„ï¼‰
async function getUsers(userIds: number[]) {
  const users = [];
  for (const id of userIds) {
    users.push(await getUser(id));  // âŒ 1ã¤ãšã¤å®Ÿè¡Œ
  }
  return users;
}

// âŒ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãªã—
async function getUserBad(userId: number) {
  const user = await db.query(userId);  // âŒ try-catchãªã—
  return user;
}

// âŒ Promiseã®ãƒã‚¹ãƒˆ
function getUserNested(userId: number) {
  return getUser(userId).then(user => {
    return processUser(user).then(result => {
      return result;  // âŒ ãƒã‚¹ãƒˆãŒæ·±ã„
    });
  });
}
```

**å•é¡Œç‚¹**:
- awaitã—å¿˜ã‚Œã§ãƒã‚°
- ç›´åˆ—å®Ÿè¡Œã§é…ã„
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãªã—
- ã‚³ãƒ¼ãƒ‰ãŒèª­ã¿ã«ãã„

---

## âœ… Good Example: é©åˆ‡ãªéåŒæœŸå‡¦ç†

```typescript
// âœ… awaitã‚’ä½¿ç”¨
async function processUser(userId: number): Promise<void> {
  const user = await getUser(userId);
  console.log(user.name);
}

// âœ… ä¸¦åˆ—å®Ÿè¡Œ
async function getUsers(userIds: number[]): Promise<User[]> {
  return Promise.all(userIds.map(id => getUser(id)));
}

// âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
async function getUser(userId: number): Promise<User> {
  try {
    const user = await db.query<User>('SELECT * FROM users WHERE id = $1', [userId]);
    if (!user) {
      throw new UserNotFoundError(`User ${userId} not found`);
    }
    return user;
  } catch (error) {
    logger.error(`Failed to get user ${userId}:`, error);
    throw error;
  }
}

// âœ… async/awaitã§ãƒ•ãƒ©ãƒƒãƒˆ
async function getUserAndProcess(userId: number): Promise<ProcessedUser> {
  const user = await getUser(userId);
  const processed = await processUser(user);
  return processed;
}
```

**æ”¹å–„ç‚¹**:
- âœ… awaitã‚’æ­£ã—ãä½¿ç”¨
- âœ… ä¸¦åˆ—å®Ÿè¡Œã§é«˜é€ŸåŒ–
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- âœ… èª­ã¿ã‚„ã™ã„ã‚³ãƒ¼ãƒ‰

---

## ğŸ” éåŒæœŸå‡¦ç†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ã‚³ãƒ¼ãƒ‰ç”Ÿæˆå‰ã«ç¢ºèªï¼š

1. [ ] éåŒæœŸå‡¦ç†ã‚’è¡Œã†é–¢æ•°ã« `async` ã‚’ä»˜ä¸
2. [ ] Promiseã‚’è¿”ã™é–¢æ•°ã« `await` ã‚’ä½¿ç”¨
3. [ ] ç‹¬ç«‹ã—ãŸéåŒæœŸå‡¦ç†ã¯ `Promise.all()` ã§ä¸¦åˆ—å®Ÿè¡Œ
4. [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆtry-catchï¼‰
5. [ ] æˆ»ã‚Šå€¤ã®å‹ã¯ `Promise<T>`
6. [ ] ä¸è¦ãªawaitã¯é¿ã‘ã‚‹

---

**ä½œæˆæ—¥**: 2025-10-19
**å¯¾è±¡ãƒ•ã‚§ãƒ¼ã‚º**: å®Ÿè£…
**é‡è¦åº¦**: â­â­â­ å¿…é ˆ
