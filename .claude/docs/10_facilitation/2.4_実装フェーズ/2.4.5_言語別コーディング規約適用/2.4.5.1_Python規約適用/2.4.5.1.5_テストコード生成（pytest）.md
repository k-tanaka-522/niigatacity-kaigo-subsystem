# 2.4.5.1.5 Pythonãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆpytestï¼‰

## ç›®çš„

`.claude/docs/40_standards/41_python.md` ã«æº–æ‹ ã—ãŸpytestãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

---

## ğŸ§ª pytestã®åŸºæœ¬

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
pip install pytest pytest-asyncio pytest-cov
```

### å®Ÿè¡Œ

```bash
# ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pytest

# ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãã§å®Ÿè¡Œ
pytest --cov=src --cov-report=html

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å®Ÿè¡Œ
pytest tests/test_services/test_user_service.py
```

---

## ğŸ“ ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®

```
tests/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ conftest.py           # pytestå…±é€šè¨­å®š
â”œâ”€â”€ test_api/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ test_routes.py
â”œâ”€â”€ test_services/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ test_user_service.py
â””â”€â”€ test_repositories/
    â”œâ”€â”€ __init__.py
    â””â”€â”€ test_user_repository.py
```

**å‘½åè¦å‰‡**:
- âœ… ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: `test_*.py` ã¾ãŸã¯ `*_test.py`
- âœ… ãƒ†ã‚¹ãƒˆé–¢æ•°: `test_*`
- âœ… ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹: `Test*`

---

## âœ… ãƒ†ã‚¹ãƒˆä½œæˆã®åŸå‰‡

### 1. AAA (Arrange-Act-Assert) ãƒ‘ã‚¿ãƒ¼ãƒ³ â­â­â­

**åŸå‰‡**:
- âœ… **Arrange**: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
- âœ… **Act**: ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®å®Ÿè¡Œ
- âœ… **Assert**: çµæœã®æ¤œè¨¼

**ä¾‹**:

```python
import pytest
from src.services.user_service import UserService
from src.models.user import User

@pytest.mark.asyncio
async def test_get_user_success():
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—æˆåŠŸã®ãƒ†ã‚¹ãƒˆ"""
    # Arrange: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
    user_id = 1
    expected_user = User(id=1, name="Test User", email="test@example.com")

    # Act: ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®å®Ÿè¡Œ
    service = UserService()
    result = await service.get_user(user_id)

    # Assert: çµæœã®æ¤œè¨¼
    assert result.id == expected_user.id
    assert result.name == expected_user.name
```

---

### 2. ãƒ¢ãƒƒã‚­ãƒ³ã‚°ï¼ˆunittest.mockï¼‰ â­â­â­

**åŸå‰‡**:
- âœ… å¤–éƒ¨ä¾å­˜ã‚’ãƒ¢ãƒƒã‚¯
- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€HTTP APIã¯ãƒ¢ãƒƒã‚¯
- âœ… ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã¯é«˜é€Ÿã«

**ä¾‹**:

```python
import pytest
from unittest.mock import AsyncMock, MagicMock
from src.services.user_service import UserService
from src.repositories.user_repository import UserRepository
from src.models.user import User

@pytest.mark.asyncio
async def test_get_user_with_mock():
    """ãƒ¢ãƒƒã‚¯ã‚’ä½¿ã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ãƒ†ã‚¹ãƒˆ"""
    # Arrange: Mockã®ä½œæˆ
    mock_repo = AsyncMock(spec=UserRepository)
    mock_repo.find_by_id.return_value = User(
        id=1, name="Mock User", email="mock@example.com"
    )

    # Act
    service = UserService(mock_repo)
    result = await service.get_user(1)

    # Assert
    assert result.name == "Mock User"
    mock_repo.find_by_id.assert_called_once_with(1)
```

---

### 3. ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ï¼ˆconftest.pyï¼‰ â­â­

**åŸå‰‡**:
- âœ… å…±é€šã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã¯ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã§å®šç¾©
- âœ… `conftest.py` ã«è¨˜è¿°

**ä¾‹**:

```python
# tests/conftest.py
import pytest
from unittest.mock import AsyncMock
from src.repositories.user_repository import UserRepository
from src.models.user import User

@pytest.fixture
def mock_user_repo():
    """UserRepositoryã®ãƒ¢ãƒƒã‚¯"""
    mock = AsyncMock(spec=UserRepository)
    return mock

@pytest.fixture
def sample_user():
    """ã‚µãƒ³ãƒ—ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼"""
    return User(id=1, name="Test User", email="test@example.com")

# tests/test_services/test_user_service.py
import pytest
from src.services.user_service import UserService

@pytest.mark.asyncio
async def test_get_user(mock_user_repo, sample_user):
    """ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‚’ä½¿ã£ãŸãƒ†ã‚¹ãƒˆ"""
    # Arrange
    mock_user_repo.find_by_id.return_value = sample_user

    # Act
    service = UserService(mock_user_repo)
    result = await service.get_user(1)

    # Assert
    assert result == sample_user
```

---

### 4. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ãƒ†ã‚¹ãƒˆ â­â­

**åŸå‰‡**:
- âœ… è¤‡æ•°ã®å…¥åŠ›ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’1ã¤ã®ãƒ†ã‚¹ãƒˆã§æ¤œè¨¼
- âœ… `@pytest.mark.parametrize` ã‚’ä½¿ç”¨

**ä¾‹**:

```python
import pytest
from src.utils.validators import validate_email

@pytest.mark.parametrize("email,expected", [
    ("test@example.com", True),
    ("user+tag@example.co.jp", True),
    ("invalid@", False),
    ("@example.com", False),
    ("noatsign.com", False),
])
def test_validate_email(email, expected):
    """ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ãƒ†ã‚¹ãƒˆ"""
    assert validate_email(email) == expected
```

---

## ğŸ“‹ ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: æ­£å¸¸ç³»ãƒ†ã‚¹ãƒˆ

```python
import pytest
from src.services.user_service import UserService
from src.models.user import User

@pytest.mark.asyncio
async def test_get_user_success(mock_user_repo, sample_user):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—æˆåŠŸã®ãƒ†ã‚¹ãƒˆ"""
    # Arrange
    mock_user_repo.find_by_id.return_value = sample_user

    # Act
    service = UserService(mock_user_repo)
    result = await service.get_user(1)

    # Assert
    assert result.id == 1
    assert result.name == "Test User"
    assert result.email == "test@example.com"
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆï¼ˆä¾‹å¤–ï¼‰

```python
import pytest
from src.services.user_service import UserService
from src.utils.exceptions import UserNotFoundError

@pytest.mark.asyncio
async def test_get_user_not_found(mock_user_repo):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ãƒ†ã‚¹ãƒˆ"""
    # Arrange
    mock_user_repo.find_by_id.return_value = None

    # Act & Assert
    service = UserService(mock_user_repo)
    with pytest.raises(UserNotFoundError):
        await service.get_user(999)
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³3: HTTP APIãƒ†ã‚¹ãƒˆï¼ˆFastAPIï¼‰

```python
import pytest
from httpx import AsyncClient
from src.main import app

@pytest.mark.asyncio
async def test_get_user_api_success():
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—APIæˆåŠŸã®ãƒ†ã‚¹ãƒˆ"""
    # Arrange
    async with AsyncClient(app=app, base_url="http://test") as client:
        # Act
        response = await client.get("/users/1")

        # Assert
        assert response.status_code == 200
        data = response.json()
        assert data["id"] == 1
        assert "name" in data

@pytest.mark.asyncio
async def test_get_user_api_not_found():
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—APIå¤±æ•—ã®ãƒ†ã‚¹ãƒˆ"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        response = await client.get("/users/999")
        assert response.status_code == 404
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³4: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆï¼‰

```python
import pytest
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from src.repositories.user_repository import UserRepository
from src.models.user import User

@pytest.fixture
async def test_db():
    """ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹"""
    engine = create_async_engine("sqlite+aiosqlite:///:memory:")
    # ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    yield engine
    await engine.dispose()

@pytest.mark.asyncio
async def test_user_repository_find_by_id(test_db):
    """UserRepositoryçµ±åˆãƒ†ã‚¹ãƒˆ"""
    # Arrange
    async with AsyncSession(test_db) as session:
        user = User(id=1, name="Test", email="test@example.com")
        session.add(user)
        await session.commit()

        # Act
        repo = UserRepository(session)
        result = await repo.find_by_id(1)

        # Assert
        assert result.id == 1
        assert result.name == "Test"
```

---

## âŒ Bad Example: ãƒ†ã‚¹ãƒˆãŒä¸é©åˆ‡

```python
# âŒ AAAãƒ‘ã‚¿ãƒ¼ãƒ³ãªã—
def test_get_user():
    result = service.get_user(1)
    assert result.name == "Test"

# âŒ ãƒ¢ãƒƒã‚¯ãªã—ï¼ˆå®Ÿéš›ã®DBã«ã‚¢ã‚¯ã‚»ã‚¹ï¼‰
def test_get_user_from_db():
    result = UserService().get_user(1)  # âŒ å®ŸDB
    assert result is not None

# âŒ ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ãªã—
def test_something():
    result = service.do_something()
    # âŒ ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ãŒãªã„
```

**å•é¡Œç‚¹**:
- å¯èª­æ€§ãŒä½ã„
- ãƒ†ã‚¹ãƒˆãŒé…ã„ï¼ˆå®ŸDBã‚¢ã‚¯ã‚»ã‚¹ï¼‰
- ä½•ã‚’æ¤œè¨¼ã—ã¦ã„ã‚‹ã‹ä¸æ˜

---

## âœ… Good Example: é©åˆ‡ãªãƒ†ã‚¹ãƒˆ

```python
import pytest
from unittest.mock import AsyncMock
from src.services.user_service import UserService
from src.repositories.user_repository import UserRepository
from src.models.user import User
from src.utils.exceptions import UserNotFoundError

@pytest.mark.asyncio
async def test_get_user_success():
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—æˆåŠŸã®ãƒ†ã‚¹ãƒˆ"""
    # Arrange: ãƒ¢ãƒƒã‚¯ã®æº–å‚™
    mock_repo = AsyncMock(spec=UserRepository)
    mock_repo.find_by_id.return_value = User(
        id=1, name="Test User", email="test@example.com"
    )

    # Act: ã‚µãƒ¼ãƒ“ã‚¹ã®å®Ÿè¡Œ
    service = UserService(mock_repo)
    result = await service.get_user(1)

    # Assert: çµæœã®æ¤œè¨¼
    assert result.id == 1
    assert result.name == "Test User"
    assert result.email == "test@example.com"
    mock_repo.find_by_id.assert_called_once_with(1)

@pytest.mark.asyncio
async def test_get_user_not_found():
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ãƒ†ã‚¹ãƒˆ"""
    # Arrange
    mock_repo = AsyncMock(spec=UserRepository)
    mock_repo.find_by_id.return_value = None

    # Act & Assert
    service = UserService(mock_repo)
    with pytest.raises(UserNotFoundError):
        await service.get_user(999)
```

**æ”¹å–„ç‚¹**:
- âœ… AAAãƒ‘ã‚¿ãƒ¼ãƒ³
- âœ… ãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼ˆé«˜é€Ÿï¼‰
- âœ… æ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»ã®ä¸¡æ–¹ãƒ†ã‚¹ãƒˆ
- âœ… ãƒ¢ãƒƒã‚¯ã®å‘¼ã³å‡ºã—æ¤œè¨¼

---

## ğŸ” ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸

### ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š

```bash
pytest --cov=src --cov-report=html
```

### ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç¢ºèª

```bash
open htmlcov/index.html
```

### ç›®æ¨™

- âœ… **ã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š** â­â­â­

---

## ğŸ“ ãƒ†ã‚¹ãƒˆä½œæˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ã‚³ãƒ¼ãƒ‰ç”Ÿæˆæ™‚ã«ç¢ºèªï¼š

1. [ ] AAAãƒ‘ã‚¿ãƒ¼ãƒ³ã§è¨˜è¿°
2. [ ] å¤–éƒ¨ä¾å­˜ã‚’ãƒ¢ãƒƒã‚¯
3. [ ] æ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»ã®ä¸¡æ–¹ãƒ†ã‚¹ãƒˆ
4. [ ] ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‚’æ´»ç”¨
5. [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š
6. [ ] ãƒ†ã‚¹ãƒˆãŒé«˜é€Ÿï¼ˆãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼‰

---

**ä½œæˆæ—¥**: 2025-10-19
**å¯¾è±¡ãƒ•ã‚§ãƒ¼ã‚º**: å®Ÿè£…
**é‡è¦åº¦**: â­â­â­ å¿…é ˆ
