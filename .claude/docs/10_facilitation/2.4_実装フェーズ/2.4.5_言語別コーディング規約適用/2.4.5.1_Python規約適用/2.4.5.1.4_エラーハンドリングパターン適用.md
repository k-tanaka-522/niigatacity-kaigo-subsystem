# 2.4.5.1.4 Pythonã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨

## ç›®çš„

`.claude/docs/40_standards/41_python.md` ã«æº–æ‹ ã—ãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

---

## ğŸ¯ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®åŸå‰‡

### 1. ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚’ä½¿ç”¨ â­â­â­æœ€é‡è¦

**åŸå‰‡**:
- âœ… ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ã‚¨ãƒ©ãƒ¼ã¯ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–
- âœ… æ±ç”¨çš„ãª `Exception` ã¯ä½¿ã‚ãªã„
- âœ… éšå±¤æ§‹é€ ã‚’æŒãŸã›ã‚‹

**ä¾‹**:

```python
# src/utils/exceptions.py
class AppException(Exception):
    """ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®åŸºåº•ä¾‹å¤–"""
    pass

class UserNotFoundError(AppException):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„"""
    pass

class InvalidEmailError(AppException):
    """ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç„¡åŠ¹"""
    pass

class DatabaseError(AppException):
    """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼"""
    pass
```

---

### 2. try-except ã‚’é©åˆ‡ã«ä½¿ç”¨ â­â­â­

**åŸå‰‡**:
- âœ… å…·ä½“çš„ãªä¾‹å¤–ã‚’ã‚­ãƒ£ãƒƒãƒ
- âœ… `except Exception` ã¯æœ€å¾Œã®æ‰‹æ®µ
- âœ… ãƒ­ã‚°ã‚’å‡ºåŠ›
- âœ… å†é€å‡ºï¼ˆre-raiseï¼‰ã‚’æ¤œè¨

**ä¾‹**:

```python
from src.utils.exceptions import UserNotFoundError, DatabaseError
import logging

logger = logging.getLogger(__name__)

async def get_user(user_id: int) -> User:
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã€‚

    Args:
        user_id (int): ãƒ¦ãƒ¼ã‚¶ãƒ¼ID

    Returns:
        User: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±

    Raises:
        UserNotFoundError: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
        DatabaseError: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
    """
    try:
        user = await db.query(User).filter(User.id == user_id).first()
        if user is None:
            raise UserNotFoundError(f"User {user_id} not found")
        return user
    except SQLAlchemyError as e:
        logger.error(f"Database error: {e}")
        raise DatabaseError(f"Failed to get user {user_id}") from e
    except Exception as e:
        logger.error(f"Unexpected error: {e}")
        raise
```

---

### 3. ãƒ­ã‚°å‡ºåŠ› â­â­â­å¿…é ˆ

**åŸå‰‡**:
- âœ… ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã¯å¿…ãšãƒ­ã‚°å‡ºåŠ›
- âœ… `logger.error()` ã¾ãŸã¯ `logger.exception()`
- âœ… ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å«ã‚ã‚‹

**ä¾‹**:

```python
import logging

logger = logging.getLogger(__name__)

try:
    result = risky_operation()
except ValueError as e:
    logger.error(f"Value error occurred: {e}")
    raise
except Exception as e:
    logger.exception("Unexpected error occurred")  # âœ… ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹å«ã‚€
    raise
```

---

### 4. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ˜ç¢ºåŒ– â­â­

**åŸå‰‡**:
- âœ… ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ–‡è„ˆæƒ…å ±ã‚’å«ã‚ã‚‹
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¦‹ã›ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨å†…éƒ¨ãƒ­ã‚°ã‚’åˆ†ã‘ã‚‹

**ä¾‹**:

```python
class UserNotFoundError(AppException):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„"""

    def __init__(self, user_id: int):
        self.user_id = user_id
        # âœ… è©³ç´°ãªå†…éƒ¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        super().__init__(f"User with ID {user_id} not found in database")

    def user_message(self) -> str:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"""
        # âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¦‹ã›ã‚‹ç°¡æ½”ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        return "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
```

---

## ğŸ“‹ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: åŸºæœ¬çš„ãªtry-except

```python
from typing import Optional
from src.utils.exceptions import UserNotFoundError
import logging

logger = logging.getLogger(__name__)

def get_user(user_id: int) -> Optional[User]:
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—"""
    try:
        user = db.query(User).filter(User.id == user_id).first()
        if user is None:
            raise UserNotFoundError(user_id)
        return user
    except UserNotFoundError:
        logger.warning(f"User {user_id} not found")
        raise
    except Exception as e:
        logger.exception(f"Unexpected error: {e}")
        raise
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: ãƒªãƒˆãƒ©ã‚¤ä»˜ãã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```python
import asyncio
from typing import Optional
import logging

logger = logging.getLogger(__name__)

async def fetch_data_with_retry(
    url: str,
    max_retries: int = 3
) -> Optional[dict]:
    """ãƒªãƒˆãƒ©ã‚¤ä»˜ãã§ãƒ‡ãƒ¼ã‚¿å–å¾—"""
    for attempt in range(max_retries):
        try:
            response = await http_client.get(url)
            return response.json()
        except TimeoutError as e:
            logger.warning(f"Timeout (attempt {attempt + 1}/{max_retries}): {e}")
            if attempt == max_retries - 1:
                raise
            await asyncio.sleep(2 ** attempt)  # Exponential backoff
        except Exception as e:
            logger.error(f"Unexpected error: {e}")
            raise
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³3: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ã§ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```python
from contextlib import asynccontextmanager
from typing import AsyncGenerator
import logging

logger = logging.getLogger(__name__)

@asynccontextmanager
async def database_session() -> AsyncGenerator[AsyncSession, None]:
    """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç®¡ç†"""
    session = AsyncSession()
    try:
        yield session
        await session.commit()
    except Exception as e:
        logger.error(f"Database error, rolling back: {e}")
        await session.rollback()
        raise
    finally:
        await session.close()

# ä½¿ç”¨ä¾‹
async with database_session() as session:
    user = await session.query(User).first()
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³4: FastAPIã§ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```python
from fastapi import FastAPI, HTTPException
from src.utils.exceptions import UserNotFoundError

app = FastAPI()

@app.exception_handler(UserNotFoundError)
async def user_not_found_handler(request, exc: UserNotFoundError):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼"""
    logger.warning(f"User not found: {exc.user_id}")
    raise HTTPException(
        status_code=404,
        detail=exc.user_message()
    )

@app.get("/users/{user_id}")
async def get_user(user_id: int):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—API"""
    # UserNotFoundErrorãŒç™ºç”Ÿã™ã‚‹ã¨è‡ªå‹•çš„ã«404ã‚’è¿”ã™
    return await user_service.get_user(user_id)
```

---

## âŒ Bad Example: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä¸é©åˆ‡

```python
# âŒ æ±ç”¨çš„ãªExceptionã‚’ã‚­ãƒ£ãƒƒãƒ
try:
    user = db.query(User).first()
except Exception:
    pass  # âŒ ä½•ã‚‚ã—ãªã„

# âŒ ãƒ­ã‚°ãªã—
try:
    user = db.query(User).first()
except ValueError:
    return None  # âŒ ãƒ­ã‚°ãŒãªã„

# âŒ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒä¸æ˜ç­
raise Exception("Error")  # âŒ ä½•ã®ã‚¨ãƒ©ãƒ¼ã‹ä¸æ˜
```

**å•é¡Œç‚¹**:
- ã‚¨ãƒ©ãƒ¼ãŒæ¡ã‚Šã¤ã¶ã•ã‚Œã‚‹
- ãƒ‡ãƒãƒƒã‚°ãŒå›°é›£
- ã‚¨ãƒ©ãƒ¼ã®åŸå› ãŒä¸æ˜

---

## âœ… Good Example: é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```python
from src.utils.exceptions import UserNotFoundError, DatabaseError
import logging

logger = logging.getLogger(__name__)

async def get_user(user_id: int) -> User:
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã€‚

    Args:
        user_id (int): ãƒ¦ãƒ¼ã‚¶ãƒ¼ID

    Returns:
        User: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±

    Raises:
        UserNotFoundError: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
        DatabaseError: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
    """
    try:
        user = await db.query(User).filter(User.id == user_id).first()
        if user is None:
            logger.warning(f"User {user_id} not found")
            raise UserNotFoundError(user_id)
        return user
    except SQLAlchemyError as e:
        logger.error(f"Database error when getting user {user_id}: {e}")
        raise DatabaseError(f"Failed to get user {user_id}") from e
    except Exception as e:
        logger.exception(f"Unexpected error when getting user {user_id}")
        raise
```

**æ”¹å–„ç‚¹**:
- âœ… ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚’ä½¿ç”¨
- âœ… å…·ä½“çš„ãªä¾‹å¤–ã‚’ã‚­ãƒ£ãƒƒãƒ
- âœ… ãƒ­ã‚°å‡ºåŠ›
- âœ… ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ˜ç¢º
- âœ… docstringã«Raisesã‚»ã‚¯ã‚·ãƒ§ãƒ³

---

## ğŸ” ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ã‚³ãƒ¼ãƒ‰ç”Ÿæˆå‰ã«ç¢ºèªï¼š

1. [ ] ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©
2. [ ] å…·ä½“çš„ãªä¾‹å¤–ã‚’ã‚­ãƒ£ãƒƒãƒï¼ˆ`except Exception` ã¯æœ€å¾Œã®æ‰‹æ®µï¼‰
3. [ ] ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«ãƒ­ã‚°å‡ºåŠ›
4. [ ] ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ–‡è„ˆæƒ…å ±ã‚’å«ã‚ã‚‹
5. [ ] docstringã«Raisesã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨˜è¼‰
6. [ ] å¿…è¦ã«å¿œã˜ã¦ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…

---

**ä½œæˆæ—¥**: 2025-10-19
**å¯¾è±¡ãƒ•ã‚§ãƒ¼ã‚º**: å®Ÿè£…
**é‡è¦åº¦**: â­â­â­ å¿…é ˆ
