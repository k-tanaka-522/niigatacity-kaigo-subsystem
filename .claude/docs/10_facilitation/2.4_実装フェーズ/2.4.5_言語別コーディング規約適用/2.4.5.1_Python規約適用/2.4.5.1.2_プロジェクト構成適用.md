# 2.4.5.1.2 Pythonãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆé©ç”¨

## ç›®çš„

`.claude/docs/40_standards/41_python.md` ã«æº–æ‹ ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆã‚’å®Ÿè£…ã—ã¾ã™ã€‚

---

## ğŸ“ æ¨™æº–ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

```
myproject/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py           # ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ api/              # APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆFastAPIç­‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ routes.py
â”‚   â”‚   â””â”€â”€ dependencies.py
â”‚   â”œâ”€â”€ models/           # ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ï¼ˆPydantic, SQLAlchemyç­‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â””â”€â”€ product.py
â”‚   â”œâ”€â”€ services/         # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user_service.py
â”‚   â”‚   â””â”€â”€ product_service.py
â”‚   â”œâ”€â”€ repositories/     # ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ï¼ˆoptionalï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ user_repository.py
â”‚   â””â”€â”€ utils/            # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ logger.py
â”‚       â””â”€â”€ validators.py
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ conftest.py       # pytestå…±é€šè¨­å®š
â”‚   â”œâ”€â”€ test_api/
â”‚   â”‚   â””â”€â”€ test_routes.py
â”‚   â””â”€â”€ test_services/
â”‚       â””â”€â”€ test_user_service.py
â”œâ”€â”€ infra/                # ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ãƒ¼ãƒ‰ï¼ˆIaCï¼‰
â”‚   â”œâ”€â”€ cloudformation/
â”‚   â””â”€â”€ terraform/
â”œâ”€â”€ .env.example          # ç’°å¢ƒå¤‰æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
â”œâ”€â”€ .gitignore
â”œâ”€â”€ pyproject.toml        # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ï¼ˆæ¨å¥¨ï¼‰
â”œâ”€â”€ requirements.txt      # ã¾ãŸã¯ requirements.txt
â””â”€â”€ README.md
```

---

## âœ… å„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å½¹å‰²

### 1. `src/` - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰

**ç›®çš„**: ã™ã¹ã¦ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ã“ã“ã«é›†ç´„

**ãƒ«ãƒ¼ãƒ«**:
- âœ… å„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« `__init__.py` ã‚’é…ç½®
- âœ… å±¤åˆ¥è¨­è¨ˆã‚’å¾¹åº•ï¼ˆapi, models, services, repositories, utilsï¼‰
- âœ… ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¯ `services/` ã«é…ç½®
- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã¯ `models/` ã«é…ç½®

---

### 2. `src/api/` - APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

**ç›®çš„**: HTTP APIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®šç¾©

**ä¾‹**: FastAPI

```python
# src/api/routes.py
from fastapi import APIRouter, Depends
from src.services.user_service import UserService
from src.api.dependencies import get_user_service

router = APIRouter()

@router.get("/users/{user_id}")
async def get_user(
    user_id: int,
    user_service: UserService = Depends(get_user_service)
):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—"""
    return await user_service.get_user(user_id)
```

---

### 3. `src/models/` - ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

**ç›®çš„**: ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å®šç¾©ï¼ˆPydantic, SQLAlchemyç­‰ï¼‰

**ä¾‹**: Pydantic

```python
# src/models/user.py
from pydantic import BaseModel, EmailStr
from typing import Optional

class User(BaseModel):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«"""
    id: int
    name: str
    email: EmailStr
    age: Optional[int] = None
```

---

### 4. `src/services/` - ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ â­é‡è¦

**ç›®çš„**: ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã‚’å®Ÿè£…

**åŸå‰‡**:
- âœ… APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹
- âœ… ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ï¼ˆrepositoriesï¼‰ã‚’ä½¿ç”¨
- âœ… ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆãŒå®¹æ˜“

**ä¾‹**:

```python
# src/services/user_service.py
from typing import Optional
from src.models.user import User
from src.repositories.user_repository import UserRepository
from src.utils.exceptions import UserNotFoundError
import logging

logger = logging.getLogger(__name__)

class UserService:
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯"""

    def __init__(self, user_repository: UserRepository):
        self.user_repository = user_repository

    async def get_user(self, user_id: int) -> User:
        """
        ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã€‚

        Args:
            user_id (int): ãƒ¦ãƒ¼ã‚¶ãƒ¼ID

        Returns:
            User: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±

        Raises:
            UserNotFoundError: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
        """
        user = await self.user_repository.find_by_id(user_id)
        if user is None:
            logger.warning(f"User {user_id} not found")
            raise UserNotFoundError(f"User {user_id} not found")
        return user
```

---

### 5. `src/repositories/` - ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ï¼ˆoptionalï¼‰

**ç›®çš„**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ã‚’æŠ½è±¡åŒ–

**åŸå‰‡**:
- âœ… SQLAlchemyã‚„ä»–ã®ORMã‚’ä½¿ç”¨
- âœ… ã‚µãƒ¼ãƒ“ã‚¹å±¤ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹
- âœ… ãƒ†ã‚¹ãƒˆæ™‚ã«ãƒ¢ãƒƒã‚¯å¯èƒ½

**ä¾‹**:

```python
# src/repositories/user_repository.py
from typing import Optional
from src.models.user import User
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select

class UserRepository:
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤"""

    def __init__(self, session: AsyncSession):
        self.session = session

    async def find_by_id(self, user_id: int) -> Optional[User]:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—"""
        result = await self.session.execute(
            select(User).where(User.id == user_id)
        )
        return result.scalars().first()
```

---

### 6. `src/utils/` - ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

**ç›®çš„**: å…±é€šæ©Ÿèƒ½ã‚’æä¾›

**ä¾‹**:

```python
# src/utils/logger.py
import logging
import sys

def setup_logger(name: str) -> logging.Logger:
    """ãƒ­ã‚¬ãƒ¼ã‚’è¨­å®šã™ã‚‹"""
    logger = logging.getLogger(name)
    logger.setLevel(logging.INFO)

    handler = logging.StreamHandler(sys.stdout)
    handler.setLevel(logging.INFO)

    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    handler.setFormatter(formatter)

    logger.addHandler(handler)
    return logger
```

---

### 7. `tests/` - ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

**ç›®çš„**: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã€çµ±åˆãƒ†ã‚¹ãƒˆã‚’é…ç½®

**åŸå‰‡**:
- âœ… `src/` ã®æ§‹é€ ã‚’åæ˜ 
- âœ… `conftest.py` ã«pytestå…±é€šè¨­å®š
- âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Šã‚’ç›®æ¨™

**ä¾‹**:

```python
# tests/test_services/test_user_service.py
import pytest
from unittest.mock import AsyncMock
from src.services.user_service import UserService
from src.models.user import User
from src.utils.exceptions import UserNotFoundError

@pytest.mark.asyncio
async def test_get_user_success():
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—æˆåŠŸã®ãƒ†ã‚¹ãƒˆ"""
    # Mock
    mock_repo = AsyncMock()
    mock_repo.find_by_id.return_value = User(
        id=1, name="Test User", email="test@example.com"
    )

    # Execute
    service = UserService(mock_repo)
    user = await service.get_user(1)

    # Assert
    assert user.id == 1
    assert user.name == "Test User"

@pytest.mark.asyncio
async def test_get_user_not_found():
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ãƒ†ã‚¹ãƒˆ"""
    # Mock
    mock_repo = AsyncMock()
    mock_repo.find_by_id.return_value = None

    # Execute & Assert
    service = UserService(mock_repo)
    with pytest.raises(UserNotFoundError):
        await service.get_user(999)
```

---

## âŒ Bad Example: æ§‹æˆãŒä¸é©åˆ‡

```
myproject/
â”œâ”€â”€ api.py            # âŒ ã™ã¹ã¦1ãƒ•ã‚¡ã‚¤ãƒ«ã«
â”œâ”€â”€ models.py         # âŒ å±¤åˆ¥è¨­è¨ˆãªã—
â”œâ”€â”€ utils.py
â””â”€â”€ test.py           # âŒ ãƒ†ã‚¹ãƒˆãŒ1ãƒ•ã‚¡ã‚¤ãƒ«
```

**å•é¡Œç‚¹**:
- å±¤åˆ¥è¨­è¨ˆãŒãªã„ â†’ ä¿å®ˆæ€§ãŒä½ã„
- ãƒ•ã‚¡ã‚¤ãƒ«ãŒè‚¥å¤§åŒ– â†’ å¯èª­æ€§ãŒä½ã„
- ãƒ†ã‚¹ãƒˆãŒä¸ååˆ†

---

## âœ… Good Example: æŠ€è¡“æ¨™æº–ã«æº–æ‹ 

```
myproject/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ services/      # âœ… ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯åˆ†é›¢
â”‚   â”œâ”€â”€ repositories/  # âœ… ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤åˆ†é›¢
â”‚   â””â”€â”€ utils/
â””â”€â”€ tests/
    â”œâ”€â”€ test_api/
    â”œâ”€â”€ test_services/  # âœ… ã‚µãƒ¼ãƒ“ã‚¹å±¤ã®ãƒ†ã‚¹ãƒˆ
    â””â”€â”€ test_repositories/
```

**æ”¹å–„ç‚¹**:
- âœ… å±¤åˆ¥è¨­è¨ˆ
- âœ… è²¬å‹™ãŒæ˜ç¢º
- âœ… ãƒ†ã‚¹ãƒˆãŒå®¹æ˜“

---

## ğŸ“¦ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†

### pyproject.tomlï¼ˆæ¨å¥¨ï¼‰ â­

```toml
[tool.poetry]
name = "myproject"
version = "0.1.0"
description = "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª¬æ˜"
authors = ["Your Name <you@example.com>"]

[tool.poetry.dependencies]
python = "^3.11"
fastapi = "^0.104.0"
pydantic = "^2.4.0"
sqlalchemy = "^2.0.0"

[tool.poetry.dev-dependencies]
pytest = "^7.4.0"
pytest-asyncio = "^0.21.0"
pytest-cov = "^4.1.0"

[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"
```

---

**ä½œæˆæ—¥**: 2025-10-19
**å¯¾è±¡ãƒ•ã‚§ãƒ¼ã‚º**: å®Ÿè£…
**é‡è¦åº¦**: â­â­â­ å¿…é ˆ
