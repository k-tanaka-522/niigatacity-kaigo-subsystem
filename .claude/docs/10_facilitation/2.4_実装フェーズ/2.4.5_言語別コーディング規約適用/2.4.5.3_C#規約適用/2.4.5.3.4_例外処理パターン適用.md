# 2.4.5.3.4 C#ä¾‹å¤–å‡¦ç†ãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨

## ç›®çš„

C# .NET Coreã§é©åˆ‡ãªä¾‹å¤–å‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

---

## ğŸ¯ ä¾‹å¤–å‡¦ç†ã®åŸå‰‡

### 1. ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚’ä½¿ç”¨ â­â­â­

**åŸå‰‡**:
- âœ… ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ã‚¨ãƒ©ãƒ¼ã¯ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–
- âœ… `Exception` ã‚’ç¶™æ‰¿
- âœ… éšå±¤æ§‹é€ ã‚’æŒãŸã›ã‚‹

**ä¾‹**:

```csharp
// Domain/Exceptions/AppException.cs
namespace MyApp.Domain.Exceptions
{
    public class AppException : Exception
    {
        public AppException(string message) : base(message) { }
    }

    public class UserNotFoundException : AppException
    {
        public int UserId { get; }

        public UserNotFoundException(int userId)
            : base($"User {userId} not found")
        {
            UserId = userId;
        }
    }

    public class InvalidEmailException : AppException
    {
        public InvalidEmailException(string email)
            : base($"Invalid email: {email}")
        {
        }
    }
}
```

---

### 2. try-catch ã‚’é©åˆ‡ã«ä½¿ç”¨ â­â­â­

**åŸå‰‡**:
- âœ… å…·ä½“çš„ãªä¾‹å¤–ã‚’ã‚­ãƒ£ãƒƒãƒ
- âœ… `catch (Exception)` ã¯æœ€å¾Œã®æ‰‹æ®µ
- âœ… ãƒ­ã‚°ã‚’å‡ºåŠ›
- âœ… å†ã‚¹ãƒ­ãƒ¼ï¼ˆre-throwï¼‰ã‚’æ¤œè¨

**ä¾‹**:

```csharp
using MyApp.Domain.Exceptions;
using Microsoft.Extensions.Logging;

public class UserService : IUserService
{
    private readonly IUserRepository _userRepository;
    private readonly ILogger<UserService> _logger;

    public UserService(IUserRepository userRepository, ILogger<UserService> logger)
    {
        _userRepository = userRepository;
        _logger = logger;
    }

    public async Task<UserDto> GetUserAsync(int id)
    {
        try
        {
            var user = await _userRepository.GetByIdAsync(id);
            if (user == null)
            {
                _logger.LogWarning("User {UserId} not found", id);
                throw new UserNotFoundException(id);
            }
            return MapToDto(user);
        }
        catch (UserNotFoundException)
        {
            throw;  // âœ… å†ã‚¹ãƒ­ãƒ¼
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to get user {UserId}", id);
            throw;
        }
    }
}
```

---

### 3. ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â­â­â­

**åŸå‰‡**:
- âœ… ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚¨ãƒ©ãƒ¼å‡¦ç†
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é©åˆ‡ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™

**ä¾‹**:

```csharp
// Middleware/ErrorHandlingMiddleware.cs
using MyApp.Domain.Exceptions;
using System.Net;
using System.Text.Json;

public class ErrorHandlingMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<ErrorHandlingMiddleware> _logger;

    public ErrorHandlingMiddleware(RequestDelegate next, ILogger<ErrorHandlingMiddleware> logger)
    {
        _next = next;
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        try
        {
            await _next(context);
        }
        catch (UserNotFoundException ex)
        {
            _logger.LogWarning(ex, "User not found");
            await HandleExceptionAsync(context, ex, HttpStatusCode.NotFound);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Unhandled exception");
            await HandleExceptionAsync(context, ex, HttpStatusCode.InternalServerError);
        }
    }

    private static async Task HandleExceptionAsync(HttpContext context, Exception exception, HttpStatusCode statusCode)
    {
        context.Response.ContentType = "application/json";
        context.Response.StatusCode = (int)statusCode;

        var response = new
        {
            error = exception.Message,
            statusCode = (int)statusCode
        };

        await context.Response.WriteAsync(JsonSerializer.Serialize(response));
    }
}

// Program.cs
app.UseMiddleware<ErrorHandlingMiddleware>();
```

---

## âŒ Bad Example: ä¾‹å¤–å‡¦ç†ãŒä¸é©åˆ‡

```csharp
// âŒ try-catchãªã—
public async Task<UserDto> GetUser(int id)
{
    var user = await _userRepository.GetByIdAsync(id);  // âŒ ã‚¨ãƒ©ãƒ¼å‡¦ç†ãªã—
    return MapToDto(user);
}

// âŒ æ±ç”¨çš„ãªException
if (user == null)
{
    throw new Exception("Error");  // âŒ ä½•ã®ã‚¨ãƒ©ãƒ¼ã‹ä¸æ˜
}

// âŒ ä¾‹å¤–ã‚’æ¡ã‚Šã¤ã¶ã™
try
{
    var user = await _userRepository.GetByIdAsync(id);
}
catch (Exception)
{
    // âŒ ä½•ã‚‚ã—ãªã„
}
```

**å•é¡Œç‚¹**:
- ã‚¨ãƒ©ãƒ¼å‡¦ç†ãŒãªã„
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒä¸æ˜ç­
- ã‚¨ãƒ©ãƒ¼ãŒæ¡ã‚Šã¤ã¶ã•ã‚Œã‚‹

---

## âœ… Good Example: é©åˆ‡ãªä¾‹å¤–å‡¦ç†

```csharp
public async Task<UserDto> GetUserAsync(int id)
{
    try
    {
        var user = await _userRepository.GetByIdAsync(id);
        if (user == null)
        {
            _logger.LogWarning("User {UserId} not found", id);
            throw new UserNotFoundException(id);
        }
        return MapToDto(user);
    }
    catch (UserNotFoundException)
    {
        throw;
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Failed to get user {UserId}", id);
        throw;
    }
}
```

**æ”¹å–„ç‚¹**:
- âœ… ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–
- âœ… ãƒ­ã‚°å‡ºåŠ›
- âœ… try-catch

---

**ä½œæˆæ—¥**: 2025-10-19
**å¯¾è±¡ãƒ•ã‚§ãƒ¼ã‚º**: å®Ÿè£…
**é‡è¦åº¦**: â­â­â­ å¿…é ˆ
