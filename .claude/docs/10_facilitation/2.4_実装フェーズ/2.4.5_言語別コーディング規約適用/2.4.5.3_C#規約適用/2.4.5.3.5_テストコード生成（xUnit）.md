# 2.4.5.3.5 C#ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆxUnitï¼‰

## ç›®çš„

`.claude/docs/40_standards/43_csharp.md` ã«æº–æ‹ ã—ãŸxUnitãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

---

## ğŸ§ª xUnitã®åŸºæœ¬

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
dotnet add package xunit
dotnet add package xunit.runner.visualstudio
dotnet add package Moq
dotnet add package FluentAssertions
```

### ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

```
tests/
â””â”€â”€ MyApp.UnitTests/
    â”œâ”€â”€ Services/
    â”‚   â””â”€â”€ UserServiceTests.cs
    â””â”€â”€ Controllers/
        â””â”€â”€ UserControllerTests.cs
```

### å®Ÿè¡Œ

```bash
dotnet test
dotnet test /p:CollectCoverage=true
```

---

## âœ… ãƒ†ã‚¹ãƒˆä½œæˆã®åŸå‰‡

### 1. AAA (Arrange-Act-Assert) ãƒ‘ã‚¿ãƒ¼ãƒ³ â­â­â­

**ä¾‹**:

```csharp
using Xunit;
using Moq;
using MyApp.Application.Services;
using MyApp.Domain.Interfaces;
using MyApp.Domain.Entities;

public class UserServiceTests
{
    [Fact]
    public async Task GetUserAsync_WhenUserExists_ReturnsUser()
    {
        // Arrange
        var mockRepo = new Mock<IUserRepository>();
        mockRepo.Setup(repo => repo.GetByIdAsync(1))
            .ReturnsAsync(new User { Id = 1, Name = "Test User", Email = "test@example.com" });

        var service = new UserService(mockRepo.Object);

        // Act
        var result = await service.GetUserAsync(1);

        // Assert
        Assert.NotNull(result);
        Assert.Equal(1, result.Id);
        Assert.Equal("Test User", result.Name);
    }
}
```

---

### 2. Moqã«ã‚ˆã‚‹ãƒ¢ãƒƒã‚­ãƒ³ã‚° â­â­â­

**ä¾‹**:

```csharp
using Moq;

public class UserServiceTests
{
    private readonly Mock<IUserRepository> _mockUserRepository;
    private readonly UserService _userService;

    public UserServiceTests()
    {
        _mockUserRepository = new Mock<IUserRepository>();
        _userService = new UserService(_mockUserRepository.Object);
    }

    [Fact]
    public async Task GetUserAsync_WhenUserExists_ReturnsUser()
    {
        // Arrange
        var expectedUser = new User { Id = 1, Name = "Test", Email = "test@example.com" };
        _mockUserRepository.Setup(x => x.GetByIdAsync(1)).ReturnsAsync(expectedUser);

        // Act
        var result = await _userService.GetUserAsync(1);

        // Assert
        Assert.NotNull(result);
        _mockUserRepository.Verify(x => x.GetByIdAsync(1), Times.Once);
    }
}
```

---

### 3. FluentAssertions â­â­

**ä¾‹**:

```csharp
using FluentAssertions;

[Fact]
public async Task GetUserAsync_WhenUserExists_ReturnsUser()
{
    // Arrange
    var expectedUser = new User { Id = 1, Name = "Test", Email = "test@example.com" };
    _mockUserRepository.Setup(x => x.GetByIdAsync(1)).ReturnsAsync(expectedUser);

    // Act
    var result = await _userService.GetUserAsync(1);

    // Assert
    result.Should().NotBeNull();
    result.Id.Should().Be(1);
    result.Name.Should().Be("Test");
}
```

---

### 4. Theoryï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ãƒ†ã‚¹ãƒˆï¼‰â­â­

**ä¾‹**:

```csharp
[Theory]
[InlineData("test@example.com", true)]
[InlineData("user+tag@example.co.jp", true)]
[InlineData("invalid@", false)]
[InlineData("@example.com", false)]
public void ValidateEmail_ShouldReturnExpectedResult(string email, bool expected)
{
    // Act
    var result = EmailValidator.Validate(email);

    // Assert
    result.Should().Be(expected);
}
```

---

## ğŸ“‹ ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: æ­£å¸¸ç³»ãƒ†ã‚¹ãƒˆ

```csharp
public class UserServiceTests
{
    private readonly Mock<IUserRepository> _mockRepository;
    private readonly UserService _service;

    public UserServiceTests()
    {
        _mockRepository = new Mock<IUserRepository>();
        _service = new UserService(_mockRepository.Object);
    }

    [Fact]
    public async Task GetUserAsync_WhenUserExists_ReturnsUserDto()
    {
        // Arrange
        var user = new User { Id = 1, Name = "John Doe", Email = "john@example.com" };
        _mockRepository.Setup(x => x.GetByIdAsync(1)).ReturnsAsync(user);

        // Act
        var result = await _service.GetUserAsync(1);

        // Assert
        result.Should().NotBeNull();
        result!.Id.Should().Be(1);
        result.Name.Should().Be("John Doe");
    }
}
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆï¼ˆä¾‹å¤–ï¼‰

```csharp
[Fact]
public async Task GetUserAsync_WhenUserNotFound_ThrowsUserNotFoundException()
{
    // Arrange
    _mockRepository.Setup(x => x.GetByIdAsync(999)).ReturnsAsync((User?)null);

    // Act
    Func<Task> act = async () => await _service.GetUserAsync(999);

    // Assert
    await act.Should().ThrowAsync<UserNotFoundException>();
}
```

---

## âŒ Bad Example: ãƒ†ã‚¹ãƒˆãŒä¸é©åˆ‡

```csharp
// âŒ AAAãƒ‘ã‚¿ãƒ¼ãƒ³ãªã—
[Fact]
public async Task TestGetUser()
{
    var result = await _service.GetUserAsync(1);
    Assert.NotNull(result);
}

// âŒ ãƒ¢ãƒƒã‚¯ãªã—
[Fact]
public async Task TestGetUser()
{
    var service = new UserService(new UserRepository());  // âŒ å®ŸDB
    var result = await service.GetUserAsync(1);
    Assert.NotNull(result);
}
```

**å•é¡Œç‚¹**:
- å¯èª­æ€§ãŒä½ã„
- ãƒ†ã‚¹ãƒˆãŒé…ã„

---

## âœ… Good Example: é©åˆ‡ãªãƒ†ã‚¹ãƒˆ

```csharp
public class UserServiceTests
{
    private readonly Mock<IUserRepository> _mockRepository;
    private readonly UserService _service;

    public UserServiceTests()
    {
        _mockRepository = new Mock<IUserRepository>();
        _service = new UserService(_mockRepository.Object);
    }

    [Fact]
    public async Task GetUserAsync_WhenUserExists_ReturnsUserDto()
    {
        // Arrange
        var user = new User { Id = 1, Name = "Test", Email = "test@example.com" };
        _mockRepository.Setup(x => x.GetByIdAsync(1)).ReturnsAsync(user);

        // Act
        var result = await _service.GetUserAsync(1);

        // Assert
        result.Should().NotBeNull();
        result!.Id.Should().Be(1);
        _mockRepository.Verify(x => x.GetByIdAsync(1), Times.Once);
    }
}
```

**æ”¹å–„ç‚¹**:
- âœ… AAAãƒ‘ã‚¿ãƒ¼ãƒ³
- âœ… ãƒ¢ãƒƒã‚¯ä½¿ç”¨
- âœ… Verify ã§å‘¼ã³å‡ºã—æ¤œè¨¼

---

**ä½œæˆæ—¥**: 2025-10-19
**å¯¾è±¡ãƒ•ã‚§ãƒ¼ã‚º**: å®Ÿè£…
**é‡è¦åº¦**: â­â­â­ å¿…é ˆ
