# 2.5.6.2 k6è² è·ãƒ†ã‚¹ãƒˆ

## ç›®çš„

k6ã‚’ä½¿ã£ã¦APIã®è² è·ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã—ã¾ã™ã€‚

---

## ğŸš€ k6ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# macOS
brew install k6

# Windows
choco install k6

# Linux
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update
sudo apt-get install k6
```

---

## ğŸ“‹ k6ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

### 1. ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ

```javascript
// tests/load/simple-load.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export let options = {
  vus: 100,        // 100 virtual users
  duration: '5m',  // 5åˆ†é–“å®Ÿè¡Œ
};

export default function () {
  const res = http.get('https://api.example.com/users');

  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
  });

  sleep(1);  // 1ç§’å¾…æ©Ÿ
}
```

å®Ÿè¡Œ:
```bash
k6 run tests/load/simple-load.js
```

---

### 2. ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ™ãƒ¼ã‚¹ã®ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ

```javascript
// tests/load/staged-load.js
import http from 'k6/http';
import { check } from 'k6';

export let options = {
  stages: [
    { duration: '1m', target: 50 },   // Ramp-up: 0â†’50 users (1åˆ†)
    { duration: '3m', target: 50 },   // Stay: 50 users (3åˆ†)
    { duration: '1m', target: 100 },  // Ramp-up: 50â†’100 users (1åˆ†)
    { duration: '3m', target: 100 },  // Stay: 100 users (3åˆ†)
    { duration: '1m', target: 0 },    // Ramp-down: 100â†’0 users (1åˆ†)
  ],
  thresholds: {
    http_req_duration: ['p(95)<500', 'p(99)<1000'],
    http_req_failed: ['rate<0.01'],
  },
};

export default function () {
  const res = http.get('https://api.example.com/users');
  check(res, { 'status is 200': (r) => r.status === 200 });
}
```

---

### 3. ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆ

```javascript
// tests/load/stress-test.js
import http from 'k6/http';

export let options = {
  stages: [
    { duration: '2m', target: 100 },   // é€šå¸¸è² è·
    { duration: '5m', target: 100 },
    { duration: '2m', target: 200 },   // 2å€ã®è² è·
    { duration: '5m', target: 200 },
    { duration: '2m', target: 300 },   // 3å€ã®è² è·
    { duration: '5m', target: 300 },
    { duration: '2m', target: 400 },   // 4å€ã®è² è·ï¼ˆç ´ç¶»ãƒã‚¤ãƒ³ãƒˆæ¢ç´¢ï¼‰
    { duration: '5m', target: 400 },
    { duration: '5m', target: 0 },     // å›å¾©ç¢ºèª
  ],
};

export default function () {
  http.get('https://api.example.com/users');
}
```

---

### 4. ã‚¹ãƒ‘ã‚¤ã‚¯ãƒ†ã‚¹ãƒˆ

```javascript
// tests/load/spike-test.js
import http from 'k6/http';

export let options = {
  stages: [
    { duration: '10s', target: 1000 },  // æ€¥æ¿€ãªå¢—åŠ 
    { duration: '1m', target: 1000 },   // ç¶­æŒ
    { duration: '10s', target: 0 },     // æ€¥æ¿€ãªæ¸›å°‘
    { duration: '1m', target: 0 },      // ä¼‘æ­¢
    { duration: '10s', target: 1000 },  // å†åº¦ã‚¹ãƒ‘ã‚¤ã‚¯
    { duration: '1m', target: 1000 },
    { duration: '10s', target: 0 },
  ],
};

export default function () {
  http.get('https://api.example.com/users');
}
```

---

### 5. è¤‡æ•°ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ

```javascript
// tests/load/multi-endpoint.js
import http from 'k6/http';
import { check, group } from 'k6';

export let options = {
  vus: 100,
  duration: '5m',
};

export default function () {
  group('User APIs', function () {
    // GET /users
    let res1 = http.get('https://api.example.com/users');
    check(res1, { 'GET /users status 200': (r) => r.status === 200 });

    // GET /users/:id
    let res2 = http.get('https://api.example.com/users/123');
    check(res2, { 'GET /users/:id status 200': (r) => r.status === 200 });

    // POST /users
    let payload = JSON.stringify({ name: 'Test User', email: 'test@example.com' });
    let params = { headers: { 'Content-Type': 'application/json' } };
    let res3 = http.post('https://api.example.com/users', payload, params);
    check(res3, { 'POST /users status 201': (r) => r.status === 201 });
  });
}
```

---

### 6. èªè¨¼ä»˜ãAPIãƒ†ã‚¹ãƒˆ

```javascript
// tests/load/auth-test.js
import http from 'k6/http';
import { check } from 'k6';

export let options = {
  vus: 50,
  duration: '3m',
};

export function setup() {
  // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—: ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
  const loginRes = http.post('https://api.example.com/auth/login', {
    email: 'test@example.com',
    password: 'password123',
  });
  return { token: loginRes.json('token') };
}

export default function (data) {
  const params = {
    headers: {
      'Authorization': `Bearer ${data.token}`,
      'Content-Type': 'application/json',
    },
  };

  const res = http.get('https://api.example.com/users/me', params);
  check(res, { 'authenticated request OK': (r) => r.status === 200 });
}
```

---

## ğŸ“Š çµæœã®ç¢ºèª

### ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›

```bash
k6 run tests/load/simple-load.js

# å‡ºåŠ›ä¾‹:
     data_received..................: 8.2 MB  136 kB/s
     data_sent......................: 1.1 MB  18 kB/s
     http_req_blocked...............: avg=1.2ms    min=0s       med=0s      max=234ms
     http_req_duration..............: avg=145.3ms  min=102.3ms  med=142ms   max=987ms
     http_req_failed................: 0.00%   âœ“ 0        âœ— 6000
     http_reqs......................: 6000    100/s
     vus............................: 100     min=100    max=100
```

### JSONå‡ºåŠ›

```bash
k6 run --out json=results.json tests/load/simple-load.js
```

### HTML ãƒ¬ãƒãƒ¼ãƒˆ

```bash
# k6-reporter ã‚’ä½¿ç”¨
npm install -g k6-reporter
k6 run --out json=results.json tests/load/simple-load.js
k6-reporter results.json
```

---

## ğŸ¯ é–¾å€¤ã®è¨­å®š

```javascript
export let options = {
  thresholds: {
    // 95%ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ500msä»¥å†…
    http_req_duration: ['p(95)<500'],

    // 99%ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ1ç§’ä»¥å†…
    'http_req_duration{expected_response:true}': ['p(99)<1000'],

    // ã‚¨ãƒ©ãƒ¼ç‡1%æœªæº€
    http_req_failed: ['rate<0.01'],

    // 1ç§’ã‚ãŸã‚Š100ãƒªã‚¯ã‚¨ã‚¹ãƒˆä»¥ä¸Š
    http_reqs: ['rate>100'],
  },
};
```

---

**ä½œæˆæ—¥**: 2025-10-19
**é‡è¦åº¦**: â­â­â­
