# 2.5.6.5 ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ

## ç›®çš„

ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆèƒ½åŠ›ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚

---

## ğŸ“ˆ ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã®ç¨®é¡

### 1. å‚ç›´ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼ˆScale Upï¼‰

**å†…å®¹**: ã‚µãƒ¼ãƒãƒ¼ã®ã‚¹ãƒšãƒƒã‚¯ã‚¢ãƒƒãƒ—

```
t3.medium (2vCPU, 4GB) â†’ t3.large (2vCPU, 8GB) â†’ t3.xlarge (4vCPU, 16GB)
```

**æ¤œè¨¼é …ç›®**:
- âœ… CPU/ãƒ¡ãƒ¢ãƒªå¢—åŠ ã«å¿œã˜ãŸã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆå‘ä¸Š
- âœ… ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨åŠ¹ç‡

---

### 2. æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼ˆScale Outï¼‰

**å†…å®¹**: ã‚µãƒ¼ãƒãƒ¼å°æ•°ã®å¢—åŠ 

```
1å° â†’ 2å° â†’ 4å° â†’ 8å°
```

**æ¤œè¨¼é …ç›®**:
- âœ… ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°å¢—åŠ ã«å¿œã˜ãŸã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆå‘ä¸Šï¼ˆç·šå½¢æ€§ï¼‰
- âœ… ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã®å‹•ä½œ
- âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹æ€§ï¼‰

---

## ğŸ§ª æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ

### ã‚·ãƒŠãƒªã‚ª

```javascript
// k6 ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆãƒ†ã‚¹ãƒˆ
import http from 'k6/http';
import { check } from 'k6';

export let options = {
  scenarios: {
    scale_test: {
      executor: 'ramping-vus',
      stages: [
        { duration: '5m', target: 1000 },   // 1,000 users
        { duration: '10m', target: 1000 },  // ç¶­æŒ
        { duration: '5m', target: 2000 },   // 2,000 users
        { duration: '10m', target: 2000 },  // ç¶­æŒ
        { duration: '5m', target: 0 },
      ],
    },
  },
  thresholds: {
    http_req_duration: ['p(95)<500'],
    http_req_failed: ['rate<0.01'],
  },
};

export default function () {
  const res = http.get('https://api.example.com/users');
  check(res, { 'status is 200': (r) => r.status === 200 });
}
```

### æœŸå¾…ã•ã‚Œã‚‹çµæœ

| ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•° | ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ | ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ï¼ˆp95ï¼‰ |
|----------------|--------------|-------------------------|
| 1å°            | 500 req/s    | 200ms                   |
| 2å°            | 1,000 req/s  | 200msï¼ˆâœ… ç·šå½¢ï¼‰        |
| 4å°            | 2,000 req/s  | 200msï¼ˆâœ… ç·šå½¢ï¼‰        |
| 8å°            | 4,000 req/s  | 200msï¼ˆâœ… ç·šå½¢ï¼‰        |

**ç†æƒ³**: ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°ã«æ¯”ä¾‹ã—ã¦ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆãŒå‘ä¸Š

---

## âš™ï¸ ã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ

### AWS ECS Auto Scaling

```yaml
# ecs-task-definition.yml
AutoScalingTarget:
  Type: AWS::ApplicationAutoScaling::ScalableTarget
  Properties:
    MaxCapacity: 10
    MinCapacity: 2
    ResourceId: !Sub service/${ECSCluster}/myapp-service
    ScalableDimension: ecs:service:DesiredCount
    ServiceNamespace: ecs

AutoScalingPolicy:
  Type: AWS::ApplicationAutoScaling::ScalingPolicy
  Properties:
    PolicyName: cpu-scaling-policy
    PolicyType: TargetTrackingScaling
    TargetTrackingScalingPolicyConfiguration:
      TargetValue: 70.0  # CPU 70%ã§ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ
      PredefinedMetricSpecification:
        PredefinedMetricType: ECSServiceAverageCPUUtilization
```

### ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

1. **è² è·ãªã—**: ã‚¿ã‚¹ã‚¯æ•° 2
2. **è² è·å¢—åŠ **: CPU 70%è¶…é â†’ ã‚¿ã‚¹ã‚¯æ•°å¢—åŠ ï¼ˆ2 â†’ 4 â†’ 6ï¼‰
3. **è² è·ç¶­æŒ**: ã‚¿ã‚¹ã‚¯æ•°ç¶­æŒ
4. **è² è·æ¸›å°‘**: CPU 70%æœªæº€ â†’ ã‚¿ã‚¹ã‚¯æ•°æ¸›å°‘ï¼ˆ6 â†’ 4 â†’ 2ï¼‰

### æ¤œè¨¼é …ç›®

```javascript
// k6: ã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
export let options = {
  stages: [
    { duration: '5m', target: 100 },   // ä½è² è·ï¼ˆã‚¿ã‚¹ã‚¯2å°ï¼‰
    { duration: '2m', target: 500 },   // æ€¥å¢—ï¼ˆã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆé–‹å§‹ï¼‰
    { duration: '10m', target: 500 },  // ç¶­æŒï¼ˆã‚¿ã‚¹ã‚¯å¢—åŠ å®Œäº†ï¼‰
    { duration: '2m', target: 100 },   // æ€¥æ¸›ï¼ˆã‚¹ã‚±ãƒ¼ãƒ«ã‚¤ãƒ³é–‹å§‹ï¼‰
    { duration: '5m', target: 100 },   // ä½è² è·ï¼ˆã‚¿ã‚¹ã‚¯2å°ã«æˆ»ã‚‹ï¼‰
  ],
};
```

**ç¢ºèªäº‹é …**:
- âœ… ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆæ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã‹
- âœ… ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆå®Œäº†ã¾ã§ã®æ™‚é–“ï¼ˆç›®æ¨™: 3åˆ†ä»¥å†…ï¼‰
- âœ… ã‚¹ã‚±ãƒ¼ãƒ«ã‚¤ãƒ³æ™‚ã«æ—¢å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä¸­æ–­ã•ã‚Œãªã„ã‹

---

## ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

### ãƒªãƒ¼ãƒ‰ãƒ¬ãƒ—ãƒªã‚«ã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ

```
Primary DB (Write) â†’ Read Replica 1 (Read)
                   â†’ Read Replica 2 (Read)
                   â†’ Read Replica 3 (Read)
```

#### ãƒ†ã‚¹ãƒˆ

```python
# Python: ãƒªãƒ¼ãƒ‰ãƒ¬ãƒ—ãƒªã‚«åˆ†æ•£ãƒ†ã‚¹ãƒˆ
from sqlalchemy import create_engine
from random import choice

primary_engine = create_engine('postgresql://primary:5432/db')
replica_engines = [
    create_engine('postgresql://replica1:5432/db'),
    create_engine('postgresql://replica2:5432/db'),
    create_engine('postgresql://replica3:5432/db'),
]

def read_query():
    # ãƒªãƒ¼ãƒ‰ãƒ¬ãƒ—ãƒªã‚«ã‚’ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
    engine = choice(replica_engines)
    with engine.connect() as conn:
        result = conn.execute("SELECT * FROM users LIMIT 100")
        return result.fetchall()

def write_query(user_data):
    # ãƒ—ãƒ©ã‚¤ãƒãƒªDBã«æ›¸ãè¾¼ã¿
    with primary_engine.connect() as conn:
        conn.execute("INSERT INTO users (name, email) VALUES (:name, :email)", user_data)
```

**æ¤œè¨¼é …ç›®**:
- âœ… ãƒªãƒ¼ãƒ‰ãƒ¬ãƒ—ãƒªã‚«æ•°å¢—åŠ ã«å¿œã˜ãŸèª­ã¿å–ã‚Šã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆå‘ä¸Š
- âœ… ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é…å»¶ï¼ˆç›®æ¨™: 1ç§’ä»¥å†…ï¼‰

---

## ğŸ“Š ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£æŒ‡æ¨™

### ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—æ¯”

```
ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—æ¯” = 1å°ã®ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ Ã— ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•° / Nå°ã®ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ

ç†æƒ³: 1.0ï¼ˆå®Œå…¨ã«ç·šå½¢ï¼‰
ç¾å®Ÿ: 0.8-0.9ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚ã‚Šï¼‰
```

### ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£åŠ¹ç‡

```
åŠ¹ç‡ = (Nå°ã®ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ / 1å°ã®ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ) / N Ã— 100%

ç†æƒ³: 100%
ç¾å®Ÿ: 80-90%
```

---

## ğŸ¯ ç›®æ¨™å€¤

| é …ç›® | ç›®æ¨™ |
|------|------|
| ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆåŠ¹ç‡ | 80%ä»¥ä¸Š |
| ã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒ«ç™ºå‹•æ™‚é–“ | 3åˆ†ä»¥å†… |
| ã‚¹ã‚±ãƒ¼ãƒ«ã‚¤ãƒ³æ™‚ã®ã‚¨ãƒ©ãƒ¼ç‡ | 0% |
| ãƒªãƒ¼ãƒ‰ãƒ¬ãƒ—ãƒªã‚«ã®ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é…å»¶ | 1ç§’ä»¥å†… |

---

**ä½œæˆæ—¥**: 2025-10-19
**é‡è¦åº¦**: â­â­â­
