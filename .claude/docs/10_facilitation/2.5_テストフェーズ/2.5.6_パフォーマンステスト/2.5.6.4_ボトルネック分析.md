# 2.5.6.4 ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ†æ

## ç›®çš„

ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã‚’ç‰¹å®šã—ã€æ”¹å–„ç­–ã‚’å®Ÿæ–½ã—ã¾ã™ã€‚

---

## ğŸ” ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ†ææ‰‹æ³•

### 1. APMï¼ˆApplication Performance Monitoringï¼‰

#### Datadog APM

```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    image: myapp:latest
    environment:
      DD_AGENT_HOST: datadog-agent
      DD_TRACE_ENABLED: true
      DD_SERVICE: myapp
      DD_ENV: production
```

**ç¢ºèªé …ç›®**:
- âœ… ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã”ã¨ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ 
- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã®å®Ÿè¡Œæ™‚é–“
- âœ… å¤–éƒ¨APIå‘¼ã³å‡ºã—ã®æ™‚é–“
- âœ… CPUãƒ»ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡

---

### 2. ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°

#### Python (py-spy)

```bash
# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install py-spy

# ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°å®Ÿè¡Œï¼ˆ60ç§’é–“ï¼‰
py-spy record -o profile.svg --pid <PID> --duration 60

# ãƒ•ãƒ¬ãƒ¼ãƒ ã‚°ãƒ©ãƒ•ç”Ÿæˆ
py-spy record -o profile.svg -- python myapp.py
```

#### Node.js (clinic.js)

```bash
# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install -g clinic

# ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°å®Ÿè¡Œ
clinic doctor -- node server.js

# ãƒ•ãƒ¬ãƒ¼ãƒ ã‚°ãƒ©ãƒ•
clinic flame -- node server.js
```

#### Go (pprof)

```go
import (
    _ "net/http/pprof"
    "net/http"
)

func main() {
    go func() {
        log.Println(http.ListenAndServe("localhost:6060", nil))
    }()

    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰
}
```

```bash
# CPUãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—
go tool pprof http://localhost:6060/debug/pprof/profile?seconds=30

# ãƒ¡ãƒ¢ãƒªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«
go tool pprof http://localhost:6060/debug/pprof/heap
```

---

### 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ†æ

#### æ¥ç¶šæ•°ã®ç›£è¦–

```sql
-- PostgreSQL: ç¾åœ¨ã®æ¥ç¶šæ•°
SELECT count(*) FROM pg_stat_activity;

-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¯ã‚¨ãƒª
SELECT pid, usename, state, query, now() - query_start AS duration
FROM pg_stat_activity
WHERE state != 'idle'
ORDER BY duration DESC;
```

#### ãƒ­ãƒƒã‚¯å¾…ã¡ã®ç¢ºèª

```sql
-- PostgreSQL: ãƒ­ãƒƒã‚¯å¾…ã¡ã‚¯ã‚¨ãƒª
SELECT
  blocked.pid AS blocked_pid,
  blocked.query AS blocked_query,
  blocking.pid AS blocking_pid,
  blocking.query AS blocking_query
FROM pg_stat_activity blocked
JOIN pg_locks blocked_lock ON blocked.pid = blocked_lock.pid
JOIN pg_locks blocking_lock ON blocked_lock.locktype = blocking_lock.locktype
  AND blocked_lock.relation = blocking_lock.relation
JOIN pg_stat_activity blocking ON blocking.pid = blocking_lock.pid
WHERE NOT blocked_lock.granted
  AND blocking_lock.granted;
```

---

### 4. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒœãƒˆãƒ«ãƒãƒƒã‚¯

#### ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼æ¸¬å®š

```bash
# API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ 
curl -w "@curl-format.txt" -o /dev/null -s https://api.example.com/users

# curl-format.txt
time_namelookup:  %{time_namelookup}\n
time_connect:     %{time_connect}\n
time_appconnect:  %{time_appconnect}\n
time_pretransfer: %{time_pretransfer}\n
time_starttransfer: %{time_starttransfer}\n
time_total:       %{time_total}\n
```

#### CDNãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ç¢ºèª

```bash
# ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ç¢ºèª
curl -I https://example.com/static/app.js

# å‡ºåŠ›ä¾‹:
HTTP/2 200
cache-control: public, max-age=31536000
x-cache: HIT from cloudfront
```

---

### 5. ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨ç‡ã®ç›£è¦–

#### CPUä½¿ç”¨ç‡

```bash
# ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
top -o %CPU

# ãƒ—ãƒ­ã‚»ã‚¹ã”ã¨ã®CPUä½¿ç”¨ç‡
ps aux | sort -nrk 3 | head -10
```

#### ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡

```bash
# ãƒ¡ãƒ¢ãƒªçŠ¶æ³ç¢ºèª
free -h

# ãƒ—ãƒ­ã‚»ã‚¹ã”ã¨ã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡
ps aux | sort -nrk 4 | head -10
```

#### ãƒ‡ã‚£ã‚¹ã‚¯I/O

```bash
# I/Oçµ±è¨ˆ
iostat -x 1

# ãƒ—ãƒ­ã‚»ã‚¹ã”ã¨ã®I/O
iotop
```

---

## ğŸ“Š ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ†æãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    A[ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ] --> B{ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ç›®æ¨™é”æˆ?}
    B -->|No| C[APMã§ãƒˆãƒ¬ãƒ¼ã‚¹ç¢ºèª]
    B -->|Yes| Z[å®Œäº†]

    C --> D{ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã¯?}

    D -->|APIå‡¦ç†| E[ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°å®Ÿè¡Œ]
    E --> F[é…ã„é–¢æ•°ã‚’ç‰¹å®š]
    F --> G[ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ æ”¹å–„/ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¿½åŠ ]

    D -->|DB| H[ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªãƒ­ã‚°ç¢ºèª]
    H --> I[EXPLAIN ANALYZE]
    I --> J[ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ /ã‚¯ã‚¨ãƒªæœ€é©åŒ–]

    D -->|å¤–éƒ¨API| K[å¤–éƒ¨APIå‘¼ã³å‡ºã—æ™‚é–“æ¸¬å®š]
    K --> L[ä¸¦åˆ—åŒ–/ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¿½åŠ ]

    D -->|ã‚¤ãƒ³ãƒ•ãƒ©| M[CPU/ãƒ¡ãƒ¢ãƒª/ãƒ‡ã‚£ã‚¹ã‚¯I/Oç¢ºèª]
    M --> N[ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—/ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ]

    G --> A
    J --> A
    L --> A
    N --> A
```

---

## ğŸ¯ æ”¹å–„ä¾‹

### ä¾‹1: DBã‚¯ã‚¨ãƒªãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯

**å•é¡Œ**:
```
APMã§ç¢ºèª â†’ GET /api/users ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ : 800ms
å†…è¨³: DBã‚¯ã‚¨ãƒª 750msã€ãã®ä»– 50ms
```

**åŸå› **:
```sql
EXPLAIN ANALYZE SELECT * FROM users WHERE email LIKE '%@example.com';
-- Seq Scanï¼ˆå…¨è¡¨ã‚¹ã‚­ãƒ£ãƒ³ï¼‰: 750ms
```

**æ”¹å–„**:
```sql
-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
CREATE INDEX idx_users_email ON users(email);

-- ã¾ãŸã¯ã€ã‚¯ã‚¨ãƒªå¤‰æ›´
SELECT * FROM users WHERE email = 'specific@example.com';  -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åˆ©ç”¨å¯èƒ½
```

**çµæœ**: 800ms â†’ 50ms

---

### ä¾‹2: å¤–éƒ¨APIå‘¼ã³å‡ºã—ãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯

**å•é¡Œ**:
```
APMã§ç¢ºèª â†’ GET /api/weather ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ : 1,200ms
å†…è¨³: å¤–éƒ¨APIå‘¼ã³å‡ºã— 1,150msã€ãã®ä»– 50ms
```

**æ”¹å–„**:
```python
# âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¿½åŠ ï¼ˆRedisï¼‰
from redis import Redis
import json

redis_client = Redis()

async def get_weather(city: str):
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª
    cached = redis_client.get(f"weather:{city}")
    if cached:
        return json.loads(cached)

    # å¤–éƒ¨APIå‘¼ã³å‡ºã—
    data = await external_weather_api.get(city)

    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ï¼ˆTTL: 10åˆ†ï¼‰
    redis_client.setex(f"weather:{city}", 600, json.dumps(data))

    return data
```

**çµæœ**: 1,200ms â†’ 50msï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆæ™‚ï¼‰

---

### ä¾‹3: N+1å•é¡Œ

**å•é¡Œ**:
```
GET /api/users â†’ 1,000äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨æ³¨æ–‡æƒ…å ±ã‚’å–å¾—
å®Ÿè¡Œæ™‚é–“: 5,000ms
ã‚¯ã‚¨ãƒªæ•°: 1,001å›ï¼ˆ1 + 1,000ï¼‰
```

**æ”¹å–„**:
```python
# âŒ Before
users = session.query(User).all()
for user in users:
    orders = user.orders  # 1,000å›ã®ã‚¯ã‚¨ãƒª

# âœ… After: Eager Loading
users = session.query(User).options(joinedload(User.orders)).all()
for user in users:
    orders = user.orders  # è¿½åŠ ã‚¯ã‚¨ãƒªãªã—
```

**çµæœ**: 5,000ms â†’ 200ms

---

**ä½œæˆæ—¥**: 2025-10-19
**é‡è¦åº¦**: â­â­â­
