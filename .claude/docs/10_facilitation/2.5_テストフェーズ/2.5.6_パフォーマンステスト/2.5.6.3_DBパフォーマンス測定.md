# 2.5.6.3 DBãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š

## ç›®çš„

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æ¸¬å®šã—ã€ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã‚’ç‰¹å®šã—ã¾ã™ã€‚

---

## ğŸ“Š DBãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šæ–¹æ³•

### 1. ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªãƒ­ã‚°ï¼ˆPostgreSQLï¼‰

#### è¨­å®š

```sql
-- postgresql.conf
log_min_duration_statement = 100  -- 100msä»¥ä¸Šã®ã‚¯ã‚¨ãƒªã‚’ãƒ­ã‚°å‡ºåŠ›
log_line_prefix = '%t [%p]: user=%u,db=%d,app=%a,client=%h '
log_statement = 'all'  -- é–‹ç™ºç’°å¢ƒã®ã¿
```

#### ãƒ­ã‚°ç¢ºèª

```bash
# ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªãƒ­ã‚°ã‚’ç¢ºèª
tail -f /var/log/postgresql/postgresql.log | grep "duration:"

# å‡ºåŠ›ä¾‹:
2025-10-19 10:15:30 JST [12345]: user=myapp,db=myapp_db duration: 523.142 ms  statement: SELECT * FROM users WHERE email LIKE '%@example.com';
```

---

### 2. EXPLAIN ANALYZEï¼ˆå®Ÿè¡Œè¨ˆç”»åˆ†æï¼‰

```sql
-- âŒ é…ã„ã‚¯ã‚¨ãƒªä¾‹
EXPLAIN ANALYZE
SELECT * FROM orders
WHERE user_id = 123
  AND created_at > '2025-01-01';

-- å‡ºåŠ›ä¾‹:
Seq Scan on orders  (cost=0.00..15234.00 rows=1000 width=128) (actual time=0.042..125.342 rows=1000 loops=1)
  Filter: ((user_id = 123) AND (created_at > '2025-01-01'::date))
  Rows Removed by Filter: 999000
Planning Time: 0.234 ms
Execution Time: 125.678 ms
```

**å•é¡Œ**: Seq Scanï¼ˆå…¨è¡¨ã‚¹ã‚­ãƒ£ãƒ³ï¼‰

**æ”¹å–„ç­–**: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 

```sql
-- âœ… ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
CREATE INDEX idx_orders_user_created ON orders(user_id, created_at);

-- å†åº¦å®Ÿè¡Œè¨ˆç”»ã‚’ç¢ºèª
EXPLAIN ANALYZE
SELECT * FROM orders
WHERE user_id = 123
  AND created_at > '2025-01-01';

-- æ”¹å–„å¾Œ:
Index Scan using idx_orders_user_created on orders  (cost=0.42..12.45 rows=1000 width=128) (actual time=0.021..0.542 rows=1000 loops=1)
  Index Cond: ((user_id = 123) AND (created_at > '2025-01-01'::date))
Planning Time: 0.156 ms
Execution Time: 0.678 ms  -- 125ms â†’ 0.678ms ã«æ”¹å–„ï¼
```

---

### 3. pg_stat_statementsï¼ˆã‚¯ã‚¨ãƒªçµ±è¨ˆï¼‰

#### æœ‰åŠ¹åŒ–

```sql
-- postgresql.conf
shared_preload_libraries = 'pg_stat_statements'

-- å†èµ·å‹•å¾Œ
CREATE EXTENSION pg_stat_statements;
```

#### é…ã„ã‚¯ã‚¨ãƒªTOP10

```sql
SELECT
  query,
  calls,
  total_exec_time,
  mean_exec_time,
  max_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;
```

å‡ºåŠ›ä¾‹:
```
                query                 | calls | total_exec_time | mean_exec_time | max_exec_time
--------------------------------------+-------+-----------------+----------------+---------------
SELECT * FROM orders WHERE user_id=? |  5000 |      125000.00  |         25.00  |       523.14
SELECT * FROM products WHERE ...     |  3000 |       90000.00  |         30.00  |       412.56
```

---

### 4. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«ã§ã®æ¸¬å®š

#### Python (SQLAlchemy)

```python
import time
from sqlalchemy import event
from sqlalchemy.engine import Engine
import logging

logger = logging.getLogger("sqlalchemy.engine")
logger.setLevel(logging.INFO)

@event.listens_for(Engine, "before_cursor_execute")
def before_cursor_execute(conn, cursor, statement, parameters, context, executemany):
    conn.info.setdefault('query_start_time', []).append(time.time())

@event.listens_for(Engine, "after_cursor_execute")
def after_cursor_execute(conn, cursor, statement, parameters, context, executemany):
    total = time.time() - conn.info['query_start_time'].pop(-1)
    if total > 0.1:  # 100msä»¥ä¸Š
        logger.warning(f"Slow query ({total:.3f}s): {statement[:200]}")
```

#### TypeScript (TypeORM)

```typescript
import { Logger } from 'typeorm';

export class QueryLogger implements Logger {
  logQuery(query: string, parameters?: any[], queryRunner?: QueryRunner) {
    const start = Date.now();

    queryRunner?.on('query', () => {
      const duration = Date.now() - start;
      if (duration > 100) {  // 100msä»¥ä¸Š
        console.warn(`Slow query (${duration}ms): ${query}`);
      }
    });
  }
}

// ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹è¨­å®š
const dataSource = new DataSource({
  // ...
  logging: true,
  logger: new QueryLogger(),
});
```

---

### 5. N+1å•é¡Œã®æ¤œå‡º

#### âŒ N+1å•é¡Œã®ä¾‹

```python
# âŒ Bad: N+1ã‚¯ã‚¨ãƒª
users = session.query(User).all()  # 1å›ã®ã‚¯ã‚¨ãƒª
for user in users:
    orders = user.orders  # Nå›ã®ã‚¯ã‚¨ãƒªï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã ã‘å®Ÿè¡Œï¼‰
    print(f"{user.name}: {len(orders)} orders")

# åˆè¨ˆ: 1 + Nå›ã®ã‚¯ã‚¨ãƒª
```

#### âœ… æ”¹å–„ä¾‹ï¼ˆEager Loadingï¼‰

```python
# âœ… Good: Eager Loading
users = session.query(User).options(joinedload(User.orders)).all()  # 1å›ã®ã‚¯ã‚¨ãƒªï¼ˆJOINï¼‰
for user in users:
    orders = user.orders  # è¿½åŠ ã‚¯ã‚¨ãƒªãªã—
    print(f"{user.name}: {len(orders)} orders")

# åˆè¨ˆ: 1å›ã®ã‚¯ã‚¨ãƒª
```

#### TypeScript (TypeORM)

```typescript
// âŒ Bad: N+1
const users = await userRepository.find();
for (const user of users) {
  const orders = await orderRepository.find({ where: { userId: user.id } });
}

// âœ… Good: Eager Loading
const users = await userRepository.find({ relations: ['orders'] });
for (const user of users) {
  const orders = user.orders;  // è¿½åŠ ã‚¯ã‚¨ãƒªãªã—
}
```

---

## ğŸ¯ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™

| é …ç›® | ç›®æ¨™å€¤ |
|------|--------|
| å˜ç´”SELECTï¼ˆä¸»ã‚­ãƒ¼ï¼‰ | < 10ms |
| JOINå«ã‚€SELECT | < 50ms |
| è¤‡é›‘ãªé›†è¨ˆã‚¯ã‚¨ãƒª | < 200ms |
| INSERT/UPDATE | < 20ms |
| ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªæ¯”ç‡ | < 1% |

---

## ğŸ”§ æ”¹å–„æ‰‹æ³•

### 1. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 

```sql
-- WHEREå¥ã§ã‚ˆãä½¿ã†ã‚«ãƒ©ãƒ ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_users_email ON users(email);

-- è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆã‚ˆãä¸€ç·’ã«æ¤œç´¢ã•ã‚Œã‚‹ã‚«ãƒ©ãƒ ï¼‰
CREATE INDEX idx_orders_user_status ON orders(user_id, status);
```

### 2. ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–

```sql
-- âŒ Bad: SELECT *
SELECT * FROM users WHERE email = 'test@example.com';

-- âœ… Good: å¿…è¦ãªã‚«ãƒ©ãƒ ã®ã¿
SELECT id, name, email FROM users WHERE email = 'test@example.com';
```

### 3. ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°

```sql
-- æ—¥ä»˜ã«ã‚ˆã‚‹ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°
CREATE TABLE orders_2025_01 PARTITION OF orders
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

### 4. æ¥ç¶šãƒ—ãƒ¼ãƒ«ã®æœ€é©åŒ–

```python
# SQLAlchemy
engine = create_engine(
    'postgresql://user:pass@localhost/db',
    pool_size=20,        # æ¥ç¶šãƒ—ãƒ¼ãƒ«ã‚µã‚¤ã‚º
    max_overflow=10,     # ãƒ—ãƒ¼ãƒ«ã‚’è¶…ãˆãŸå ´åˆã®è¿½åŠ æ¥ç¶š
    pool_pre_ping=True,  # æ¥ç¶šã®å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
)
```

---

**ä½œæˆæ—¥**: 2025-10-19
**é‡è¦åº¦**: â­â­â­
