# 2.5.3.4.2 ãƒ¢ãƒƒã‚­ãƒ³ã‚°ï¼ˆtestifyï¼‰

## ç›®çš„

testify/mockã‚’ä½¿ã£ã¦å¤–éƒ¨ä¾å­˜ã‚’ãƒ¢ãƒƒã‚¯ã—ã¾ã™ã€‚

---

## ğŸ”„ testifyãƒ¢ãƒƒã‚­ãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³

### testifyã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
go get github.com/stretchr/testify/mock
go get github.com/stretchr/testify/assert
```

### ãƒ¢ãƒƒã‚¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©

```go
package mocks

import (
    "github.com/stretchr/testify/mock"
    "myapp/domain"
)

// UserRepository ãƒ¢ãƒƒã‚¯ã®å®šç¾©
type MockUserRepository struct {
    mock.Mock
}

func (m *MockUserRepository) FindByID(id int) (*domain.User, error) {
    args := m.Called(id)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*domain.User), args.Error(1)
}

func (m *MockUserRepository) Save(user *domain.User) error {
    args := m.Called(user)
    return args.Error(0)
}
```

### ãƒ¢ãƒƒã‚¯ã®ä½¿ç”¨

```go
package service

import (
    "testing"
    "myapp/mocks"
    "myapp/domain"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"
)

func TestGetUser_WhenUserExists_ReturnsUser(t *testing.T) {
    // Arrange
    mockRepo := new(mocks.MockUserRepository)
    expectedUser := &domain.User{ID: 1, Name: "Test User"}

    mockRepo.On("FindByID", 1).Return(expectedUser, nil)

    service := NewUserService(mockRepo)

    // Act
    result, err := service.GetUser(1)

    // Assert
    assert.NoError(t, err)
    assert.Equal(t, expectedUser.ID, result.ID)
    assert.Equal(t, expectedUser.Name, result.Name)

    mockRepo.AssertExpectations(t)
    mockRepo.AssertCalled(t, "FindByID", 1)
}
```

### ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®ãƒ¢ãƒƒã‚¯

```go
func TestGetUser_WhenUserNotFound_ReturnsError(t *testing.T) {
    // Arrange
    mockRepo := new(mocks.MockUserRepository)
    mockRepo.On("FindByID", 999).Return(nil, domain.ErrNotFound)

    service := NewUserService(mockRepo)

    // Act
    result, err := service.GetUser(999)

    // Assert
    assert.Error(t, err)
    assert.Nil(t, result)
    assert.Equal(t, domain.ErrNotFound, err)

    mockRepo.AssertExpectations(t)
}
```

### å¼•æ•°ã®ãƒãƒƒãƒãƒ³ã‚°

```go
func TestCreateUser_WithValidUser_SavesUser(t *testing.T) {
    // Arrange
    mockRepo := new(mocks.MockUserRepository)

    // ä»»æ„ã®Userã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ãƒãƒƒãƒãƒ³ã‚°
    mockRepo.On("Save", mock.AnythingOfType("*domain.User")).Return(nil)

    service := NewUserService(mockRepo)
    newUser := &domain.User{Name: "New User", Email: "new@example.com"}

    // Act
    err := service.CreateUser(newUser)

    // Assert
    assert.NoError(t, err)
    mockRepo.AssertExpectations(t)

    // ç‰¹å®šã®æ¡ä»¶ã§ãƒãƒƒãƒãƒ³ã‚°
    mockRepo.AssertCalled(t, "Save", mock.MatchedBy(func(u *domain.User) bool {
        return u.Name == "New User"
    }))
}
```

### è¤‡æ•°å›å‘¼ã³å‡ºã—ã®ãƒ¢ãƒƒã‚¯

```go
func TestGetUsers_WhenMultipleCalls_ReturnsUsers(t *testing.T) {
    // Arrange
    mockRepo := new(mocks.MockUserRepository)

    user1 := &domain.User{ID: 1, Name: "User1"}
    user2 := &domain.User{ID: 2, Name: "User2"}

    mockRepo.On("FindByID", 1).Return(user1, nil).Once()
    mockRepo.On("FindByID", 2).Return(user2, nil).Once()

    service := NewUserService(mockRepo)

    // Act
    result1, _ := service.GetUser(1)
    result2, _ := service.GetUser(2)

    // Assert
    assert.Equal(t, "User1", result1.Name)
    assert.Equal(t, "User2", result2.Name)

    mockRepo.AssertNumberOfCalls(t, "FindByID", 2)
}
```

### ãƒ¢ãƒƒã‚¯ã®ãƒªã‚»ãƒƒãƒˆ

```go
func TestUserService_MultipleTests(t *testing.T) {
    mockRepo := new(mocks.MockUserRepository)

    t.Run("test 1", func(t *testing.T) {
        mockRepo.On("FindByID", 1).Return(&domain.User{ID: 1}, nil).Once()
        // ... ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        mockRepo.AssertExpectations(t)
    })

    // ãƒ†ã‚¹ãƒˆé–“ã§ãƒ¢ãƒƒã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆ
    mockRepo.ExpectedCalls = nil
    mockRepo.Calls = nil

    t.Run("test 2", func(t *testing.T) {
        mockRepo.On("FindByID", 2).Return(&domain.User{ID: 2}, nil).Once()
        // ... ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        mockRepo.AssertExpectations(t)
    })
}
```

---

**ä½œæˆæ—¥**: 2025-10-19
**é‡è¦åº¦**: â­â­â­
