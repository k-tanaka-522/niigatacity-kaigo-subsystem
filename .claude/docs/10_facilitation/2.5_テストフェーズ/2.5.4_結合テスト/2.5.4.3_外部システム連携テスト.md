# 2.5.4.3 å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ é€£æºãƒ†ã‚¹ãƒˆ

## ç›®çš„

å¤–éƒ¨APIã€AWSã‚µãƒ¼ãƒ“ã‚¹ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ç­‰ã¨ã®é€£æºã‚’æ¤œè¨¼ã—ã¾ã™ã€‚

---

## ğŸŒ å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ é€£æºãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 1. å¤–éƒ¨APIé€£æºãƒ†ã‚¹ãƒˆ

**æ–¹é‡**: Wiremockã€nockç­‰ã§ãƒ¢ãƒƒã‚¯åŒ–

#### Python (httpx + respx)

```python
import pytest
import respx
from httpx import AsyncClient
from myapp.services.external_api import WeatherService

@pytest.mark.asyncio
@respx.mock
async def test_get_weather_from_external_api():
    # Arrange
    mock_response = {
        "city": "Tokyo",
        "temperature": 25.5,
        "condition": "Sunny"
    }

    # å¤–éƒ¨APIã‚’ãƒ¢ãƒƒã‚¯
    respx.get("https://api.weather.example.com/forecast?city=Tokyo").mock(
        return_value=Response(200, json=mock_response)
    )

    service = WeatherService()

    # Act
    result = await service.get_weather("Tokyo")

    # Assert
    assert result["city"] == "Tokyo"
    assert result["temperature"] == 25.5
```

#### TypeScript (nock)

```typescript
import nock from 'nock';
import { WeatherService } from '../src/services/weatherService';

describe('External API Integration Tests', () => {
  afterEach(() => {
    nock.cleanAll();
  });

  it('should fetch weather data from external API', async () => {
    // Arrange
    nock('https://api.weather.example.com')
      .get('/forecast')
      .query({ city: 'Tokyo' })
      .reply(200, {
        city: 'Tokyo',
        temperature: 25.5,
        condition: 'Sunny',
      });

    const service = new WeatherService();

    // Act
    const result = await service.getWeather('Tokyo');

    // Assert
    expect(result.city).toBe('Tokyo');
    expect(result.temperature).toBe(25.5);
  });

  it('should handle external API errors', async () => {
    // Arrange
    nock('https://api.weather.example.com')
      .get('/forecast')
      .query({ city: 'InvalidCity' })
      .reply(404, { error: 'City not found' });

    const service = new WeatherService();

    // Act & Assert
    await expect(service.getWeather('InvalidCity')).rejects.toThrow(
      'City not found'
    );
  });
});
```

---

### 2. AWSé€£æºãƒ†ã‚¹ãƒˆï¼ˆLocalStackä½¿ç”¨ï¼‰

#### LocalStack ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```yaml
# docker-compose.test.yml
version: '3.8'
services:
  localstack:
    image: localstack/localstack:latest
    ports:
      - "4566:4566"
    environment:
      SERVICES: s3,sqs,sns,dynamodb
      DEFAULT_REGION: ap-northeast-1
      DATA_DIR: /tmp/localstack/data
    volumes:
      - ./localstack-init:/docker-entrypoint-initaws.d
```

#### S3é€£æºãƒ†ã‚¹ãƒˆï¼ˆPythonï¼‰

```python
import pytest
import boto3
from moto import mock_s3
from myapp.services.s3_service import S3Service

@pytest.fixture
def s3_client():
    with mock_s3():
        s3 = boto3.client('s3', region_name='ap-northeast-1')
        s3.create_bucket(
            Bucket='test-bucket',
            CreateBucketConfiguration={'LocationConstraint': 'ap-northeast-1'}
        )
        yield s3

@pytest.mark.integration
def test_upload_file_to_s3(s3_client):
    # Arrange
    service = S3Service(s3_client)
    file_content = b"Test file content"
    file_key = "test/file.txt"

    # Act
    service.upload_file("test-bucket", file_key, file_content)

    # Assert
    response = s3_client.get_object(Bucket="test-bucket", Key=file_key)
    assert response['Body'].read() == file_content
```

#### SQSé€£æºãƒ†ã‚¹ãƒˆï¼ˆTypeScriptï¼‰

```typescript
import { SQSClient, SendMessageCommand, ReceiveMessageCommand } from '@aws-sdk/client-sqs';
import { SQSService } from '../src/services/sqsService';

describe('SQS Integration Tests', () => {
  let sqsClient: SQSClient;
  let queueUrl: string;

  beforeAll(async () => {
    // LocalStackã«æ¥ç¶š
    sqsClient = new SQSClient({
      endpoint: 'http://localhost:4566',
      region: 'ap-northeast-1',
    });

    // ãƒ†ã‚¹ãƒˆç”¨ã‚­ãƒ¥ãƒ¼ã‚’ä½œæˆ
    const createQueueCommand = new CreateQueueCommand({
      QueueName: 'test-queue',
    });
    const response = await sqsClient.send(createQueueCommand);
    queueUrl = response.QueueUrl!;
  });

  it('should send and receive message from SQS', async () => {
    // Arrange
    const service = new SQSService(sqsClient);
    const message = { userId: 123, action: 'CREATE' };

    // Act - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    await service.sendMessage(queueUrl, message);

    // Assert - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
    const received = await service.receiveMessage(queueUrl);
    expect(received).toBeDefined();
    expect(JSON.parse(received!.Body!)).toEqual(message);
  });
});
```

---

### 3. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼é€£æºãƒ†ã‚¹ãƒˆï¼ˆRedisï¼‰

```python
import pytest
import redis.asyncio as redis
from myapp.services.queue_service import QueueService

@pytest.fixture
async def redis_client():
    client = await redis.from_url("redis://localhost:6380")
    yield client
    await client.flushdb()
    await client.close()

@pytest.mark.asyncio
async def test_publish_and_consume_message(redis_client):
    # Arrange
    service = QueueService(redis_client)
    channel = "test-channel"
    message = {"event": "user.created", "userId": 123}

    # Act - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç™ºè¡Œ
    await service.publish(channel, message)

    # Assert - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
    pubsub = redis_client.pubsub()
    await pubsub.subscribe(channel)

    async for msg in pubsub.listen():
        if msg['type'] == 'message':
            data = json.loads(msg['data'])
            assert data["event"] == "user.created"
            assert data["userId"] == 123
            break
```

---

## ğŸ¯ æ¤œè¨¼é …ç›®

- âœ… å¤–éƒ¨APIå‘¼ã³å‡ºã—ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†
- âœ… å¤–éƒ¨APIã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒªãƒˆãƒ©ã‚¤ãƒ»ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
- âœ… AWSã‚µãƒ¼ãƒ“ã‚¹ï¼ˆS3ã€SQSã€SNSï¼‰ã¨ã®é€£æº
- âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ã®é€å—ä¿¡
- âœ… ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ»ãƒªãƒˆãƒ©ã‚¤å‡¦ç†

---

**ä½œæˆæ—¥**: 2025-10-19
**é‡è¦åº¦**: â­â­â­
