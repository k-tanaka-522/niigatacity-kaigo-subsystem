# 2.5.7.2 Chaos Engineeringãƒ‘ã‚¿ãƒ¼ãƒ³

## ç›®çš„

Chaos Engineeringã®åŸå‰‡ã«åŸºã¥ãã€ã‚·ã‚¹ãƒ†ãƒ ã®å›å¾©åŠ›ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚

---

## ğŸŒªï¸ Chaos Engineeringã®åŸå‰‡

### 1. å®šå¸¸çŠ¶æ…‹ã®ä»®èª¬ã‚’ç«‹ã¦ã‚‹

**ä¾‹**:
```
é€šå¸¸æ™‚ã®å®šå¸¸çŠ¶æ…‹:
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ï¼ˆp95ï¼‰: 200msä»¥ä¸‹
- ã‚¨ãƒ©ãƒ¼ç‡: 0.1%ä»¥ä¸‹
- ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ: 1,000 req/sä»¥ä¸Š
```

### 2. ç¾å®Ÿä¸–ç•Œã®äº‹è±¡ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ

- ã‚µãƒ¼ãƒãƒ¼ã‚¯ãƒ©ãƒƒã‚·ãƒ¥
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æ–­
- ãƒªã‚½ãƒ¼ã‚¹æ¯æ¸‡
- å¤–éƒ¨ä¾å­˜ã®éšœå®³

### 3. æœ¬ç•ªç’°å¢ƒã§å®Ÿè¡Œ

- ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã ã‘ã§ãªãã€æœ¬ç•ªç’°å¢ƒã§ã‚‚å®Ÿæ–½
- å°è¦æ¨¡ã‹ã‚‰é–‹å§‹ï¼ˆã‚«ãƒŠãƒªã‚¢ãƒ†ã‚¹ãƒˆï¼‰

### 4. è‡ªå‹•åŒ–

- CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«çµ„ã¿è¾¼ã‚€
- å®šæœŸçš„ã«å®Ÿè¡Œï¼ˆé€±æ¬¡ã€æœˆæ¬¡ï¼‰

---

## ğŸ§ª Chaos Engineeringãƒ‘ã‚¿ãƒ¼ãƒ³

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: ãƒ©ãƒ³ãƒ€ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åœæ­¢

**ç›®çš„**: ã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãƒ»ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã®å‹•ä½œç¢ºèª

```yaml
# AWS FIS
ExperimentTemplate:
  Description: "ECSã‚¿ã‚¹ã‚¯ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«åœæ­¢"
  Actions:
    StopRandomTask:
      ActionId: aws:ecs:stop-task
      Parameters:
        cluster: myapp-cluster
      Targets:
        Tasks:
          ResourceType: aws:ecs:task
          SelectionMode: PERCENT(10)  # 10%ã®ã‚¿ã‚¹ã‚¯ã‚’åœæ­¢
  StopConditions:
    - Source: aws:cloudwatch:alarm
      Value: !GetAtt HighErrorRateAlarm.Arn
```

**æ¤œè¨¼**:
```bash
# éšœå®³æ³¨å…¥å‰
curl -X POST https://api.example.com/chaos/start-stop-task

# ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
watch -n 1 "aws ecs describe-services --cluster myapp-cluster --services myapp-service | jq '.services[0].runningCount'"

# k6ã§è² è·ã‚’ã‹ã‘ãªãŒã‚‰ç›£è¦–
k6 run --vus 100 --duration 5m load-test.js
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·æ³¨å…¥

**ç›®çš„**: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ»ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ã®æ¤œè¨¼

```yaml
# Chaos Mesh (Kubernetes)
apiVersion: chaos-mesh.org/v1alpha1
kind: NetworkChaos
metadata:
  name: network-delay-test
spec:
  action: delay
  mode: one
  selector:
    namespaces:
      - default
    labelSelectors:
      app: myapp
  delay:
    latency: "500ms"
    correlation: "100"
  duration: "5m"
```

**æ¤œè¨¼ã‚³ãƒ¼ãƒ‰ï¼ˆPythonï¼‰**:
```python
import httpx
import asyncio

async def test_with_latency():
    timeout = httpx.Timeout(2.0, connect=5.0)  # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
    async with httpx.AsyncClient(timeout=timeout) as client:
        try:
            response = await client.get("http://api.example.com/users")
            print(f"Success: {response.status_code}")
        except httpx.TimeoutException:
            print("Timeout occurred - handled correctly")
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³3: CPUã‚¹ãƒ‘ã‚¤ã‚¯

**ç›®çš„**: ãƒªã‚½ãƒ¼ã‚¹æ¯æ¸‡æ™‚ã®å‹•ä½œç¢ºèª

```yaml
# Chaos Mesh
apiVersion: chaos-mesh.org/v1alpha1
kind: StressChaos
metadata:
  name: cpu-stress-test
spec:
  mode: one
  selector:
    namespaces:
      - default
    labelSelectors:
      app: myapp
  stressors:
    cpu:
      workers: 4
      load: 100  # 100% CPU
  duration: '2m'
```

**æ¤œè¨¼é …ç›®**:
- âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãªã„ã‹
- âœ… CloudWatchã‚¢ãƒ©ãƒ¼ãƒ ãŒç™ºç«ã™ã‚‹ã‹
- âœ… ã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãŒç™ºå‹•ã™ã‚‹ã‹

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³4: ãƒ¡ãƒ¢ãƒªæ¯æ¸‡

```yaml
# Chaos Mesh
apiVersion: chaos-mesh.org/v1alpha1
kind: StressChaos
metadata:
  name: memory-stress-test
spec:
  mode: one
  selector:
    namespaces:
      - default
    labelSelectors:
      app: myapp
  stressors:
    memory:
      workers: 1
      size: '2GB'  # 2GBã®ãƒ¡ãƒ¢ãƒªã‚’æ¶ˆè²»
  duration: '2m'
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³5: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹éšœå®³

**ç›®çš„**: DBæ¥ç¶šã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒªãƒˆãƒ©ã‚¤ãƒ»ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œè¨¼

```python
# æ‰‹å‹•ã§DBã‚’åœæ­¢ã—ã¦ãƒ†ã‚¹ãƒˆ
import psycopg2
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=1, max=10)
)
def get_user_with_retry(user_id):
    try:
        conn = psycopg2.connect(
            host="db.example.com",
            database="myapp",
            user="myapp",
            password="password",
            connect_timeout=3
        )
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM users WHERE id = %s", (user_id,))
        return cursor.fetchone()
    except psycopg2.OperationalError as e:
        print(f"DB connection failed: {e}")
        raise
```

**ãƒ†ã‚¹ãƒˆ**:
```bash
# RDSéšœå®³æ³¨å…¥
aws rds failover-db-cluster --db-cluster-identifier myapp-cluster

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‹•ä½œç¢ºèª
curl http://api.example.com/users/1
```

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³6: ä¾å­˜ã‚µãƒ¼ãƒ“ã‚¹éšœå®³

**ç›®çš„**: å¤–éƒ¨APIéšœå®³æ™‚ã®ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼æ¤œè¨¼

```python
from circuitbreaker import circuit

@circuit(failure_threshold=5, recovery_timeout=30)
def call_external_api():
    response = httpx.get("https://external-api.example.com/data", timeout=5.0)
    if response.status_code != 200:
        raise Exception("API call failed")
    return response.json()

# ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
def get_data_with_fallback():
    try:
        return call_external_api()
    except Exception:
        # ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ãŒé–‹ã„ãŸå ´åˆã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—
        return get_cached_data()
```

**éšœå®³æ³¨å…¥**:
```bash
# å¤–éƒ¨APIã‚’ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆiptablesï¼‰
sudo iptables -A OUTPUT -d external-api.example.com -j DROP

# 5åˆ†å¾Œã«è§£é™¤
sleep 300
sudo iptables -D OUTPUT -d external-api.example.com -j DROP
```

---

## ğŸ¯ Chaoså®Ÿé¨“ã®å®Ÿæ–½æ‰‹é †

### 1. æº–å‚™

```yaml
# å®Ÿé¨“è¨ˆç”»æ›¸
title: "ECSã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒ€ãƒ åœæ­¢ãƒ†ã‚¹ãƒˆ"
hypothesis: "10%ã®ã‚¿ã‚¹ã‚¯ãŒåœæ­¢ã—ã¦ã‚‚ã€ã‚¨ãƒ©ãƒ¼ç‡ã¯0.1%æœªæº€ã‚’ç¶­æŒã™ã‚‹"
blast_radius: "10%ã®ã‚¿ã‚¹ã‚¯"
rollback: "CloudWatchã‚¢ãƒ©ãƒ¼ãƒ ãŒç™ºç«ã—ãŸã‚‰å³åº§ã«åœæ­¢"
```

### 2. å®Ÿè¡Œ

```bash
# ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°é–‹å§‹
datadog-agent start

# è² è·ãƒ†ã‚¹ãƒˆé–‹å§‹
k6 run --vus 1000 --duration 10m load-test.js &

# éšœå®³æ³¨å…¥
aws fis start-experiment --experiment-template-id EXT1234567890

# ç›£è¦–
watch -n 5 "aws cloudwatch get-metric-statistics --namespace AWS/ECS ..."
```

### 3. è¦³å¯Ÿ

- âœ… ã‚¨ãƒ©ãƒ¼ç‡ã®æ¨ç§»
- âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ã®æ¨ç§»
- âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®å‹•ä½œ
- âœ… ã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã®ç™ºå‹•

### 4. å­¦ç¿’

```markdown
## å®Ÿé¨“çµæœ

### æˆåŠŸ
- ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ãŒãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã§æ¤œçŸ¥ï¼ˆ30ç§’ï¼‰
- ã‚¨ãƒ©ãƒ¼ç‡ 0.05%ï¼ˆç›®æ¨™ < 0.1% é”æˆï¼‰

### æ”¹å–„ç‚¹
- ã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã®ç™ºå‹•ã¾ã§2åˆ†ã‹ã‹ã£ãŸ â†’ é–¾å€¤ã‚’èª¿æ•´
```

---

**ä½œæˆæ—¥**: 2025-10-19
**é‡è¦åº¦**: â­â­â­
