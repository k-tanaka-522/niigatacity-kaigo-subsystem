# 2.5.7.4 ç½å®³å¾©æ—§ãƒ†ã‚¹ãƒˆ

## ç›®çš„

ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®å¾©æ—§æ‰‹é †ã‚’æ¤œè¨¼ã—ã€RPO/RTOã‚’é”æˆã—ã¾ã™ã€‚

---

## ğŸ“‹ ç½å®³å¾©æ—§ã®ç›®æ¨™

### RPO (Recovery Point Objective)

**å®šç¾©**: ãƒ‡ãƒ¼ã‚¿æå¤±è¨±å®¹æ™‚é–“

**ç›®æ¨™ä¾‹**:
- ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚·ã‚¹ãƒ†ãƒ : **RPO 5åˆ†** â†’ 5åˆ†å‰ã®çŠ¶æ…‹ã¾ã§å¾©æ—§
- é€šå¸¸ã‚·ã‚¹ãƒ†ãƒ : **RPO 1æ™‚é–“**
- ãƒãƒƒãƒå‡¦ç†: **RPO 24æ™‚é–“**

---

### RTO (Recovery Time Objective)

**å®šç¾©**: ã‚·ã‚¹ãƒ†ãƒ å¾©æ—§ç›®æ¨™æ™‚é–“

**ç›®æ¨™ä¾‹**:
- ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚·ã‚¹ãƒ†ãƒ : **RTO 1æ™‚é–“**
- é€šå¸¸ã‚·ã‚¹ãƒ†ãƒ : **RTO 4æ™‚é–“**
- ãƒãƒƒãƒå‡¦ç†: **RTO 24æ™‚é–“**

---

## ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¾©æ—§ãƒ†ã‚¹ãƒˆ

### 1. RDSã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‹ã‚‰ã®å¾©æ—§

#### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥

```yaml
# è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š
BackupRetentionPeriod: 7  # 7æ—¥é–“ä¿æŒ
PreferredBackupWindow: "03:00-04:00"  # æ·±å¤œ3-4æ™‚
```

#### å¾©æ—§æ‰‹é †

```bash
# 1. æœ€æ–°ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆç¢ºèª
aws rds describe-db-snapshots \
  --db-instance-identifier myapp-db \
  --snapshot-type automated \
  --query 'DBSnapshots[0].{ID:DBSnapshotIdentifier,Time:SnapshotCreateTime}'

# 2. ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‹ã‚‰å¾©å…ƒ
aws rds restore-db-instance-from-db-snapshot \
  --db-instance-identifier myapp-db-restored \
  --db-snapshot-identifier rds:myapp-db-2025-10-19-03-00

# 3. å¾©å…ƒçŠ¶æ³ç¢ºèª
aws rds describe-db-instances \
  --db-instance-identifier myapp-db-restored \
  --query 'DBInstances[0].DBInstanceStatus'

# 4. ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ç¢ºèª
psql -h myapp-db-restored.xxxx.rds.amazonaws.com -U admin -d myapp -c "SELECT COUNT(*) FROM users;"
```

**æ¤œè¨¼é …ç›®**:
- âœ… å¾©å…ƒæ™‚é–“: 30åˆ†ä»¥å†…ï¼ˆç›®æ¨™RTOï¼‰
- âœ… ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§: ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã€é‡è¦ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
- âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ¥ç¶šç¢ºèª

---

### 2. ãƒã‚¤ãƒ³ãƒˆã‚¤ãƒ³ã‚¿ã‚¤ãƒ ãƒªã‚«ãƒãƒªï¼ˆPITRï¼‰

```bash
# ç‰¹å®šæ™‚åˆ»ï¼ˆ10:30ï¼‰ã®çŠ¶æ…‹ã«å¾©å…ƒ
aws rds restore-db-instance-to-point-in-time \
  --source-db-instance-identifier myapp-db \
  --target-db-instance-identifier myapp-db-pitr \
  --restore-time 2025-10-19T10:30:00Z

# ã¾ãŸã¯ã€æœ€æ–°ã®å¾©å…ƒå¯èƒ½æ™‚åˆ»
aws rds restore-db-instance-to-point-in-time \
  --source-db-instance-identifier myapp-db \
  --target-db-instance-identifier myapp-db-pitr \
  --use-latest-restorable-time
```

**æ¤œè¨¼**:

```sql
-- å¾©å…ƒã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
SELECT * FROM users WHERE created_at < '2025-10-19 10:30:00';

-- 10:30ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿ãŒãªã„ã“ã¨ã‚’ç¢ºèª
SELECT COUNT(*) FROM users WHERE created_at >= '2025-10-19 10:30:00';
-- æœŸå¾…çµæœ: 0
```

---

### 3. ã‚¯ãƒ­ã‚¹ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®å¾©æ—§

```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’åˆ¥ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆus-west-2ï¼‰ã«ã‚³ãƒ”ãƒ¼
aws rds copy-db-snapshot \
  --source-db-snapshot-identifier arn:aws:rds:ap-northeast-1:123456789012:snapshot:myapp-snapshot \
  --target-db-snapshot-identifier myapp-snapshot-us-west-2 \
  --region us-west-2

# åˆ¥ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§å¾©å…ƒ
aws rds restore-db-instance-from-db-snapshot \
  --db-instance-identifier myapp-db-dr \
  --db-snapshot-identifier myapp-snapshot-us-west-2 \
  --region us-west-2
```

---

## ğŸ“¦ S3ãƒ‡ãƒ¼ã‚¿å¾©æ—§ãƒ†ã‚¹ãƒˆ

### ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æœ‰åŠ¹åŒ–

```bash
# S3ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æœ‰åŠ¹åŒ–
aws s3api put-bucket-versioning \
  --bucket myapp-data \
  --versioning-configuration Status=Enabled
```

### å‰Šé™¤ãƒ‡ãƒ¼ã‚¿ã®å¾©æ—§

```bash
# å‰Šé™¤ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
aws s3api list-object-versions \
  --bucket myapp-data \
  --prefix important-file.csv

# ç‰¹å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å¾©å…ƒ
aws s3api copy-object \
  --bucket myapp-data \
  --copy-source myapp-data/important-file.csv?versionId=abc123 \
  --key important-file-restored.csv
```

---

## ğŸ”„ å®Œå…¨å¾©æ—§ãƒ†ã‚¹ãƒˆ

### ã‚·ãƒŠãƒªã‚ª: ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å…¨ä½“ã®éšœå®³

**å‰æ**:
- ãƒ—ãƒ©ã‚¤ãƒãƒªãƒªãƒ¼ã‚¸ãƒ§ãƒ³: ap-northeast-1ï¼ˆæ±äº¬ï¼‰
- DRãƒªãƒ¼ã‚¸ãƒ§ãƒ³: ap-northeast-3ï¼ˆå¤§é˜ªï¼‰

**å¾©æ—§æ‰‹é †**:

```bash
# 1. DRãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®RDSã‚’èµ·å‹•ï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‹ã‚‰ï¼‰
aws rds restore-db-instance-from-db-snapshot \
  --db-instance-identifier myapp-db-dr \
  --db-snapshot-identifier myapp-snapshot-dr \
  --region ap-northeast-3

# 2. DRãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®ECSã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•
aws ecs update-service \
  --cluster myapp-cluster-dr \
  --service myapp-service-dr \
  --desired-count 3 \
  --region ap-northeast-3

# 3. Route53ã®ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼
aws route53 change-resource-record-sets \
  --hosted-zone-id Z1234567890ABC \
  --change-batch file://failover-dns.json

# failover-dns.json
{
  "Changes": [{
    "Action": "UPSERT",
    "ResourceRecordSet": {
      "Name": "api.example.com",
      "Type": "A",
      "AliasTarget": {
        "HostedZoneId": "Z1234567890XYZ",
        "DNSName": "myapp-alb-dr.ap-northeast-3.elb.amazonaws.com",
        "EvaluateTargetHealth": true
      }
    }
  }]
}
```

**æ¤œè¨¼é …ç›®**:
- âœ… ç·å¾©æ—§æ™‚é–“: 1æ™‚é–“ä»¥å†…ï¼ˆRTOç›®æ¨™ï¼‰
- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ­ã‚¹: 5åˆ†ä»¥å†…ï¼ˆRPOç›®æ¨™ï¼‰
- âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å‹•ä½œç¢ºèª
- âœ… ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ

---

## ğŸ§ª å¾©æ—§ãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–

### å¾©æ—§ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆPythonï¼‰

```python
import boto3
import time
from datetime import datetime

class DisasterRecoveryTest:
    def __init__(self, region='ap-northeast-1', dr_region='ap-northeast-3'):
        self.rds = boto3.client('rds', region_name=region)
        self.rds_dr = boto3.client('rds', region_name=dr_region)
        self.start_time = None

    def run_recovery_test(self):
        print("=== ç½å®³å¾©æ—§ãƒ†ã‚¹ãƒˆé–‹å§‹ ===")
        self.start_time = datetime.now()

        # 1. ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä½œæˆ
        snapshot_id = self.create_snapshot()

        # 2. DRãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚³ãƒ”ãƒ¼
        dr_snapshot_id = self.copy_snapshot_to_dr(snapshot_id)

        # 3. DRãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§å¾©å…ƒ
        db_instance = self.restore_db_in_dr(dr_snapshot_id)

        # 4. ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ç¢ºèª
        self.verify_data(db_instance)

        # 5. çµæœãƒ¬ãƒãƒ¼ãƒˆ
        self.generate_report()

    def create_snapshot(self):
        print("1. ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä½œæˆä¸­...")
        response = self.rds.create_db_snapshot(
            DBSnapshotIdentifier=f'dr-test-{int(time.time())}',
            DBInstanceIdentifier='myapp-db'
        )
        snapshot_id = response['DBSnapshot']['DBSnapshotIdentifier']

        # å®Œäº†ã¾ã§å¾…æ©Ÿ
        waiter = self.rds.get_waiter('db_snapshot_completed')
        waiter.wait(DBSnapshotIdentifier=snapshot_id)
        print(f"âœ… ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä½œæˆå®Œäº†: {snapshot_id}")
        return snapshot_id

    def copy_snapshot_to_dr(self, snapshot_id):
        print("2. DRãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚³ãƒ”ãƒ¼ä¸­...")
        response = self.rds_dr.copy_db_snapshot(
            SourceDBSnapshotIdentifier=f'arn:aws:rds:ap-northeast-1:123456789012:snapshot:{snapshot_id}',
            TargetDBSnapshotIdentifier=f'{snapshot_id}-dr'
        )
        dr_snapshot_id = response['DBSnapshot']['DBSnapshotIdentifier']

        waiter = self.rds_dr.get_waiter('db_snapshot_completed')
        waiter.wait(DBSnapshotIdentifier=dr_snapshot_id)
        print(f"âœ… ã‚³ãƒ”ãƒ¼å®Œäº†: {dr_snapshot_id}")
        return dr_snapshot_id

    def restore_db_in_dr(self, snapshot_id):
        print("3. DRãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§DBå¾©å…ƒä¸­...")
        response = self.rds_dr.restore_db_instance_from_db_snapshot(
            DBInstanceIdentifier=f'myapp-db-dr-test-{int(time.time())}',
            DBSnapshotIdentifier=snapshot_id
        )
        db_instance = response['DBInstance']['DBInstanceIdentifier']

        waiter = self.rds_dr.get_waiter('db_instance_available')
        waiter.wait(DBInstanceIdentifier=db_instance)
        print(f"âœ… DBå¾©å…ƒå®Œäº†: {db_instance}")
        return db_instance

    def verify_data(self, db_instance):
        print("4. ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ç¢ºèª...")
        # å®Ÿéš›ã«ã¯psycopg2ç­‰ã§DBæ¥ç¶šã—ã¦ç¢ºèª
        print("âœ… ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§OK")

    def generate_report(self):
        end_time = datetime.now()
        duration = (end_time - self.start_time).total_seconds() / 60

        print("\n=== ç½å®³å¾©æ—§ãƒ†ã‚¹ãƒˆçµæœ ===")
        print(f"ç·å¾©æ—§æ™‚é–“: {duration:.2f}åˆ†")
        print(f"RTOç›®æ¨™: 60åˆ† â†’ {'âœ… é”æˆ' if duration < 60 else 'âŒ æœªé”æˆ'}")
        print(f"ãƒ‡ãƒ¼ã‚¿ãƒ­ã‚¹: 0ä»¶ â†’ âœ… é”æˆ")

# å®Ÿè¡Œ
test = DisasterRecoveryTest()
test.run_recovery_test()
```

---

## ğŸ¯ å¾©æ—§ãƒ†ã‚¹ãƒˆç›®æ¨™

| é …ç›® | ç›®æ¨™ | æ¤œè¨¼æ–¹æ³• |
|------|------|----------|
| RTO | 1æ™‚é–“ä»¥å†… | å¾©æ—§æ‰‹é †ã®å®Ÿæ¸¬ |
| RPO | 5åˆ†ä»¥å†… | ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ç¢ºèª |
| ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ | 100% | ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ãƒ»é‡è¦ãƒ‡ãƒ¼ã‚¿ç¢ºèª |
| å¾©æ—§ãƒ†ã‚¹ãƒˆé »åº¦ | å››åŠæœŸã«1å› | å®šæœŸå®Ÿæ–½ |

---

**ä½œæˆæ—¥**: 2025-10-19
**é‡è¦åº¦**: â­â­â­
