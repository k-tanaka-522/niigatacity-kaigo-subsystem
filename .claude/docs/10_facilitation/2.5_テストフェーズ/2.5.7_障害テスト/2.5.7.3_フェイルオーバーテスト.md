# 2.5.7.3 ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ†ã‚¹ãƒˆ

## ç›®çš„

ã‚·ã‚¹ãƒ†ãƒ ã®å†—é•·æ§‹æˆãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚

---

## ğŸ”„ ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ†ã‚¹ãƒˆã®ç¨®é¡

### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼

#### RDS Multi-AZ

**æ§‹æˆ**:
```
Primary DB (AZ-1a) â†’ Standby DB (AZ-1b)
```

**ãƒ†ã‚¹ãƒˆæ‰‹é †**:

```bash
# 1. ãƒ—ãƒ©ã‚¤ãƒãƒªDBã®ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼å®Ÿè¡Œ
aws rds failover-db-cluster \
  --db-cluster-identifier myapp-cluster

# 2. ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼çŠ¶æ³ç¢ºèª
aws rds describe-db-clusters \
  --db-cluster-identifier myapp-cluster \
  --query 'DBClusters[0].Status'

# 3. æ–°ã—ã„ãƒ—ãƒ©ã‚¤ãƒãƒªDBã®ç¢ºèª
aws rds describe-db-cluster-endpoints \
  --db-cluster-identifier myapp-cluster
```

**ç›£è¦–ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆPythonï¼‰**:

```python
import time
import psycopg2
from datetime import datetime

def test_db_failover():
    start_time = datetime.now()
    errors = []

    for i in range(120):  # 2åˆ†é–“ç›£è¦–
        try:
            conn = psycopg2.connect(
                host="myapp-cluster.cluster-xxxx.ap-northeast-1.rds.amazonaws.com",
                database="myapp",
                user="admin",
                password="password",
                connect_timeout=5
            )
            cursor = conn.cursor()
            cursor.execute("SELECT 1")
            result = cursor.fetchone()
            print(f"[{i}] Connection OK: {result}")
            conn.close()
        except Exception as e:
            errors.append((datetime.now(), str(e)))
            print(f"[{i}] ERROR: {e}")

        time.sleep(1)

    end_time = datetime.now()
    downtime = sum(1 for _ in errors)

    print(f"\n=== ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ†ã‚¹ãƒˆçµæœ ===")
    print(f"ç·æ™‚é–“: {(end_time - start_time).total_seconds()}ç§’")
    print(f"ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ : {downtime}ç§’")
    print(f"ã‚¨ãƒ©ãƒ¼ç‡: {downtime / 120 * 100:.2f}%")

    return downtime < 60  # ç›®æ¨™: 60ç§’ä»¥å†…
```

---

### 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãƒ¼ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼

#### ECS ã‚¿ã‚¹ã‚¯ã®ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼

**æ§‹æˆ**:
```
ALB â†’ ECS Service (ã‚¿ã‚¹ã‚¯: 3å°)
```

**ãƒ†ã‚¹ãƒˆæ‰‹é †**:

```bash
# 1. ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ç¢ºèª
aws ecs list-tasks --cluster myapp-cluster --service-name myapp-service

# 2. ã‚¿ã‚¹ã‚¯ã‚’1ã¤å¼·åˆ¶åœæ­¢
aws ecs stop-task \
  --cluster myapp-cluster \
  --task arn:aws:ecs:ap-northeast-1:123456789012:task/myapp-cluster/abc123

# 3. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ»æ–°ã‚¿ã‚¹ã‚¯èµ·å‹•ã‚’ç›£è¦–
watch -n 2 "aws ecs describe-services \
  --cluster myapp-cluster \
  --services myapp-service \
  --query 'services[0].{Running:runningCount,Desired:desiredCount}'"
```

**k6è² è·ãƒ†ã‚¹ãƒˆï¼ˆãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ä¸­ï¼‰**:

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';

export let options = {
  vus: 100,
  duration: '5m',
  thresholds: {
    http_req_failed: ['rate<0.01'],  // ã‚¨ãƒ©ãƒ¼ç‡1%æœªæº€
  },
};

export default function () {
  const res = http.get('https://api.example.com/health');
  check(res, {
    'status is 200': (r) => r.status === 200,
  });
  sleep(1);
}
```

**æœŸå¾…ã•ã‚Œã‚‹çµæœ**:
- âœ… ALBãŒãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã§éšœå®³æ¤œçŸ¥ï¼ˆ30ç§’ä»¥å†…ï¼‰
- âœ… ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãŒæ­£å¸¸ã‚¿ã‚¹ã‚¯ã«æŒ¯ã‚Šåˆ†ã‘ã‚‰ã‚Œã‚‹
- âœ… æ–°ã—ã„ã‚¿ã‚¹ã‚¯ãŒè‡ªå‹•èµ·å‹•ï¼ˆ1åˆ†ä»¥å†…ï¼‰
- âœ… ã‚¨ãƒ©ãƒ¼ç‡ < 1%

---

### 3. AZãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼

#### Multi-AZæ§‹æˆ

**æ§‹æˆ**:
```
AZ-1a: ALB + ECS (ã‚¿ã‚¹ã‚¯2å°)
AZ-1b: ALB + ECS (ã‚¿ã‚¹ã‚¯2å°)
AZ-1c: ALB + ECS (ã‚¿ã‚¹ã‚¯2å°)
```

**ãƒ†ã‚¹ãƒˆï¼ˆAWS FISï¼‰**:

```yaml
ExperimentTemplate:
  Description: "AZ-1aã®ã™ã¹ã¦ã®ECSã‚¿ã‚¹ã‚¯ã‚’åœæ­¢"
  Targets:
    AZ1aTasks:
      ResourceType: aws:ecs:task
      ResourceArns:
        - arn:aws:ecs:ap-northeast-1:...:task/myapp-cluster/*
      Filters:
        - Path: AvailabilityZone
          Values:
            - ap-northeast-1a
  Actions:
    StopTasks:
      ActionId: aws:ecs:stop-task
      Targets:
        Tasks: AZ1aTasks
```

å®Ÿè¡Œ:
```bash
aws fis start-experiment --experiment-template-id EXT1234567890
```

**æœŸå¾…ã•ã‚Œã‚‹çµæœ**:
- âœ… AZ-1bã¨AZ-1cã®ã‚¿ã‚¹ã‚¯ãŒç¶™ç¶šç¨¼åƒ
- âœ… ã‚¨ãƒ©ãƒ¼ç‡ < 0.1%
- âœ… AZ-1aã®ã‚¿ã‚¹ã‚¯ãŒå†èµ·å‹•ï¼ˆ3åˆ†ä»¥å†…ï¼‰

---

### 4. ãƒªãƒ¼ãƒ‰ãƒ¬ãƒ—ãƒªã‚«ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼

#### æ§‹æˆ

```
Primary DB (Write)
  â†“
Read Replica 1 (Read)
Read Replica 2 (Read)
```

**ãƒ†ã‚¹ãƒˆ**:

```bash
# Read Replica 1ã‚’åœæ­¢
aws rds stop-db-instance --db-instance-identifier myapp-replica-1

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‹•ä½œç¢ºèª
```

**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã®ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†**:

```python
from sqlalchemy import create_engine
from sqlalchemy.pool import NullPool

# ãƒªãƒ¼ãƒ‰ãƒ¬ãƒ—ãƒªã‚«ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
READ_REPLICAS = [
    "myapp-replica-1.xxxx.ap-northeast-1.rds.amazonaws.com",
    "myapp-replica-2.xxxx.ap-northeast-1.rds.amazonaws.com",
]

class ReplicaPool:
    def __init__(self):
        self.engines = [
            create_engine(f"postgresql://user:pass@{host}/myapp", poolclass=NullPool)
            for host in READ_REPLICAS
        ]
        self.current_index = 0

    def get_engine(self):
        """ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³ã§ãƒ¬ãƒ—ãƒªã‚«ã‚’é¸æŠ"""
        for attempt in range(len(self.engines)):
            engine = self.engines[self.current_index]
            self.current_index = (self.current_index + 1) % len(self.engines)

            try:
                # æ¥ç¶šãƒ†ã‚¹ãƒˆ
                with engine.connect() as conn:
                    conn.execute("SELECT 1")
                return engine
            except Exception as e:
                print(f"Replica {attempt} failed: {e}")
                continue

        raise Exception("All replicas are down")

# ä½¿ç”¨ä¾‹
pool = ReplicaPool()
engine = pool.get_engine()
```

---

## ğŸ¯ ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ç›®æ¨™å€¤

| é …ç›® | ç›®æ¨™ |
|------|------|
| RDS ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼æ™‚é–“ | < 60ç§’ |
| ECS ã‚¿ã‚¹ã‚¯å†èµ·å‹•æ™‚é–“ | < 90ç§’ |
| ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ä¸­ã®ã‚¨ãƒ©ãƒ¼ç‡ | < 1% |
| ãƒ‡ãƒ¼ã‚¿ãƒ­ã‚¹ | 0ä»¶ |

---

## ğŸ“Š ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ†ã‚¹ãƒˆçµæœã‚µãƒ³ãƒ—ãƒ«

```markdown
# ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ†ã‚¹ãƒˆçµæœ

## ãƒ†ã‚¹ãƒˆæ—¥æ™‚
2025-10-19 10:00:00

## ãƒ†ã‚¹ãƒˆå†…å®¹
RDS Multi-AZ ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼

## çµæœ
- ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼é–‹å§‹: 10:00:00
- ãƒ—ãƒ©ã‚¤ãƒãƒªåˆ‡ã‚Šæ›¿ãˆå®Œäº†: 10:00:42 (42ç§’) âœ…
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼å›æ•°: 3å›
- ã‚¨ãƒ©ãƒ¼ç‡: 0.03% âœ…
- ãƒ‡ãƒ¼ã‚¿ãƒ­ã‚¹: 0ä»¶ âœ…

## è¦³æ¸¬äº‹é …
- 42ç§’é–“ã€æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
- ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å½±éŸ¿ã¯æœ€å°é™
- æ–°ãƒ—ãƒ©ã‚¤ãƒãƒªDBã¸ã®æ¥ç¶šã¯æ­£å¸¸

## æ”¹å–„ç‚¹
- æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’3ç§’â†’5ç§’ã«å»¶é•·ã—ã€ãƒªãƒˆãƒ©ã‚¤æˆåŠŸç‡ã‚’å‘ä¸Š
```

---

**ä½œæˆæ—¥**: 2025-10-19
**é‡è¦åº¦**: â­â­â­
