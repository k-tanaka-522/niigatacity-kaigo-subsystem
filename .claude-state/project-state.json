{
  "project": {
    "name": "新潟市介護保険事業所システム",
    "type": "web-application-cloud-infrastructure",
    "phase": "implementation",
    "created_at": "2025-11-04T00:00:00Z",
    "updated_at": "2025-11-07T00:00:00Z"
  },
  "phases": {
    "planning": {
      "status": "completed",
      "started_at": "2025-11-04T00:00:00Z",
      "completed_at": "2025-11-05T00:00:00Z",
      "document": "docs/00_RFP/"
    },
    "requirements": {
      "status": "completed",
      "started_at": "2025-11-05T00:00:00Z",
      "completed_at": "2025-11-05T12:00:00Z",
      "document": "docs/01_requirements/"
    },
    "design": {
      "status": "completed",
      "started_at": "2025-11-05T12:00:00Z",
      "completed_at": "2025-11-06T00:00:00Z",
      "document": "docs/02_design/basic/"
    },
    "implementation": {
      "status": "in_progress",
      "started_at": "2025-11-06T00:00:00Z",
      "completed_at": null,
      "document": null
    },
    "testing": {
      "status": "pending",
      "started_at": null,
      "completed_at": null,
      "document": null
    },
    "deployment": {
      "status": "pending",
      "started_at": null,
      "completed_at": null,
      "document": null
    }
  },
  "requirements": {
    "business_background": {
      "industry": "public-sector",
      "sector": "healthcare-long-term-care",
      "target_users": "介護保険事業所職員（430事業所、約1,300名）",
      "current_issues": "介護保険事業所向けシステムのクラウド化",
      "compliance": "GCAS（政府情報システムのセキュリティ評価制度）準拠"
    },
    "tech_stack": {
      "cloud": "AWS",
      "iac": "AWS CloudFormation",
      "backend": ".NET Core 9 (C#)",
      "frontend": "Next.js (TypeScript)",
      "database": "Amazon RDS MySQL (Multi-AZ)",
      "compute": "Amazon ECS Fargate",
      "authentication": "Amazon Cognito + MFA",
      "monitoring": "CloudWatch, CloudTrail, AWS Config",
      "cicd": "GitHub Actions"
    },
    "functional_requirements": [
      "ユーザー認証・認可（MFA必須）",
      "申請管理機能",
      "事業所管理機能",
      "ドキュメント管理機能"
    ],
    "non_functional_requirements": {
      "performance": "同時接続100名、応答時間3秒以内",
      "availability": "稼働率99.0%以上、RTO 24時間、RPO 1時間",
      "security": "GCAS準拠、TLS 1.3、保管時暗号化（KMS）、WAF",
      "compliance": "GCAS、プライバシーマーク、ISMS"
    },
    "constraints": {
      "budget": "2億1,000万円（税込）",
      "timeline": "令和9年1月3日まで",
      "region": "東京リージョン（ap-northeast-1）、DR: 大阪リージョン（ap-northeast-3）"
    }
  },
  "team_structure": {
    "infra_team": {
      "responsibility": "インフラ設計・構築・運用",
      "scope": [
        "CloudFormation テンプレート",
        "ネットワーク設計",
        "セキュリティ設計",
        "監視・ロギング設計",
        "バックアップ・DR設計",
        "インフラCI/CD"
      ],
      "documents": "docs/02_設計/インフラ設計/"
    },
    "app_team": {
      "responsibility": "アプリケーション設計・開発・テスト",
      "scope": [
        "フロントエンド (Next.js TypeScript)",
        "バックエンド (.NET Core 9 C#)",
        "データベーススキーマ設計",
        "API設計",
        "アプリCI/CD"
      ],
      "documents": "docs/02_設計/アプリケーション設計/"
    },
    "collaboration": {
      "overall_design": "docs/00_RFP/, docs/01_requirements/ - 両チーム共同レビュー",
      "codeowners": ".github/CODEOWNERS - チーム責任分担の明確化"
    }
  },
  "design": {
    "status": "refactored",
    "architecture": "Multi-Account（AWS Organizations）、ハブ&スポークモデル（Transit Gateway）、コンテナベース（ECS Fargate）",
    "document_structure": {
      "infrastructure": "docs/02_設計/インフラ設計/ - インフラ設計（基本設計 + 詳細設計）",
      "application": "docs/02_設計/アプリケーション設計/ - アプリ設計（基本設計 + 詳細設計）"
    },
    "application_architecture": {
      "ecs_services": {
        "count": 3,
        "services": [
          {
            "name": "provider-backend-service",
            "purpose": "介護事業者用API",
            "tech_stack": ".NET Core 9 (C#)",
            "alb": "Public ALB",
            "access": "インターネット経由"
          },
          {
            "name": "staff-backend-service",
            "purpose": "市職員用API",
            "tech_stack": ".NET Core 9 (C#)",
            "alb": "Internal ALB",
            "access": "庁内のみ（Direct Connect）"
          },
          {
            "name": "batch-service",
            "purpose": "バッチ処理",
            "tech_stack": ".NET Core 9 (C#)",
            "alb": "なし",
            "trigger": "EventBridge"
          }
        ]
      },
      "frontend": {
        "provider": {
          "tech": "Next.js 14 TypeScript (SSG)",
          "hosting": "S3 + CloudFront",
          "access": "インターネット経由"
        },
        "staff": {
          "tech": "Next.js 14 TypeScript (骨格のみ)",
          "hosting": "庁内Webサーバー（スコープ外）",
          "access": "庁内のみ"
        }
      },
      "backend_design": {
        "approach": "統合アプリケーション + 名前空間分離",
        "structure": "Clean Architecture（API/Application/Domain/Infrastructure）",
        "controllers": "Provider/, Staff/, Common/ で論理分離",
        "rationale": "コード共有容易、デプロイ簡単、技術標準適用が一貫"
      },
      "database": {
        "type": "RDS MySQL Multi-AZ（共有）",
        "schema_separation": "kaigo_provider, kaigo_staff, kaigo_common",
        "security": "IAM Policyで分離",
        "note": "GCAS監査で指摘があればRDS分離を検討"
      },
      "security_boundary": {
        "staff_api": "Internal ALB（庁内ネットワークのみ、GCAS準拠）",
        "provider_api": "Public ALB（WAF保護、Cognito MFA認証）"
      }
    },
    "tech_stack": {
      "iac": "AWS CloudFormation",
      "accounts": "4アカウント（本番共通系、本番アプリ系、ステージング共通系、ステージングアプリ系）",
      "network": "Transit Gateway、Direct Connect（100Mbps × 2回線）",
      "compute": "ECS Fargate + ALB（Public ALB: 介護事業者用、Internal ALB: 市職員用）",
      "database": "RDS MySQL Multi-AZ（共有、スキーマレベル分離）",
      "cache": "ElastiCache Redis",
      "storage": "S3 + CloudFront",
      "security": "Cognito + MFA、WAF、KMS",
      "monitoring": "CloudWatch、CloudTrail、AWS Config",
      "backup": "AWS Backup"
    },
    "infrastructure": {
      "account_structure": "マルチアカウント（4アカウント）",
      "network_model": "ハブ&スポークモデル（Transit Gateway）",
      "high_availability": "Multi-AZ（RDS、ALB）、Auto Scaling",
      "disaster_recovery": "Backup & Restore（RTO: 24時間、RPO: 1時間）"
    },
    "cicd_strategy": {
      "tool": "GitHub Actions",
      "deployment_method": "CloudFormation Change Sets（dry-run必須）",
      "environments": ["production", "staging"],
      "monorepo": "app/ と infra/ を1リポジトリで管理、paths フィルターで分離"
    },
    "cloudformation_refactoring": {
      "status": "completed",
      "before": "production/, staging/ に重複テンプレート",
      "after": "stacks/ + templates/ + parameters/ 構成",
      "completed_at": "2025-11-09"
    }
  },
  "implementation": {
    "status": "ready",
    "directory_structure": "docs/, infra/cloudformation/, app/backend/, app/frontend/",
    "coding_standards_applied": true,
    "cloudformation_templates": 14,
    "application_structure": ".NET Core backend + Next.js frontend",
    "blocker": null
  },
  "deployment": {
    "current_state": "all_stacks_deleted",
    "deleted_at": "2025-11-09T22:30:00Z",
    "deleted_stacks": [
      "niigata-kaigo-staging-subnets-stack",
      "niigata-kaigo-staging-vpc-core-stack"
    ],
    "reason": "CloudFormation 構成リファクタリングのためクリーンアップ"
  },
  "next_session": {
    "priority": "high",
    "tasks": [
      "VPC スタックから段階的デプロイ開始（staging環境）",
      "Network スタック（VPC、Subnet、NAT Gateway、Route Table）のデプロイ検証",
      "Security スタック（KMS、Security Groups）のデプロイ検証",
      "Database スタック（RDS MySQL）のデプロイ検証",
      "Compute スタック（ECS、ALB）のデプロイ検証",
      "GitHub Actions CI/CDパイプライン検証",
      "全リソース削除（コスト節約）"
    ],
    "references": [
      "docs/02_設計/基本設計/10_インフラ/10_CloudFormation構成/ - CloudFormation構成設計",
      "infra/cloudformation/ - CloudFormationテンプレート",
      "scripts/ - デプロイスクリプト",
      ".github/workflows/infra-deploy-minimal.yml - CI/CDワークフロー"
    ]
  },
  "metadata": {
    "version": "1.3.0",
    "last_command": "application-architecture-finalized",
    "last_updated_by": "Claude (PM)",
    "last_session_date": "2025-11-09",
    "git_branch": "master",
    "recent_changes": [
      "アプリケーションアーキテクチャ確定（4者協議: インフラArch, アプリArch, Consultant, PM）",
      "ECS構成決定: 3サービス（provider-backend, staff-backend, batch）",
      "セキュリティ境界分離: Internal ALB（市職員用）+ Public ALB（介護事業者用）",
      "バックエンド設計: 統合.NET Coreアプリ + 名前空間分離",
      "フロントエンド設計: Next.js SSG（S3+CloudFront） + 庁内Webサーバー",
      "アプリケーション設計書ディレクトリ構成作成（基本設計/詳細設計）",
      "設計書をチーム別に完全分離（インフラ設計/ と アプリケーション設計/）",
      "CODEOWNERS更新（新しいディレクトリ構造に対応）"
    ],
    "recent_commits": [
      "9f5816a: feat: Add Subnets stack parameters for staging",
      "d61e108: feat: Add minimal infrastructure deployment workflow for testing",
      "1515b8a: fix: Add set +e around describe-stacks to prevent script exit"
    ]
  }
}
