{
  "WebACL": {
    "Name": "kaigo-subsys-prod-waf",
    "Scope": "REGIONAL",
    "DefaultAction": {
      "Allow": {}
    },
    "Description": "WAF Web ACL for kaigo subsystem production environment",
    "Rules": [
      {
        "Name": "RateLimitRule",
        "Priority": 100,
        "Statement": {
          "RateBasedStatement": {
            "Limit": 2000,
            "AggregateKeyType": "IP",
            "ScopeDownStatement": {
              "NotStatement": {
                "Statement": {
                  "IPSetReferenceStatement": {
                    "Arn": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/kaigo-subsys-whitelist/xxxxx"
                  }
                }
              }
            }
          }
        },
        "Action": {
          "Block": {
            "CustomResponse": {
              "ResponseCode": 429,
              "CustomResponseBodyKey": "TooManyRequests"
            }
          }
        },
        "VisibilityConfig": {
          "SampledRequestsEnabled": true,
          "CloudWatchMetricsEnabled": true,
          "MetricName": "RateLimitRule"
        }
      },
      {
        "Name": "GeoBlockRule",
        "Priority": 200,
        "Statement": {
          "NotStatement": {
            "Statement": {
              "GeoMatchStatement": {
                "CountryCodes": [
                  "JP"
                ]
              }
            }
          }
        },
        "Action": {
          "Block": {
            "CustomResponse": {
              "ResponseCode": 403,
              "CustomResponseBodyKey": "GeoBlocked"
            }
          }
        },
        "VisibilityConfig": {
          "SampledRequestsEnabled": true,
          "CloudWatchMetricsEnabled": true,
          "MetricName": "GeoBlockRule"
        }
      },
      {
        "Name": "IPWhitelistRule",
        "Priority": 300,
        "Statement": {
          "IPSetReferenceStatement": {
            "Arn": "arn:aws:wafv2:us-east-1:123456789012:regional/ipset/kaigo-subsys-whitelist/xxxxx"
          }
        },
        "Action": {
          "Allow": {}
        },
        "VisibilityConfig": {
          "SampledRequestsEnabled": true,
          "CloudWatchMetricsEnabled": true,
          "MetricName": "IPWhitelistRule"
        }
      },
      {
        "Name": "AWSManagedRulesCommonRuleSet",
        "Priority": 10,
        "Statement": {
          "ManagedRuleGroupStatement": {
            "VendorName": "AWS",
            "Name": "AWSManagedRulesCommonRuleSet",
            "ExcludedRules": []
          }
        },
        "OverrideAction": {
          "None": {}
        },
        "VisibilityConfig": {
          "SampledRequestsEnabled": true,
          "CloudWatchMetricsEnabled": true,
          "MetricName": "AWSManagedRulesCommonRuleSetMetric"
        }
      },
      {
        "Name": "AWSManagedRulesKnownBadInputsRuleSet",
        "Priority": 20,
        "Statement": {
          "ManagedRuleGroupStatement": {
            "VendorName": "AWS",
            "Name": "AWSManagedRulesKnownBadInputsRuleSet",
            "ExcludedRules": []
          }
        },
        "OverrideAction": {
          "None": {}
        },
        "VisibilityConfig": {
          "SampledRequestsEnabled": true,
          "CloudWatchMetricsEnabled": true,
          "MetricName": "AWSManagedRulesKnownBadInputsRuleSetMetric"
        }
      },
      {
        "Name": "AWSManagedRulesSQLiRuleSet",
        "Priority": 30,
        "Statement": {
          "ManagedRuleGroupStatement": {
            "VendorName": "AWS",
            "Name": "AWSManagedRulesSQLiRuleSet",
            "ExcludedRules": []
          }
        },
        "OverrideAction": {
          "None": {}
        },
        "VisibilityConfig": {
          "SampledRequestsEnabled": true,
          "CloudWatchMetricsEnabled": true,
          "MetricName": "AWSManagedRulesSQLiRuleSetMetric"
        }
      },
      {
        "Name": "AWSManagedRulesLinuxRuleSet",
        "Priority": 40,
        "Statement": {
          "ManagedRuleGroupStatement": {
            "VendorName": "AWS",
            "Name": "AWSManagedRulesLinuxRuleSet",
            "ExcludedRules": []
          }
        },
        "OverrideAction": {
          "None": {}
        },
        "VisibilityConfig": {
          "SampledRequestsEnabled": true,
          "CloudWatchMetricsEnabled": true,
          "MetricName": "AWSManagedRulesLinuxRuleSetMetric"
        }
      },
      {
        "Name": "BlockSuspiciousUserAgents",
        "Priority": 400,
        "Statement": {
          "ByteMatchStatement": {
            "SearchString": "bot|crawler|scanner|nikto|sqlmap",
            "FieldToMatch": {
              "SingleHeader": {
                "Name": "user-agent"
              }
            },
            "TextTransformations": [
              {
                "Priority": 0,
                "Type": "LOWERCASE"
              }
            ],
            "PositionalConstraint": "CONTAINS"
          }
        },
        "Action": {
          "Block": {
            "CustomResponse": {
              "ResponseCode": 403,
              "CustomResponseBodyKey": "BlockedUserAgent"
            }
          }
        },
        "VisibilityConfig": {
          "SampledRequestsEnabled": true,
          "CloudWatchMetricsEnabled": true,
          "MetricName": "BlockSuspiciousUserAgents"
        }
      },
      {
        "Name": "BlockLargeBodies",
        "Priority": 500,
        "Statement": {
          "SizeConstraintStatement": {
            "FieldToMatch": {
              "Body": {}
            },
            "ComparisonOperator": "GT",
            "Size": 8192,
            "TextTransformations": [
              {
                "Priority": 0,
                "Type": "NONE"
              }
            ]
          }
        },
        "Action": {
          "Block": {
            "CustomResponse": {
              "ResponseCode": 413,
              "CustomResponseBodyKey": "PayloadTooLarge"
            }
          }
        },
        "VisibilityConfig": {
          "SampledRequestsEnabled": true,
          "CloudWatchMetricsEnabled": true,
          "MetricName": "BlockLargeBodies"
        }
      }
    ],
    "VisibilityConfig": {
      "SampledRequestsEnabled": true,
      "CloudWatchMetricsEnabled": true,
      "MetricName": "kaigo-subsys-prod-waf"
    },
    "CustomResponseBodies": {
      "TooManyRequests": {
        "ContentType": "APPLICATION_JSON",
        "Content": "{\"error\":\"Too many requests. Please try again later.\"}"
      },
      "GeoBlocked": {
        "ContentType": "APPLICATION_JSON",
        "Content": "{\"error\":\"Access from your location is not allowed.\"}"
      },
      "BlockedUserAgent": {
        "ContentType": "APPLICATION_JSON",
        "Content": "{\"error\":\"Your user agent is not allowed.\"}"
      },
      "PayloadTooLarge": {
        "ContentType": "APPLICATION_JSON",
        "Content": "{\"error\":\"Request payload too large.\"}"
      }
    }
  },
  "IPSet": {
    "Name": "kaigo-subsys-whitelist",
    "Scope": "REGIONAL",
    "Description": "IP whitelist for admin access",
    "IPAddressVersion": "IPV4",
    "Addresses": [
      "203.0.113.0/24",
      "198.51.100.0/24"
    ]
  },
  "LoggingConfiguration": {
    "ResourceArn": "arn:aws:wafv2:us-east-1:123456789012:regional/webacl/kaigo-subsys-prod-waf/xxxxx",
    "LogDestinationConfigs": [
      "arn:aws:s3:::kaigo-subsys-prod-waf-logs"
    ],
    "RedactedFields": [
      {
        "SingleHeader": {
          "Name": "authorization"
        }
      },
      {
        "SingleHeader": {
          "Name": "cookie"
        }
      }
    ],
    "ManagedByFirewallManager": false,
    "LoggingFilter": {
      "DefaultBehavior": "KEEP",
      "Filters": [
        {
          "Behavior": "KEEP",
          "Requirement": "MEETS_ANY",
          "Conditions": [
            {
              "ActionCondition": {
                "Action": "BLOCK"
              }
            },
            {
              "LabelNameCondition": {
                "LabelName": "awswaf:managed:aws:core-rule-set:*"
              }
            }
          ]
        }
      ]
    }
  },
  "CloudWatchAlarms": [
    {
      "AlarmName": "kaigo-subsys-prod-waf-blocked-requests-high",
      "MetricName": "BlockedRequests",
      "Namespace": "AWS/WAFV2",
      "Statistic": "Sum",
      "Period": 300,
      "EvaluationPeriods": 1,
      "Threshold": 100,
      "ComparisonOperator": "GreaterThanThreshold",
      "Dimensions": [
        {
          "Name": "Rule",
          "Value": "ALL"
        },
        {
          "Name": "WebACL",
          "Value": "kaigo-subsys-prod-waf"
        },
        {
          "Name": "Region",
          "Value": "us-east-1"
        }
      ],
      "AlarmActions": [
        "arn:aws:sns:us-east-1:123456789012:kaigo-subsys-prod-security-alerts"
      ],
      "AlarmDescription": "Alert when WAF blocks more than 100 requests in 5 minutes"
    },
    {
      "AlarmName": "kaigo-subsys-prod-waf-rate-limit-triggered",
      "MetricName": "RateLimitRule",
      "Namespace": "AWS/WAFV2",
      "Statistic": "Sum",
      "Period": 300,
      "EvaluationPeriods": 1,
      "Threshold": 10,
      "ComparisonOperator": "GreaterThanThreshold",
      "Dimensions": [
        {
          "Name": "Rule",
          "Value": "RateLimitRule"
        },
        {
          "Name": "WebACL",
          "Value": "kaigo-subsys-prod-waf"
        },
        {
          "Name": "Region",
          "Value": "us-east-1"
        }
      ],
      "AlarmActions": [
        "arn:aws:sns:us-east-1:123456789012:kaigo-subsys-prod-security-alerts"
      ],
      "AlarmDescription": "Alert when rate limit rule is triggered more than 10 times in 5 minutes"
    }
  ],
  "StagingWebACL": {
    "Name": "kaigo-subsys-stg-waf",
    "Scope": "REGIONAL",
    "DefaultAction": {
      "Allow": {}
    },
    "Description": "WAF Web ACL for kaigo subsystem staging environment",
    "Rules": [
      {
        "Name": "RateLimitRule",
        "Priority": 100,
        "Statement": {
          "RateBasedStatement": {
            "Limit": 5000,
            "AggregateKeyType": "IP"
          }
        },
        "Action": {
          "Block": {}
        },
        "VisibilityConfig": {
          "SampledRequestsEnabled": true,
          "CloudWatchMetricsEnabled": true,
          "MetricName": "RateLimitRule"
        }
      },
      {
        "Name": "AWSManagedRulesCommonRuleSet",
        "Priority": 10,
        "Statement": {
          "ManagedRuleGroupStatement": {
            "VendorName": "AWS",
            "Name": "AWSManagedRulesCommonRuleSet",
            "ExcludedRules": []
          }
        },
        "OverrideAction": {
          "Count": {}
        },
        "VisibilityConfig": {
          "SampledRequestsEnabled": true,
          "CloudWatchMetricsEnabled": true,
          "MetricName": "AWSManagedRulesCommonRuleSetMetric"
        }
      }
    ],
    "VisibilityConfig": {
      "SampledRequestsEnabled": true,
      "CloudWatchMetricsEnabled": true,
      "MetricName": "kaigo-subsys-stg-waf"
    }
  }
}
