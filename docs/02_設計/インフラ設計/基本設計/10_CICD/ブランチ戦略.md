# ブランチ戦略

## 目的
新潟市介護保険事業所システムのGitブランチ戦略を定義し、チーム開発の効率化と品質管理を実現する。

## 影響範囲
- 開発チーム全体のワークフロー
- CI/CDパイプラインの実行条件
- デプロイメント戦略

## 前提条件
- GitHubをリポジトリとして使用
- GitHub Actionsを使用したCI/CD
- 本番環境とステージング環境の2環境構成

---

## ブランチモデル: Git-Flow（簡略版）

### 長期ブランチ

| ブランチ名 | 役割 | 保護設定 | デプロイ先 |
|----------|------|---------|----------|
| `main` | 本番リリース用 | ✅ 保護あり<br>- プルリクエスト必須<br>- レビュー承認必須<br>- CI通過必須<br>- 直接プッシュ禁止 | 本番環境 |
| `develop` | ステージング統合用 | ✅ 保護あり<br>- プルリクエスト必須<br>- CI通過必須 | ステージング環境 |

### 短期ブランチ

| ブランチ名 | 役割 | 派生元 | マージ先 | 命名規則 | 例 |
|----------|------|-------|---------|---------|---|
| `feature/*` | 新機能開発 | `develop` | `develop` | `feature/{機能名}` | `feature/user-authentication` |
| `bugfix/*` | ステージングのバグ修正 | `develop` | `develop` | `bugfix/{修正内容}` | `bugfix/login-error` |
| `hotfix/*` | 本番緊急修正 | `main` | `main` + `develop` | `hotfix/{修正内容}` | `hotfix/security-patch` |
| `infra/*` | インフラ変更（CloudFormation） | `develop` | `develop` | `infra/{変更内容}` | `infra/add-rds-replica` |

---

## ワークフロー

### 1. 新機能開発（feature）

```bash
# 1. developから派生
git checkout develop
git pull origin develop
git checkout -b feature/user-authentication

# 2. 機能開発
git add .
git commit -m "feat: add user authentication"

# 3. プッシュ
git push origin feature/user-authentication

# 4. プルリクエスト作成（GitHub UI）
#    - Base: develop
#    - Compare: feature/user-authentication
#    - レビュー依頼

# 5. CI通過・レビュー承認後にマージ
#    - マージ方法: Squash and merge（推奨）
```

### 2. バグ修正（bugfix）

```bash
# 1. developから派生
git checkout develop
git pull origin develop
git checkout -b bugfix/login-error

# 2. 修正
git add .
git commit -m "fix: resolve login error"

# 3. プッシュ・プルリクエスト
git push origin bugfix/login-error

# 4. マージ
#    - Base: develop
#    - マージ方法: Squash and merge
```

### 3. 本番緊急修正（hotfix）

```bash
# 1. mainから派生
git checkout main
git pull origin main
git checkout -b hotfix/security-patch

# 2. 修正
git add .
git commit -m "fix: apply security patch"

# 3. プッシュ・プルリクエスト
git push origin hotfix/security-patch

# 4. mainへマージ
#    - Base: main
#    - レビュー承認必須
#    - マージ方法: Merge commit（履歴を残す）

# 5. developへもマージ（同期）
git checkout develop
git pull origin develop
git merge hotfix/security-patch
git push origin develop

# 6. hotfixブランチ削除
git branch -d hotfix/security-patch
```

### 4. インフラ変更（infra）

```bash
# 1. developから派生
git checkout develop
git pull origin develop
git checkout -b infra/add-rds-replica

# 2. CloudFormationテンプレート変更
git add infra/cloudformation/
git commit -m "infra: add RDS read replica"

# 3. プッシュ・プルリクエスト
git push origin infra/add-rds-replica

# 4. CI（cfn-lint）通過後、レビュー・マージ
#    - Base: develop
#    - マージ方法: Squash and merge
```

---

## コミットメッセージ規約

### フォーマット: Conventional Commits

```
<type>(<scope>): <subject>

<body>（オプション）

<footer>（オプション）
```

### Type（種類）

| Type | 説明 | 例 |
|------|------|---|
| `feat` | 新機能追加 | `feat(auth): add MFA support` |
| `fix` | バグ修正 | `fix(login): resolve token expiration` |
| `infra` | インフラ変更 | `infra(rds): add Multi-AZ` |
| `docs` | ドキュメント変更 | `docs(readme): update setup guide` |
| `test` | テスト追加・修正 | `test(auth): add unit tests` |
| `refactor` | リファクタリング | `refactor(api): simplify error handling` |
| `style` | コードスタイル変更 | `style(frontend): fix ESLint warnings` |
| `chore` | ビルド・設定変更 | `chore(deps): update dependencies` |

### Scope（範囲）- オプション

| Scope | 説明 |
|-------|------|
| `auth` | 認証関連 |
| `api` | API関連 |
| `frontend` | フロントエンド |
| `backend` | バックエンド |
| `infra` | インフラ |
| `db` | データベース |

### 例

```bash
# 良い例
git commit -m "feat(auth): add Cognito MFA integration"
git commit -m "fix(api): resolve 500 error on user creation"
git commit -m "infra(ecs): update task definition to use Fargate Spot"

# 悪い例（避ける）
git commit -m "update"
git commit -m "fix bug"
git commit -m "WIP"
```

---

## プルリクエスト（PR）テンプレート

### PR作成時の必須項目

```markdown
## 概要
<!-- この変更の目的・背景 -->

## 変更内容
<!-- 具体的な変更内容 -->
- [ ] 機能追加
- [ ] バグ修正
- [ ] リファクタリング
- [ ] インフラ変更

## テスト
<!-- テスト方法・結果 -->
- [ ] ユニットテスト追加
- [ ] 統合テスト実施
- [ ] 手動テスト実施

## チェックリスト
- [ ] CI通過
- [ ] コーディング規約準拠
- [ ] ドキュメント更新
- [ ] レビュー依頼完了

## 関連Issue
<!-- Issueへのリンク（該当する場合） -->
Closes #123
```

---

## ブランチ保護ルール

### main ブランチ

```yaml
保護設定:
  - ✅ プルリクエストを必須にする
    - 必要な承認レビュー数: 1名以上
  - ✅ ステータスチェック必須
    - frontend-test
    - backend-test
    - infra-validate
  - ✅ 直接プッシュ禁止
  - ✅ force push 禁止
  - ✅ ブランチ削除禁止
  - ✅ レビュー承認後の新規プッシュ時、再承認必須
```

### develop ブランチ

```yaml
保護設定:
  - ✅ プルリクエストを必須にする
    - 必要な承認レビュー数: 1名以上（推奨）
  - ✅ ステータスチェック必須
    - frontend-test
    - backend-test
    - infra-validate
  - ✅ 直接プッシュ禁止（推奨）
  - ✅ force push 禁止
```

---

## リリースフロー

### ステージング環境へのデプロイ

```
feature/*, bugfix/*, infra/* → develop へマージ
  ↓
GitHub Actions: develop ブランチへの push をトリガー
  ↓
ステージング環境へ自動デプロイ
```

### 本番環境へのデプロイ

```
develop → main へプルリクエスト
  ↓
レビュー・承認
  ↓
main へマージ
  ↓
GitHub Actions: main ブランチへの push をトリガー
  ↓
本番環境へデプロイ（手動承認ゲート付き）
```

---

## ブランチのライフサイクル管理

### 定期的なクリーンアップ

```bash
# マージ済みブランチの削除（ローカル）
git branch --merged develop | grep -v "^\*\|main\|develop" | xargs git branch -d

# リモートのマージ済みブランチ削除
# → GitHub UI で自動削除設定を有効化（推奨）
# Settings > General > Pull Requests
# ✅ Automatically delete head branches
```

### Stale ブランチの管理

- 60日以上更新がないブランチは削除対象
- 削除前にブランチオーナーに通知

---

## トラブルシューティング

### コンフリクト解決

```bash
# developの最新を取り込む
git checkout feature/my-feature
git fetch origin
git rebase origin/develop

# コンフリクト解決
git add <resolved-files>
git rebase --continue

# プッシュ（force push必要）
git push origin feature/my-feature --force-with-lease
```

### 誤ったコミットの取り消し

```bash
# 最新コミットを取り消し（コミット前に戻る）
git reset --soft HEAD~1

# 最新コミットを修正
git commit --amend

# プッシュ済みコミットを取り消す場合（revert推奨）
git revert <commit-hash>
git push origin <branch-name>
```

---

## 参照

- `.claude/docs/40_standards/46_git.md` - Git運用標準
- `docs/02_設計/基本設計/10_CICD/GitHub_Actions設計.md` - CI/CD設計
- [Conventional Commits](https://www.conventionalcommits.org/)
- [Git-Flow](https://nvie.com/posts/a-successful-git-branching-model/)

---

**作成日**: 2025-11-07
**作成者**: Claude (architect サブエージェント)
**レビュー状態**: Draft
