# 新潟市介護保険事業所システム - AWS基本設計書

## 設計概要

### プロジェクト情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | 新潟市介護保険事業所システム - AWSインフラ構築 |
| 目的 | 介護保険事業所向けWebアプリケーションのクラウド化（AWS） |
| 対象環境 | 本番環境、ステージング環境 |
| 対象利用者数 | 約1,300名（430事業所） |
| リージョン | 東京リージョン（ap-northeast-1） |
| DR リージョン | 大阪リージョン（ap-northeast-3） |
| コンプライアンス | GCAS（政府情報システムのためのセキュリティ評価制度）準拠 |

---

## 設計方針

### 基本方針

1. **GCAS準拠**: 政府情報システムのセキュリティ基準に準拠
2. **高可用性**: Multi-AZ構成、Auto Scaling
3. **セキュリティ**: 多層防御、暗号化（保管時・転送時）
4. **運用自動化**: AWS Backup、CloudWatch監視、自動スケーリング
5. **コスト最適化**: ステージング環境でT系インスタンス使用
6. **災害対策**: Backup & Restore（RTO: 24時間、RPO: 1時間）

### アーキテクチャパターン

- **コンピューティング**: コンテナベース（ECS Fargate）
- **アカウント構成**: マルチアカウント（AWS Organizations）
- **ネットワーク**: ハブ＆スポークモデル（Transit Gateway）
- **データベース**: マネージドサービス（RDS MySQL Multi-AZ）
- **デプロイ**: IaC（AWS CloudFormation）

---

## 技術スタック

### IaC（Infrastructure as Code）

| 項目 | 採用技術 | ADR |
|------|---------|-----|
| IaC ツール | AWS CloudFormation | [ADR-001](#adr-001-aws-cloudformationの採用) |

### アカウント構成

| 項目 | 採用技術 | ADR |
|------|---------|-----|
| アカウント管理 | AWS Organizations | [ADR-002](#adr-002-aws-organizationsによるマルチアカウント管理) |
| アカウント数 | 4アカウント（本番共通系、本番アプリ系、ステージング共通系、ステージングアプリ系） | [ADR-003](#adr-003-4アカウント構成の採用) |

### ネットワーク

| 項目 | 採用技術 | ADR |
|------|---------|-----|
| アカウント間接続 | AWS Transit Gateway | [ADR-004](#adr-004-transit-gatewayの採用) |
| オンプレミス接続 | AWS Direct Connect（100Mbps × 2回線） | [ADR-005](#adr-005-direct-connectの採用) |
| DNS | Amazon Route 53（内部DNS） | [ADR-006](#adr-006-route-53の採用) |

### コンピューティング

| 項目 | 採用技術 | ADR |
|------|---------|-----|
| コンテナオーケストレーション | Amazon ECS Fargate | [ADR-007](#adr-007-ecs-fargateの採用) |
| ロードバランサー | Application Load Balancer | [ADR-008](#adr-008-albの採用) |

### データベース・キャッシュ

| 項目 | 採用技術 | ADR |
|------|---------|-----|
| データベース | Amazon RDS MySQL（本番: Multi-AZ、ステージング: Single-AZ） | [ADR-009](#adr-009-rds-mysqlの採用) |
| キャッシュ | Amazon ElastiCache Redis | [ADR-010](#adr-010-elasticache-redisの採用) |

### ストレージ・CDN

| 項目 | 採用技術 | ADR |
|------|---------|-----|
| オブジェクトストレージ | Amazon S3 | [ADR-011](#adr-011-s3の採用) |
| CDN | Amazon CloudFront | [ADR-012](#adr-012-cloudfrontの採用) |

### セキュリティ

| 項目 | 採用技術 | ADR |
|------|---------|-----|
| 認証 | Amazon Cognito + MFA | [ADR-013](#adr-013-cognitoの採用) |
| WAF | AWS WAF | [ADR-014](#adr-014-aws-wafの採用) |
| 暗号化 | AWS KMS | [ADR-015](#adr-015-aws-kmsの採用) |

### 監視・ログ

| 項目 | 採用技術 | ADR |
|------|---------|-----|
| 監視 | Amazon CloudWatch | [ADR-016](#adr-016-cloudwatchの採用) |
| ログ集約 | CloudWatch Logs | [ADR-017](#adr-017-cloudwatch-logsの採用) |
| 監査ログ | AWS CloudTrail | [ADR-018](#adr-018-cloudtrailの採用) |
| 構成変更履歴 | AWS Config | [ADR-019](#adr-019-aws-configの採用) |

### バックアップ

| 項目 | 採用技術 | ADR |
|------|---------|-----|
| バックアップ管理 | AWS Backup | [ADR-020](#adr-020-aws-backupの採用) |

---

## ADR（Architecture Decision Record）

### ADR-001: AWS CloudFormationの採用

**ステータス**: 採用

**コンテキスト**:
- AWS専用のインフラ構築プロジェクト
- IaCツールの選定が必要
- チームのAWS習熟度は中程度

**決定**: AWS CloudFormationを採用

**理由**:
1. **AWS ネイティブ**: AWSの全サービスを最速でサポート
2. **Change Sets**: デプロイ前のdry-run機能（必須要件）
3. **コスト**: 追加料金不要
4. **運用**: AWS公式サポート
5. **GCASガイドライン**: 政府系システムで実績多数

**代替案**:
- **Terraform**: マルチクラウド対応だが、AWS専用プロジェクトでは過剰
- **AWS CDK**: TypeScript/Python等でのコード化が可能だが、チーム習熟度が不足

**結果**: CloudFormationを採用し、テンプレートをファイル分割3原則に基づいて管理

---

### ADR-002: AWS Organizationsによるマルチアカウント管理

**ステータス**: 採用

**コンテキスト**:
- GCAS準拠が必須
- 本番環境とステージング環境の完全分離が必要
- セキュリティポリシーの一元管理が必要

**決定**: AWS Organizationsを採用

**理由**:
1. **GCAS準拠**: 政府情報システムの推奨構成
2. **アカウント分離**: 環境間の完全な分離
3. **SCP（Service Control Policies）**: アカウント横断のセキュリティポリシー
4. **一括請求**: コスト管理の簡素化

**代替案**:
- **単一アカウント**: セキュリティリスクが高く、GCAS準拠が困難

**結果**: AWS Organizationsで4アカウント構成を実現

---

### ADR-003: 4アカウント構成の採用

**ステータス**: 採用

**コンテキスト**:
- 本番環境とステージング環境が必要
- 共通インフラ（ネットワーク、ログ）とアプリケーションリソースの分離が望ましい
- GCASガイドラインでマルチアカウント構成が推奨されている

**決定**: 4アカウント構成
- 本番共通系アカウント
- 本番アプリ系アカウント
- ステージング共通系アカウント
- ステージングアプリ系アカウント

**理由**:
1. **責務分離**: ネットワーク管理者とアプリケーション開発者の権限分離
2. **爆発半径の最小化**: 障害・セキュリティ侵害の影響範囲を限定
3. **GCASガイドライン準拠**: 政府情報システムの推奨パターン
4. **監査ログの分離**: 共通系アカウントでログ集約

**代替案**:
- **2アカウント構成（本番・ステージング）**: 共通インフラとアプリの分離ができない
- **6アカウント以上**: 運用が複雑化し、このプロジェクト規模では過剰

**結果**: 4アカウント構成を採用し、Transit Gatewayで接続

---

### ADR-004: Transit Gatewayの採用

**ステータス**: 採用

**コンテキスト**:
- 4つのアカウント間で通信が必要
- Direct Connectを複数VPCで共有したい
- 将来的なアカウント追加の可能性

**決定**: AWS Transit Gatewayを採用

**理由**:
1. **ハブ&スポークモデル**: VPCピアリングの複雑さを回避
2. **Direct Connect共有**: 複数VPCで1つのDirect Connect接続を共有
3. **スケーラビリティ**: アカウント追加が容易
4. **ルーティング管理**: ルートテーブルで柔軟な制御

**代替案**:
- **VPCピアリング**: 4アカウント間のフルメッシュ接続（6本）で複雑化
- **VPN**: 性能・可用性が不足

**結果**: Transit Gatewayをハブとして4アカウントのVPCを接続

---

### ADR-005: Direct Connectの採用

**ステータス**: 採用

**コンテキスト**:
- 新潟市庁舎から安定した接続が必要
- インターネットVPNでは帯域・安定性が不足

**決定**: AWS Direct Connect（100Mbps × 2回線）

**理由**:
1. **専用線**: 安定した通信品質
2. **冗長化**: 2回線で高可用性を確保
3. **セキュリティ**: インターネットを経由しない
4. **帯域保証**: 100Mbpsを保証

**代替案**:
- **Site-to-Site VPN**: 帯域・安定性が不足
- **インターネット経由（HTTPS）**: セキュリティリスク、庁舎からの要件を満たさない

**結果**: Direct Connect 2回線でTransit Gatewayに接続

---

### ADR-006: Route 53の採用

**ステータス**: 採用

**コンテキスト**:
- 内部DNSが必要
- 将来的なDRフェイルオーバーを考慮

**決定**: Amazon Route 53（Private Hosted Zone）

**理由**:
1. **マネージドサービス**: 運用負荷の軽減
2. **高可用性**: 100% SLA
3. **DRフェイルオーバー**: Health Checkによる自動切り替え
4. **統合**: AWSサービスとの統合が容易

**代替案**:
- **BIND等のDNSサーバー**: 運用負荷が高い
- **Direct Connect経由で庁舎DNS**: レイテンシ増加、DR時の問題

**結果**: Route 53 Private Hosted Zoneで内部DNS構築

---

### ADR-007: ECS Fargateの採用

**ステータス**: 採用

**コンテキスト**:
- コンテナベースのアプリケーション実行環境が必要
- サーバー管理の負荷を軽減したい

**決定**: Amazon ECS Fargate

**理由**:
1. **サーバーレス**: EC2インスタンス管理不要
2. **スケーリング**: タスク単位でのオートスケーリング
3. **セキュリティパッチ**: AWS側でインフラ管理
4. **コスト**: 利用時間のみ課金

**代替案**:
- **ECS on EC2**: サーバー管理が必要
- **EKS**: Kubernetes習熟度が不足、このプロジェクト規模では過剰
- **Lambda**: Webアプリケーションの長時間実行には不向き

**結果**: ECS Fargateを採用し、サーバー管理を削減

---

### ADR-008: ALBの採用

**ステータス**: 採用

**コンテキスト**:
- HTTPS終端が必要
- 複数のECSタスクへの負荷分散

**決定**: Application Load Balancer（ALB）

**理由**:
1. **レイヤー7ロードバランサー**: HTTPSルーティング
2. **SSL/TLS終端**: ACM証明書の自動管理
3. **ヘルスチェック**: 障害タスクの自動除外
4. **WAF統合**: AWS WAFとの統合

**代替案**:
- **NLB**: レイヤー4、HTTPS終端不可
- **Classic LB**: 旧世代、非推奨

**結果**: ALBを採用し、HTTPS終端とルーティングを実現

---

### ADR-009: RDS MySQLの採用

**ステータス**: 採用

**コンテキスト**:
- トランザクション整合性が必須
- 既存システムでMySQLの実績あり

**決定**: Amazon RDS MySQL（本番: Multi-AZ、ステージング: Single-AZ）

**理由**:
1. **マネージドサービス**: バックアップ、パッチ適用の自動化
2. **Multi-AZ**: 高可用性（自動フェイルオーバー）
3. **ACID保証**: トランザクション整合性
4. **互換性**: 既存システムのMySQL資産を活用

**代替案**:
- **Aurora MySQL**: 性能は優れるが、コストが高い（このプロジェクト規模では過剰）
- **DynamoDB**: ACID保証なし、トランザクション要件を満たさない

**結果**: RDS MySQL Multi-AZを採用

---

### ADR-010: ElastiCache Redisの採用

**ステータス**: 採用

**コンテキスト**:
- セッション管理が必要
- 頻繁にアクセスするデータのキャッシュ

**決定**: Amazon ElastiCache Redis

**理由**:
1. **マネージドサービス**: パッチ適用、バックアップの自動化
2. **高速**: インメモリキャッシュ
3. **永続化**: RDB/AOFによるデータ永続化
4. **セッション管理**: 複数ECSタスク間でのセッション共有

**代替案**:
- **Memcached**: 永続化なし、セッション管理に不向き
- **DynamoDB**: レイテンシがRedisより高い

**結果**: ElastiCache Redisを採用

---

### ADR-011: S3の採用

**ステータス**: 採用

**コンテキスト**:
- ドキュメントファイルの保管が必要
- バックアップデータの保管

**決定**: Amazon S3

**理由**:
1. **耐久性**: 99.999999999%（イレブンナイン）
2. **暗号化**: SSE-KMS
3. **ライフサイクル管理**: 古いファイルの自動削除・アーカイブ
4. **バージョニング**: 誤削除対策

**代替案**:
- **EFS**: コストが高い、オブジェクトストレージの要件に過剰
- **EBS**: 単一インスタンスからのみアクセス可能

**結果**: S3を採用し、ドキュメント保管とバックアップを実現

---

### ADR-012: CloudFrontの採用

**ステータス**: 採用

**コンテキスト**:
- 静的コンテンツ（CSS、JavaScript、画像）の配信
- ユーザーからのレイテンシ削減

**決定**: Amazon CloudFront

**理由**:
1. **CDN**: エッジロケーションからの配信
2. **S3統合**: S3バケットとの統合が容易
3. **キャッシュ**: 静的コンテンツのキャッシュ
4. **DDoS対策**: AWS Shield Standardが自動適用

**代替案**:
- **S3直接配信**: レイテンシが高い、キャッシュなし
- **サードパーティCDN**: 追加コスト、AWS統合が弱い

**結果**: CloudFrontを採用し、S3と統合

---

### ADR-013: Cognitoの採用

**ステータス**: 採用

**コンテキスト**:
- ユーザー認証が必要
- MFA（多要素認証）が必須（GCAS要件）

**決定**: Amazon Cognito + MFA

**理由**:
1. **マネージドサービス**: 認証機能の実装不要
2. **MFA対応**: TOTP、SMS認証に対応
3. **ユーザープール**: ユーザー管理機能
4. **JWT**: アプリケーションとの統合が容易

**代替案**:
- **自前実装**: セキュリティリスク、開発コスト増
- **Keycloak**: 運用負荷が高い

**結果**: Cognito User PoolでMFA必須認証を実現

---

### ADR-014: AWS WAFの採用

**ステータス**: 採用

**コンテキスト**:
- Webアプリケーションの保護が必要
- OWASP Top 10対策が必要

**決定**: AWS WAF

**理由**:
1. **ALB統合**: ALBと統合が容易
2. **マネージドルール**: AWS Managed Rules（OWASP Top 10対策）
3. **カスタムルール**: 独自のルール追加が可能
4. **ログ**: WAFログをCloudWatch Logsに出力

**代替案**:
- **サードパーティWAF**: 追加コスト、AWS統合が弱い
- **WAFなし**: セキュリティリスク、GCAS要件を満たさない

**結果**: AWS WAFをALBに適用

---

### ADR-015: AWS KMSの採用

**ステータス**: 採用

**コンテキスト**:
- データの暗号化が必須（GCAS要件）
- 保管時・転送時の暗号化

**決定**: AWS KMS（Key Management Service）

**理由**:
1. **マネージドサービス**: キー管理の自動化
2. **統合**: RDS、S3、EBS等との統合が容易
3. **監査**: CloudTrailでキー使用履歴を記録
4. **FIPS 140-2**: 暗号化モジュールの認証取得

**代替案**:
- **自前キー管理**: セキュリティリスク、運用負荷増
- **CloudHSM**: コストが高い、このプロジェクト規模では過剰

**結果**: KMSで全サービスの暗号化キー管理

---

### ADR-016: CloudWatchの採用

**ステータス**: 採用

**コンテキスト**:
- メトリクス監視が必要
- アラート通知が必要

**決定**: Amazon CloudWatch

**理由**:
1. **AWSネイティブ**: すべてのAWSサービスのメトリクスを収集
2. **アラーム**: 閾値超過時の自動通知
3. **ダッシュボード**: 可視化
4. **カスタムメトリクス**: アプリケーションメトリクスの送信

**代替案**:
- **Datadog**: 追加コスト、AWS統合はCloudWatchで十分
- **Prometheus**: 運用負荷が高い

**結果**: CloudWatchでメトリクス監視とアラートを実現

---

### ADR-017: CloudWatch Logsの採用

**ステータス**: 採用

**コンテキスト**:
- ログ集約が必要
- ログ保持期間90日間（要件）

**決定**: CloudWatch Logs

**理由**:
1. **集約**: アプリケーション、ALB、VPC Flow Logs等を集約
2. **保持期間**: ログの保持期間設定が可能
3. **検索**: Logs Insightsで検索・分析
4. **統合**: Lambda、SNS等との統合

**代替案**:
- **S3直接出力**: リアルタイム検索ができない
- **Elasticsearch**: コストが高い、このプロジェクト規模では過剰

**結果**: CloudWatch Logsでログ集約

---

### ADR-018: CloudTrailの採用

**ステータス**: 採用

**コンテキスト**:
- AWS API操作の監査ログが必須（GCAS要件）
- 全アカウントでのログ記録

**決定**: AWS CloudTrail（全アカウント有効）

**理由**:
1. **GCAS必須要件**: すべてのAPI操作を記録
2. **Organizations統合**: 全アカウントのログを共通系アカウントに集約
3. **不変性**: ログの改ざん防止
4. **長期保存**: S3に保存

**代替案**:
- **CloudTrailなし**: GCAS要件を満たさない

**結果**: CloudTrailを全アカウントで有効化し、共通系アカウントに集約

---

### ADR-019: AWS Configの採用

**ステータス**: 採用

**コンテキスト**:
- AWS リソースの構成変更履歴が必要
- コンプライアンス確認が必要（GCAS要件）

**決定**: AWS Config

**理由**:
1. **構成変更履歴**: すべてのリソースの変更を記録
2. **コンプライアンス**: Config Rulesでコンプライアンス確認
3. **Organizations統合**: 全アカウントの構成を集約
4. **CloudTrail連携**: API操作と構成変更の相関分析

**代替案**:
- **AWS Configなし**: コンプライアンス確認が困難

**結果**: AWS Configを全アカウントで有効化

---

### ADR-020: AWS Backupの採用

**ステータス**: 採用

**コンテキスト**:
- バックアップの一元管理が必要
- RPO: 1時間以内（要件）

**決定**: AWS Backup

**理由**:
1. **一元管理**: RDS、S3等のバックアップを一元管理
2. **スケジュール**: 自動バックアップスケジュール
3. **クロスリージョン**: 大阪リージョンへのコピー
4. **ライフサイクル**: 古いバックアップの自動削除

**代替案**:
- **個別サービスのバックアップ**: 管理が煩雑
- **スナップショット手動取得**: 自動化されていない

**結果**: AWS Backupで一元的なバックアップ管理

---

## 設計書の構成

### 基本設計書（このディレクトリ）

| 項番 | ドキュメント | 概要 |
|-----|------------|------|
| 01 | [01_overview](../01_overview/) | 設計概要、方針、ADR一覧（このドキュメント） |
| 02 | [02_account_structure](../02_account_structure/) | アカウント設計、SCP |
| 03 | [03_network](../03_network/) | ネットワーク設計、VPC、Transit Gateway |
| 04 | [04_compute](../04_compute/) | ECS、ALB |
| 05 | [05_database](../05_database/) | RDS、ElastiCache |
| 06 | [06_storage](../06_storage/) | S3、CloudFront |
| 07 | [07_security](../07_security/) | IAM、WAF、KMS、Cognito |
| 08 | [08_monitoring](../08_monitoring/) | CloudWatch、CloudTrail、AWS Config |
| 09 | [09_backup_dr](../09_backup_dr/) | AWS Backup、DR手順 |
| 10 | [10_architecture_diagrams](../10_architecture_diagrams/) | 全体構成図、ネットワーク図、データフロー図 |

### 詳細設計書

詳細設計書は、`docs/02_design/detailed/` に配置されています。

---

## 非機能要件への対応

### 性能要件

| 要件 | 目標値 | 実現方法 |
|------|--------|---------|
| 同時接続ユーザー数 | 100名 | ECS Auto Scaling（CPU/メモリベース） |
| 応答時間（画面表示） | 3秒以内 | CloudFront + ElastiCache |
| 応答時間（API） | 1秒以内 | ElastiCache Redis |
| データベースクエリ | 500ms以内 | RDSインデックス設計、RDS Performance Insights監視 |

### 可用性要件

| 要件 | 目標値 | 実現方法 |
|------|--------|---------|
| 稼働率 | 99.0%以上 | Multi-AZ（RDS、ALB）、ECS Auto Scaling |
| RTO（復旧時間目標） | 24時間以内 | Backup & Restore（CloudFormation + RDSスナップショット） |
| RPO（復旧ポイント目標） | 1時間以内 | RDS自動バックアップ（1時間間隔） |

### セキュリティ要件

| 要件 | 実現方法 |
|------|---------|
| 認証 | Amazon Cognito + MFA必須 |
| 通信暗号化 | TLS 1.3（外部）、TLS 1.2以上（内部） |
| 保管時暗号化 | AWS KMS（RDS、S3、EBS） |
| WAF | AWS WAF（OWASP Top 10対策） |
| 監査ログ | CloudTrail（全アカウント有効） |

---

## 次のステップ

1. **アカウント設計を確認**: [02_account_structure](../02_account_structure/)
2. **ネットワーク設計を確認**: [03_network](../03_network/)
3. **全体構成図を確認**: [10_architecture_diagrams](../10_architecture_diagrams/)

---

## 参照した技術標準

- `.claude/docs/40_standards/45_cloudformation.md` - CloudFormation規約
- `.claude/docs/40_standards/49_security.md` - セキュリティ・運用基準
- GCAS Guidelines: https://guide.gcas.cloud.go.jp/aws/description-of-account-structure

---

**作成日**: 2025-11-05
**レビュー状態**: Draft
**承認者**: 未定
