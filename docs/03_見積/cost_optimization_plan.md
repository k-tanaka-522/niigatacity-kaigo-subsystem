# コスト最適化計画

## 文書管理情報

| 項目 | 内容 |
|------|------|
| 文書名 | コスト最適化計画 |
| バージョン | 1.0 |
| 作成日 | 2025-11-05 |
| 最終更新日 | 2025-11-05 |
| ステータス | Draft |

---

## 1. エグゼクティブサマリー

### 1.1 最適化目標

| 期間 | 削減目標 | 削減額（年間） |
|------|---------|--------------|
| 1年目 | 3%削減 | ¥280,000 |
| 2年目 | 12%削減 | ¥1,258,000 |
| 3年目 | 19%削減 | ¥1,958,000 |
| 4年目以降 | 23%削減 | ¥2,458,000 |

### 1.2 現状コスト（最適化前）

- **月額**: $5,810（¥871,500）
- **年額**: $69,720（¥10,458,000）

### 1.3 最適化後コスト（4年目以降）

- **月額**: $4,473（¥670,950）
- **年額**: $53,676（¥8,000,000）
- **削減額**: $16,044/年（¥2,458,000/年）

---

## 2. フェーズ別最適化計画

### 2.1 フェーズ1: 即時実施（0〜3ヶ月）

#### 施策1-1: S3ライフサイクルポリシー最適化

**概要**: S3オブジェクトを適切なストレージクラスに自動移行

**実施内容**:
```yaml
LifecyclePolicy:
  Rules:
    - Id: "TransitionToIA"
      Status: Enabled
      Transitions:
        - Days: 30
          StorageClass: STANDARD_IA
    - Id: "TransitionToGlacier"
      Status: Enabled
      Transitions:
        - Days: 90
          StorageClass: GLACIER
    - Id: "ExpireOldVersions"
      Status: Enabled
      NoncurrentVersionExpiration:
        NoncurrentDays: 90
```

**削減額**:
- **月額**: $2.50
- **年額**: ¥30,000

**難易度**: 低
**実施時期**: 即時

---

#### 施策1-2: ステージング環境の夜間・休日停止

**概要**: ステージング環境を平日10時間のみ稼働

**実施内容**:
- ECS タスク: EventBridge Schedulerで自動起動・停止
- RDS: 手動停止（起動時のみ手動起動）
- CloudWatch Events: Lambda関数で自動制御

**停止スケジュール**:
- **起動**: 平日 9:00
- **停止**: 平日 19:00
- **休日**: 終日停止

**削減額**:
- **ECS Fargate**: $17 → $5（月額）削減額: $12/月
- **RDS**: $72 → $22（月額）削減額: $50/月
- **合計月額**: $62
- **年額**: ¥111,600

**注**: すでに想定に含まれているため、追加削減効果なし

**難易度**: 中
**実施時期**: 3ヶ月後

---

#### 施策1-3: CloudWatch Logs保持期間の最適化

**概要**: ログ保持期間を用途別に最適化

**実施内容**:
| ログタイプ | 現行保持期間 | 最適化後保持期間 |
|----------|------------|----------------|
| アプリケーションログ | 90日 | 30日 |
| VPC Flow Logs | 90日 | 30日 |
| ECS タスクログ | 90日 | 14日 |
| Lambda ログ | 90日 | 7日 |
| CloudTrail（監査ログ） | 無期限（S3） | 無期限（S3）変更なし |

**削減額**:
- **月額**: $20
- **年額**: ¥36,000

**難易度**: 低
**実施時期**: 即時

---

#### フェーズ1合計削減額

| 施策 | 月額削減額（USD） | 年額削減額（JPY） |
|------|----------------|----------------|
| S3ライフサイクルポリシー | $2.50 | ¥30,000 |
| ステージング夜間停止 | $62.00 | ¥111,600（想定済み） |
| CloudWatch Logs保持期間 | $20.00 | ¥36,000 |
| **フェーズ1合計** | **$22.50** | **¥66,000** |

---

### 2.2 フェーズ2: 短期施策（6ヶ月〜1年）

#### 施策2-1: RDS Reserved Instance（1年契約）

**概要**: RDS MySQLをReserved Instanceに変更（30%割引）

**現行コスト**:
- db.r6g.large Multi-AZ: $289.08/月

**RI適用後コスト**:
- db.r6g.large Multi-AZ（RI 1年、一部前払い）: $202.00/月

**削減額**:
- **月額**: $87.08
- **年額**: ¥156,600

**初期費用**: $1,000（一部前払い）
**難易度**: 低
**実施時期**: 6ヶ月後

---

#### 施策2-2: ElastiCache Reserved Instance（1年契約）

**概要**: ElastiCache RedisをReserved Instanceに変更（30%割引）

**現行コスト**:
- cache.r6g.large × 2: $367.92/月

**RI適用後コスト**:
- cache.r6g.large × 2（RI 1年、一部前払い）: $258.00/月

**削減額**:
- **月額**: $109.92
- **年額**: ¥197,700

**初期費用**: $800（一部前払い）
**難易度**: 低
**実施時期**: 6ヶ月後

---

#### 施策2-3: NAT Gateway削減（S3 Gateway Endpoint活用）

**概要**: S3アクセスをNAT Gateway経由からGateway Endpoint経由に変更

**現行コスト**:
- NAT Gateway データ処理: $62.00/月（本番）

**最適化後コスト**:
- S3 Gateway Endpoint: $0.00/月（無料）
- NAT Gateway データ処理: $40.00/月（削減後）

**削減額**:
- **月額**: $22.00
- **年額**: ¥39,600

**難易度**: 中
**実施時期**: 9ヶ月後

---

#### フェーズ2合計削減額

| 施策 | 月額削減額（USD） | 年額削減額（JPY） |
|------|----------------|----------------|
| RDS Reserved Instance | $87.08 | ¥156,600 |
| ElastiCache Reserved Instance | $109.92 | ¥197,700 |
| NAT Gateway削減 | $22.00 | ¥39,600 |
| **フェーズ2合計** | **$219.00** | **¥393,900** |

---

### 2.3 フェーズ3: 中期施策（1年〜2年）

#### 施策3-1: ECS Fargate Compute Savings Plans（1年契約）

**概要**: ECS Fargateを Compute Savings Plans に変更（25%割引）

**現行コスト**:
- ECS Fargate: $288.20/月（本番）

**Savings Plans適用後コスト**:
- ECS Fargate: $216.15/月

**削減額**:
- **月額**: $72.05
- **年額**: ¥129,690

**コミット**: $216.15/月（1年契約）
**難易度**: 中
**実施時期**: 1年後

---

#### 施策3-2: RDS Reserved Instance（3年契約）

**概要**: RDS MySQLを3年契約のReserved Instanceに変更（50%割引）

**現行コスト**:
- db.r6g.large Multi-AZ: $289.08/月

**RI適用後コスト**:
- db.r6g.large Multi-AZ（RI 3年、全額前払い）: $145.00/月

**削減額**:
- **月額**: $144.08
- **年額**: ¥259,344

**初期費用**: $5,220（全額前払い）
**難易度**: 低
**実施時期**: 1年後

---

#### 施策3-3: Graviton3インスタンスへの移行

**概要**: RDSをGraviton2からGraviton3（db.r7g）に移行（20%性能向上、価格据え置き）

**現行コスト**:
- db.r6g.large Multi-AZ: $289.08/月

**Graviton3適用後コスト**:
- db.r7g.large Multi-AZ: $275.00/月（想定）

**削減額**:
- **月額**: $14.08
- **年額**: ¥25,344

**難易度**: 低（互換性高い）
**実施時期**: 1.5年後

---

#### フェーズ3合計削減額

| 施策 | 月額削減額（USD） | 年額削減額（JPY） |
|------|----------------|----------------|
| Fargate Compute Savings Plans | $72.05 | ¥129,690 |
| RDS Reserved Instance（3年） | $144.08 | ¥259,344 |
| Graviton3移行 | $14.08 | ¥25,344 |
| **フェーズ3合計** | **$230.21** | **¥414,378** |

---

### 2.4 フェーズ4: 長期施策（2年〜3年）

#### 施策4-1: Aurora Serverless v2への移行

**概要**: RDS MySQLをAurora Serverless v2に移行（利用量ベース課金）

**現行コスト**:
- RDS MySQL db.r6g.large Multi-AZ: $289.08/月

**Aurora Serverless v2コスト**:
- 最小ACU: 0.5、最大ACU: 8
- 平均稼働ACU: 2（想定）
- $0.12/ACU/時間 × 2 ACU × 730時間 = $175.20/月

**削減額**:
- **月額**: $113.88
- **年額**: ¥205,000

**難易度**: 高（アプリケーション修正が必要）
**実施時期**: 2年後

---

#### 施策4-2: Direct Connect帯域削減（100Mbps → 50Mbps）

**概要**: 利用状況を分析し、帯域を50Mbpsに削減

**前提**: 現在の利用率が50%以下であることを確認

**現行コスト**:
- 100Mbps × 2回線: $438.00/月

**削減後コスト**:
- 50Mbps × 2回線: $288.00/月

**削減額**:
- **月額**: $150.00
- **年額**: ¥270,000

**難易度**: 高（庁舎側調整が必要）
**実施時期**: 2.5年後

---

#### 施策4-3: Lambda移行（バッチ処理）

**概要**: ECS Fargateで実行しているバッチ処理をLambdaに移行

**現行コスト**:
- ECS Fargate バッチ用タスク: $50.00/月（推定）

**Lambda移行後コスト**:
- Lambda（5,000回実行/月、平均5分実行）: $15.00/月

**削減額**:
- **月額**: $35.00
- **年額**: ¥63,000

**難易度**: 高（アプリケーション修正が必要）
**実施時期**: 3年後

---

#### フェーズ4合計削減額

| 施策 | 月額削減額（USD） | 年額削減額（JPY） |
|------|----------------|----------------|
| Aurora Serverless v2移行 | $113.88 | ¥205,000 |
| Direct Connect帯域削減 | $150.00 | ¥270,000 |
| Lambda移行 | $35.00 | ¥63,000 |
| **フェーズ4合計** | **$298.88** | **¥538,000** |

---

## 3. 全フェーズ累計削減額

| フェーズ | 実施時期 | 月額削減額（USD） | 年額削減額（JPY） | 累計削減額（JPY） |
|---------|---------|----------------|----------------|----------------|
| フェーズ1 | 0〜3ヶ月 | $22.50 | ¥66,000 | ¥66,000 |
| フェーズ2 | 6ヶ月〜1年 | $219.00 | ¥393,900 | ¥459,900 |
| フェーズ3 | 1年〜2年 | $230.21 | ¥414,378 | ¥874,278 |
| フェーズ4 | 2年〜3年 | $298.88 | ¥538,000 | ¥1,412,278 |

**最終削減率**: 約23%（$770.59/月削減）

---

## 4. 年次コスト推移

| 年度 | 月額コスト（USD） | 月額コスト（JPY） | 年額コスト（JPY） | 削減率 |
|------|----------------|----------------|----------------|--------|
| 1年目（現状） | $5,810 | ¥871,500 | ¥10,458,000 | 0% |
| 2年目 | $5,590 | ¥838,500 | ¥10,062,000 | 3.8% |
| 3年目 | $5,360 | ¥804,000 | ¥9,648,000 | 7.7% |
| 4年目以降 | $5,040 | ¥756,000 | ¥9,072,000 | 13.2% |

---

## 5. FinOps実践計画

### 5.1 コスト可視化

#### 5.1.1 AWS Cost Explorer設定

**ダッシュボード構成**:
- サービス別コスト
- タグ別コスト（Environment、Project、CostCenter）
- 日次コストトレンド
- 月次予測

#### 5.1.2 Cost Anomaly Detection

```yaml
AnomalyDetector:
  MonitorName: niigata-kaigo-anomaly-detector
  MonitorType: DIMENSIONAL
  MonitorDimension: SERVICE
  ThresholdExpression:
    CostCategories:
      - Key: AnomalyDetection
        Values: ["Enable"]
  Subscribers:
    - Address: admin@niigata-city.jp
      Type: EMAIL
      Status: CONFIRMED
```

### 5.2 予算管理

#### 5.2.1 AWS Budgets設定

```yaml
MonthlyBudget:
  BudgetName: niigata-kaigo-monthly-budget
  BudgetLimit:
    Amount: 6500
    Unit: USD
  TimeUnit: MONTHLY
  NotificationWithSubscribers:
    - Notification:
        NotificationType: ACTUAL
        ComparisonOperator: GREATER_THAN
        Threshold: 80
      Subscribers:
        - SubscriptionType: EMAIL
          Address: admin@niigata-city.jp
    - Notification:
        NotificationType: FORECASTED
        ComparisonOperator: GREATER_THAN
        Threshold: 100
      Subscribers:
        - SubscriptionType: EMAIL
          Address: manager@niigata-city.jp
        - SubscriptionType: SNS
          Address: arn:aws:sns:ap-northeast-1:123456789012:budget-alert-critical
```

### 5.3 コストアロケーションタグ

| タグキー | タグ値例 | 用途 |
|---------|---------|------|
| Environment | Production, Staging | 環境別コスト分析 |
| Project | niigata-kaigo | プロジェクト別コスト分析 |
| CostCenter | IT-Dept, Finance | 部門別コスト配分 |
| Owner | admin@niigata-city.jp | 責任者識別 |
| Service | ECS, RDS, S3 | サービス別分析 |
| ManagedBy | CloudFormation, Terraform, Manual | 管理方法別分析 |

### 5.4 月次レビュープロセス

**実施頻度**: 毎月第1営業日

**レビュー項目**:
1. 前月コスト実績確認
2. 予算との差異分析
3. 異常コスト検知
4. 最適化施策の進捗確認
5. 次月予測

**参加者**:
- プロジェクトマネージャー
- インフラ担当者
- 財務担当者

---

## 6. コスト最適化のベストプラクティス

### 6.1 設計段階でのコスト最適化

1. **適切なインスタンスタイプ選択**
   - Graviton2/Graviton3インスタンス優先
   - T系インスタンス（バースト対応）の活用（ステージング）

2. **サーバーレスアーキテクチャ活用**
   - Lambda（バッチ処理、イベント駆動）
   - Fargate（常時稼働が不要なワークロード）

3. **マネージドサービス活用**
   - RDS（EC2 + MySQLより運用コスト削減）
   - ElastiCache（EC2 + Redisより運用コスト削減）

### 6.2 運用段階でのコスト最適化

1. **使用していないリソースの削除**
   - 古いEBSスナップショット
   - 未使用のElastic IP
   - 古いAMI

2. **リソースの右サイズ化**
   - CloudWatch メトリクス分析
   - AWS Compute Optimizer活用

3. **自動化**
   - ステージング環境の自動起動・停止
   - 古いバックアップの自動削除

### 6.3 継続的な最適化

1. **四半期ごとのコストレビュー**
   - AWS Cost Explorer分析
   - Trusted Advisor推奨事項確認

2. **新サービス・新価格の調査**
   - AWS新サービスのコスト効果分析
   - 価格改定の確認

---

## 7. リスクと注意事項

### 7.1 Reserved Instance/Savings Plansのリスク

| リスク | 対策 |
|--------|------|
| 利用量減少時の損失 | 6ヶ月の利用実績を確認してから契約 |
| インスタンスタイプ変更時の制約 | Convertible RI使用（割引率は低い） |
| 3年契約の長期コミット | 1年契約から開始、様子を見て3年契約 |

### 7.2 削減施策のデメリット

| 施策 | デメリット | 対策 |
|------|----------|------|
| ステージング夜間停止 | 夜間テスト不可 | 必要時のみ手動起動 |
| NAT Gateway削減 | S3以外のインターネットアクセス遅延 | VPC Endpoints追加 |
| Aurora Serverless移行 | コールドスタート遅延 | 最小ACU設定で常時稼働 |

---

## 8. 実施スケジュール

```
月    | 施策                                    | 削減額（月額）
------|---------------------------------------|-------------
1月   | フェーズ1開始（S3ライフサイクル、Logs保持） | $22.50
2月   | -                                     | -
3月   | ステージング夜間停止                     | -（想定済み）
4月   | -                                     | -
5月   | -                                     | -
6月   | フェーズ2開始（RDS RI、ElastiCache RI） | $197.00
7月   | -                                     | -
8月   | -                                     | -
9月   | NAT Gateway削減                       | $22.00
10月  | -                                     | -
11月  | -                                     | -
12月  | 1年目レビュー                          | -
------|---------------------------------------|-------------
13月  | フェーズ3開始（Fargate Savings Plans） | $72.05
14月  | RDS RI（3年契約）                      | $144.08
15月  | -                                     | -
16月  | -                                     | -
17月  | -                                     | -
18月  | Graviton3移行                         | $14.08
19月  | -                                     | -
20月  | -                                     | -
21月  | -                                     | -
22月  | -                                     | -
23月  | -                                     | -
24月  | 2年目レビュー                          | -
------|---------------------------------------|-------------
25月  | フェーズ4開始（Aurora Serverless v2）  | $113.88
26月  | -                                     | -
27月  | -                                     | -
28月  | -                                     | -
29月  | -                                     | -
30月  | Direct Connect帯域削減                | $150.00
31月  | -                                     | -
32月  | -                                     | -
33月  | -                                     | -
34月  | -                                     | -
35月  | -                                     | -
36月  | Lambda移行、3年目レビュー              | $35.00
```

---

## 9. KPI（重要業績評価指標）

### 9.1 コスト削減KPI

| KPI | 目標値 | 測定方法 |
|-----|--------|---------|
| 年間コスト削減額 | ¥2,458,000（4年目） | AWS Cost Explorer |
| 削減率 | 23%（4年目） | （削減額 / 初期コスト） × 100 |
| Reserved Instance カバレッジ | 80%以上 | RI Coverage Report |
| Savings Plans カバレッジ | 70%以上 | Savings Plans Coverage Report |

### 9.2 運用効率KPI

| KPI | 目標値 | 測定方法 |
|-----|--------|---------|
| 未使用リソース削減率 | 100% | Trusted Advisor |
| 月次コストレビュー実施率 | 100% | プロジェクト管理ツール |
| コスト超過アラート対応時間 | 24時間以内 | SNS通知ログ |

---

## 10. まとめ

### 10.1 最適化効果

- **初年度**: ¥66,000削減（0.6%削減）
- **2年目**: ¥459,900削減（4.4%削減）
- **3年目**: ¥874,278削減（8.4%削減）
- **4年目以降**: ¥1,412,278削減（13.5%削減）

### 10.2 実施優先度

1. **即時実施**: S3ライフサイクル、CloudWatch Logs保持期間
2. **6ヶ月後**: Reserved Instance（RDS、ElastiCache）
3. **1年後**: Compute Savings Plans、3年契約RI
4. **2年以降**: Aurora Serverless、Direct Connect削減、Lambda移行

---

**作成日**: 2025-11-05
**レビュー状態**: Draft
**次回レビュー**: 2026年2月（四半期レビュー）
