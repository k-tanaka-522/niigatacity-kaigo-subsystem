name: Backend CI/CD

on:
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - 'app/backend/**'
      - '.github/workflows/backend-deploy.yml'
  pull_request:
    branches:
      - main
      - master
      - develop
    paths:
      - 'app/backend/**'

permissions:
  id-token: write  # OIDC認証に必要
  contents: read
  security-events: write  # Trivy結果アップロード用

env:
  DOTNET_VERSION: '9.0.x'
  AWS_REGION: 'ap-northeast-1'
  ECR_REPOSITORY: 'niigata-kaigo-backend'

jobs:
  test:
    name: Test Backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app/backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Run tests
        run: dotnet test --no-build --verbosity normal

  build-and-push:
    name: Build and Push Docker Image
    needs: test
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::897167645238:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker image
        run: |
          docker build -t ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }} \
            -t ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest \
            -f app/backend/Dockerfile \
            app/backend

      - name: Scan Docker image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Push Docker image to ECR
        run: |
          # ECRリポジトリ作成後に有効化
          echo "ECRへのプッシュ（リポジトリ作成後に有効化）"
          # docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          # docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest

  deploy-staging:
    name: Deploy to Staging ECS
    needs: build-and-push
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://api-staging.niigata-kaigo.example.com

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::897167645238:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to ECS
        run: |
          # ECSサービス作成後に有効化
          echo "ECSへのデプロイ（サービス作成後に有効化）"
          # aws ecs update-service \
          #   --cluster niigata-kaigo-staging-cluster \
          #   --service niigata-kaigo-staging-backend-service \
          #   --force-new-deployment

      - name: Deployment notification
        if: always()
        run: |
          echo "Deployment status: ${{ job.status }}"
          echo "Environment: staging"

  deploy-production:
    name: Deploy to Production ECS
    needs: build-and-push
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://api.niigata-kaigo.example.com

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::897167645238:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to ECS
        run: |
          # ECSサービス作成後に有効化
          echo "ECSへのデプロイ（サービス作成後に有効化）"
          # aws ecs update-service \
          #   --cluster niigata-kaigo-prod-cluster \
          #   --service niigata-kaigo-prod-backend-service \
          #   --force-new-deployment

      - name: Deployment notification
        if: always()
        run: |
          echo "Deployment status: ${{ job.status }}"
          echo "Environment: production"
