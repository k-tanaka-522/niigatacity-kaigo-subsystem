name: Infrastructure Deployment - Multi-Account & Multi-Stack

on:
  workflow_dispatch:
    inputs:
      account:
        description: 'Account to deploy'
        required: true
        type: choice
        options:
          - common
          - app
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      stack:
        description: 'Stack to deploy (app account only)'
        required: true
        type: choice
        options:
          - network
          - security
          - database
          - compute
          - storage
          - auth
          - monitoring
          - all
        default: all
  push:
    branches:
      - master
    paths:
      - 'infra/common/**'
      - 'infra/app/**'
      - '.github/workflows/infra-deploy.yml'

permissions:
  id-token: write  # OIDC authentication
  contents: read

env:
  AWS_REGION: 'ap-northeast-1'
  PROJECT_NAME: 'niigata-kaigo'

jobs:
  validate:
    name: Validate CloudFormation Templates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::897167645238:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install cfn-lint
        run: pip install cfn-lint

      - name: Determine deployment parameters
        id: determine
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ACCOUNT="${{ github.event.inputs.account }}"
            ENV="${{ github.event.inputs.environment }}"
            STACK="${{ github.event.inputs.stack }}"
          else
            # For push events, deploy to dev environment
            ACCOUNT="common"
            ENV="dev"
            STACK="network"
          fi

          echo "account=$ACCOUNT" >> $GITHUB_OUTPUT
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "stack=$STACK" >> $GITHUB_OUTPUT
          echo "Deploying account: $ACCOUNT, environment: $ENV, stack: $STACK"

      - name: Lint CloudFormation templates
        run: |
          ACCOUNT="${{ steps.determine.outputs.account }}"
          STACK="${{ steps.determine.outputs.stack }}"

          echo "Linting templates for account: $ACCOUNT, stack: $STACK"

          if [ "$ACCOUNT" == "common" ]; then
            cfn-lint infra/$ACCOUNT/cloudformation/templates/network/*.yaml --ignore-checks W,E0000 || true
          elif [ "$STACK" == "all" ] || [ "$STACK" == "network" ]; then
            cfn-lint infra/$ACCOUNT/cloudformation/templates/network/*.yaml --ignore-checks W,E0000 || true
          fi

      - name: Validate main stack templates
        run: |
          ACCOUNT="${{ steps.determine.outputs.account }}"
          STACK="${{ steps.determine.outputs.stack }}"

          echo "Validating templates for account: $ACCOUNT, stack: $STACK"

          if [ "$ACCOUNT" == "common" ]; then
            TEMPLATE="infra/common/cloudformation/stacks/02-network/main.yaml"
            echo "Validating: $TEMPLATE"
            aws cloudformation validate-template --template-body file://$TEMPLATE > /dev/null
          elif [ "$ACCOUNT" == "app" ]; then
            # Define stacks to validate
            if [ "$STACK" == "all" ]; then
              STACKS="03-network 04-security 05-database 06-compute 07-storage 08-auth 09-monitoring"
            elif [ "$STACK" == "network" ]; then
              STACKS="03-network"
            elif [ "$STACK" == "security" ]; then
              STACKS="04-security"
            elif [ "$STACK" == "database" ]; then
              STACKS="05-database"
            elif [ "$STACK" == "compute" ]; then
              STACKS="06-compute"
            elif [ "$STACK" == "storage" ]; then
              STACKS="07-storage"
            elif [ "$STACK" == "auth" ]; then
              STACKS="08-auth"
            elif [ "$STACK" == "monitoring" ]; then
              STACKS="09-monitoring"
            fi

            for stack_dir in $STACKS; do
              TEMPLATE="infra/$ACCOUNT/cloudformation/stacks/$stack_dir/main.yaml"
              echo "Validating: $TEMPLATE"
              aws cloudformation validate-template --template-body file://$TEMPLATE > /dev/null
              echo "‚úÖ $TEMPLATE is valid"
            done
          fi

          echo "‚úÖ All main stack templates are valid"

      - name: Validate nested templates
        run: |
          ACCOUNT="${{ steps.determine.outputs.account }}"
          STACK="${{ steps.determine.outputs.stack }}"

          echo "Validating nested templates for account: $ACCOUNT, stack: $STACK"

          if [ "$ACCOUNT" == "common" ] || [ "$STACK" == "network" ] || [ "$STACK" == "all" ]; then
            if [ -d "infra/$ACCOUNT/cloudformation/templates/network" ]; then
              for template in infra/$ACCOUNT/cloudformation/templates/network/*.yaml; do
                echo "Validating: $template"
                aws cloudformation validate-template --template-body file://$template > /dev/null
              done
              echo "‚úÖ Network nested templates are valid"
            fi
          fi

  upload-templates:
    name: Upload Templates to S3
    needs: validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::897167645238:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Determine deployment parameters
        id: determine
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ACCOUNT="${{ github.event.inputs.account }}"
            ENV="${{ github.event.inputs.environment }}"
            STACK="${{ github.event.inputs.stack }}"
          else
            ACCOUNT="common"
            ENV="dev"
            STACK="network"
          fi

          echo "account=$ACCOUNT" >> $GITHUB_OUTPUT
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "stack=$STACK" >> $GITHUB_OUTPUT

      - name: Determine S3 bucket
        id: determine-bucket
        run: |
          ENV="${{ steps.determine.outputs.environment }}"
          BUCKET="${{ env.PROJECT_NAME }}-cfn-templates-${ENV}"
          echo "bucket=$BUCKET" >> $GITHUB_OUTPUT
          echo "üì¶ S3 Bucket: $BUCKET"

      - name: Create S3 bucket if not exists
        run: |
          BUCKET="${{ steps.determine-bucket.outputs.bucket }}"

          # Check if bucket exists
          if ! aws s3 ls "s3://$BUCKET" 2>/dev/null; then
            echo "Bucket $BUCKET does not exist. Creating..."
            aws s3 mb "s3://$BUCKET" --region ${{ env.AWS_REGION }}

            # Enable versioning
            aws s3api put-bucket-versioning \
              --bucket "$BUCKET" \
              --versioning-configuration Status=Enabled

            # Enable server-side encryption
            aws s3api put-bucket-encryption \
              --bucket "$BUCKET" \
              --server-side-encryption-configuration '{
                "Rules": [{
                  "ApplyServerSideEncryptionByDefault": {
                    "SSEAlgorithm": "AES256"
                  }
                }]
              }'

            # Block public access
            aws s3api put-public-access-block \
              --bucket "$BUCKET" \
              --public-access-block-configuration \
                "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"

            echo "‚úÖ Bucket $BUCKET created successfully"
          else
            echo "‚úÖ Bucket $BUCKET already exists"
          fi

      - name: Upload templates to S3
        run: |
          BUCKET="${{ steps.determine-bucket.outputs.bucket }}"
          ACCOUNT="${{ steps.determine.outputs.account }}"

          echo "üì§ Uploading templates for account: $ACCOUNT to s3://$BUCKET/$ACCOUNT/templates/"
          aws s3 sync infra/$ACCOUNT/cloudformation/templates/ \
            s3://$BUCKET/$ACCOUNT/templates/ \
            --region ${{ env.AWS_REGION }} \
            --delete

          echo "‚úÖ Templates uploaded successfully"

  # Common Account: Network Stack
  deploy-common-network:
    name: Deploy Common Network Stack
    needs: upload-templates
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.account == 'common' || (github.event_name == 'push' && contains(github.event.head_commit.modified, 'infra/common/')) }}
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}-infra

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::897167645238:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Common Network Stack
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          STACK_NAME="${{ env.PROJECT_NAME }}-${ENV}-common-network-stack"
          TEMPLATE="infra/common/cloudformation/stacks/02-network/main.yaml"
          PARAMETERS="infra/common/cloudformation/parameters/${ENV}.json"

          echo "================================================"
          echo "Deploying Common Network Stack"
          echo "================================================"
          echo "Stack: $STACK_NAME"
          echo "Template: $TEMPLATE"
          echo "Parameters: $PARAMETERS"

          chmod +x infra/cloudformation/scripts/*.sh

          # Create Change Set
          ./infra/cloudformation/scripts/create-changeset.sh "$STACK_NAME" "$TEMPLATE" "$PARAMETERS" "$ENV"

          # Get Change Set name
          CHANGESET_NAME=$(aws cloudformation list-change-sets \
            --stack-name "$STACK_NAME" \
            --query 'Summaries[0].ChangeSetName' \
            --output text)

          # Describe Change Set
          ./infra/cloudformation/scripts/describe-changeset.sh "$STACK_NAME" "$CHANGESET_NAME"

          # Execute Change Set
          echo "yes" | ./infra/cloudformation/scripts/execute-changeset.sh "$STACK_NAME" "$CHANGESET_NAME"

          # Wait for completion
          aws cloudformation wait stack-create-complete --stack-name "$STACK_NAME" 2>/dev/null || \
          aws cloudformation wait stack-update-complete --stack-name "$STACK_NAME"

          echo "‚úÖ Common Network Stack deployed successfully"

  # App Account: Security Stack (Phase 1)
  deploy-app-security:
    name: Deploy App Security Stack
    needs: upload-templates
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.account == 'app' && (github.event.inputs.stack == 'security' || github.event.inputs.stack == 'all') }}
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}-infra

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::897167645238:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Security Stack
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          STACK_NAME="${{ env.PROJECT_NAME }}-${ENV}-app-security-stack"
          TEMPLATE="infra/app/cloudformation/stacks/04-security/main.yaml"
          PARAMETERS="infra/app/cloudformation/parameters/${ENV}/04-security-stack-params.json"

          echo "================================================"
          echo "Deploying Security Stack"
          echo "================================================"
          echo "Stack: $STACK_NAME"
          echo "Template: $TEMPLATE"
          echo "Parameters: $PARAMETERS"

          chmod +x infra/cloudformation/scripts/*.sh

          # Create Change Set
          ./infra/cloudformation/scripts/create-changeset.sh "$STACK_NAME" "$TEMPLATE" "$PARAMETERS" "$ENV"

          # Get Change Set name
          CHANGESET_NAME=$(aws cloudformation list-change-sets \
            --stack-name "$STACK_NAME" \
            --query 'Summaries[0].ChangeSetName' \
            --output text)

          # Describe Change Set
          ./infra/cloudformation/scripts/describe-changeset.sh "$STACK_NAME" "$CHANGESET_NAME"

          # Execute Change Set
          echo "yes" | ./infra/cloudformation/scripts/execute-changeset.sh "$STACK_NAME" "$CHANGESET_NAME"

          # Wait for completion
          aws cloudformation wait stack-create-complete --stack-name "$STACK_NAME" 2>/dev/null || \
          aws cloudformation wait stack-update-complete --stack-name "$STACK_NAME"

          echo "‚úÖ Security Stack deployed successfully"

  # App Account: Database Stack (Phase 2)
  deploy-app-database:
    name: Deploy App Database Stack
    needs: [upload-templates, deploy-app-security]
    runs-on: ubuntu-latest
    if: ${{ always() && github.event.inputs.account == 'app' && (github.event.inputs.stack == 'database' || github.event.inputs.stack == 'all') && (needs.deploy-app-security.result == 'success' || github.event.inputs.stack == 'database') }}
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}-infra

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::897167645238:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Database Stack
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          STACK_NAME="${{ env.PROJECT_NAME }}-${ENV}-app-database-stack"
          TEMPLATE="infra/app/cloudformation/stacks/05-database/main.yaml"
          PARAMETERS="infra/app/cloudformation/parameters/${ENV}/05-database-stack-params.json"

          echo "================================================"
          echo "Deploying Database Stack"
          echo "================================================"
          echo "Stack: $STACK_NAME"
          echo "Template: $TEMPLATE"
          echo "Parameters: $PARAMETERS"

          chmod +x infra/cloudformation/scripts/*.sh

          # Create Change Set
          ./infra/cloudformation/scripts/create-changeset.sh "$STACK_NAME" "$TEMPLATE" "$PARAMETERS" "$ENV"

          # Get Change Set name
          CHANGESET_NAME=$(aws cloudformation list-change-sets \
            --stack-name "$STACK_NAME" \
            --query 'Summaries[0].ChangeSetName' \
            --output text)

          # Describe Change Set
          ./infra/cloudformation/scripts/describe-changeset.sh "$STACK_NAME" "$CHANGESET_NAME"

          # Execute Change Set
          echo "yes" | ./infra/cloudformation/scripts/execute-changeset.sh "$STACK_NAME" "$CHANGESET_NAME"

          # Wait for completion
          aws cloudformation wait stack-create-complete --stack-name "$STACK_NAME" 2>/dev/null || \
          aws cloudformation wait stack-update-complete --stack-name "$STACK_NAME"

          echo "‚úÖ Database Stack deployed successfully"

  # App Account: Compute Stack (Phase 3)
  deploy-app-compute:
    name: Deploy App Compute Stack
    needs: [upload-templates, deploy-app-database]
    runs-on: ubuntu-latest
    if: ${{ always() && github.event.inputs.account == 'app' && (github.event.inputs.stack == 'compute' || github.event.inputs.stack == 'all') && (needs.deploy-app-database.result == 'success' || github.event.inputs.stack == 'compute') }}
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}-infra

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::897167645238:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Compute Stack
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          STACK_NAME="${{ env.PROJECT_NAME }}-${ENV}-app-compute-stack"
          TEMPLATE="infra/app/cloudformation/stacks/06-compute/main.yaml"
          PARAMETERS="infra/app/cloudformation/parameters/${ENV}/06-compute-stack-params.json"

          echo "================================================"
          echo "Deploying Compute Stack"
          echo "================================================"
          echo "Stack: $STACK_NAME"
          echo "Template: $TEMPLATE"
          echo "Parameters: $PARAMETERS"

          chmod +x infra/cloudformation/scripts/*.sh

          # Create Change Set
          ./infra/cloudformation/scripts/create-changeset.sh "$STACK_NAME" "$TEMPLATE" "$PARAMETERS" "$ENV"

          # Get Change Set name
          CHANGESET_NAME=$(aws cloudformation list-change-sets \
            --stack-name "$STACK_NAME" \
            --query 'Summaries[0].ChangeSetName' \
            --output text)

          # Describe Change Set
          ./infra/cloudformation/scripts/describe-changeset.sh "$STACK_NAME" "$CHANGESET_NAME"

          # Execute Change Set
          echo "yes" | ./infra/cloudformation/scripts/execute-changeset.sh "$STACK_NAME" "$CHANGESET_NAME"

          # Wait for completion
          aws cloudformation wait stack-create-complete --stack-name "$STACK_NAME" 2>/dev/null || \
          aws cloudformation wait stack-update-complete --stack-name "$STACK_NAME"

          echo "‚úÖ Compute Stack deployed successfully"

  # App Account: Storage Stack (Phase 4)
  deploy-app-storage:
    name: Deploy App Storage Stack
    needs: [upload-templates, deploy-app-compute]
    runs-on: ubuntu-latest
    if: ${{ always() && github.event.inputs.account == 'app' && (github.event.inputs.stack == 'storage' || github.event.inputs.stack == 'all') && (needs.deploy-app-compute.result == 'success' || github.event.inputs.stack == 'storage') }}
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}-infra

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::897167645238:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Storage Stack
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          STACK_NAME="${{ env.PROJECT_NAME }}-${ENV}-app-storage-stack"
          TEMPLATE="infra/app/cloudformation/stacks/07-storage/main.yaml"
          PARAMETERS="infra/app/cloudformation/parameters/${ENV}/07-storage-stack-params.json"

          echo "================================================"
          echo "Deploying Storage Stack"
          echo "================================================"
          echo "Stack: $STACK_NAME"
          echo "Template: $TEMPLATE"
          echo "Parameters: $PARAMETERS"

          chmod +x infra/cloudformation/scripts/*.sh

          # Create Change Set
          ./infra/cloudformation/scripts/create-changeset.sh "$STACK_NAME" "$TEMPLATE" "$PARAMETERS" "$ENV"

          # Get Change Set name
          CHANGESET_NAME=$(aws cloudformation list-change-sets \
            --stack-name "$STACK_NAME" \
            --query 'Summaries[0].ChangeSetName' \
            --output text)

          # Describe Change Set
          ./infra/cloudformation/scripts/describe-changeset.sh "$STACK_NAME" "$CHANGESET_NAME"

          # Execute Change Set
          echo "yes" | ./infra/cloudformation/scripts/execute-changeset.sh "$STACK_NAME" "$CHANGESET_NAME"

          # Wait for completion
          aws cloudformation wait stack-create-complete --stack-name "$STACK_NAME" 2>/dev/null || \
          aws cloudformation wait stack-update-complete --stack-name "$STACK_NAME"

          echo "‚úÖ Storage Stack deployed successfully"

  # App Account: Auth Stack (Phase 5)
  deploy-app-auth:
    name: Deploy App Auth Stack
    needs: [upload-templates, deploy-app-storage]
    runs-on: ubuntu-latest
    if: ${{ always() && github.event.inputs.account == 'app' && (github.event.inputs.stack == 'auth' || github.event.inputs.stack == 'all') && (needs.deploy-app-storage.result == 'success' || github.event.inputs.stack == 'auth') }}
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}-infra

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::897167645238:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Auth Stack
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          STACK_NAME="${{ env.PROJECT_NAME }}-${ENV}-app-auth-stack"
          TEMPLATE="infra/app/cloudformation/stacks/08-auth/main.yaml"
          PARAMETERS="infra/app/cloudformation/parameters/${ENV}/08-auth-stack-params.json"

          echo "================================================"
          echo "Deploying Auth Stack"
          echo "================================================"
          echo "Stack: $STACK_NAME"
          echo "Template: $TEMPLATE"
          echo "Parameters: $PARAMETERS"

          chmod +x infra/cloudformation/scripts/*.sh

          # Create Change Set
          ./infra/cloudformation/scripts/create-changeset.sh "$STACK_NAME" "$TEMPLATE" "$PARAMETERS" "$ENV"

          # Get Change Set name
          CHANGESET_NAME=$(aws cloudformation list-change-sets \
            --stack-name "$STACK_NAME" \
            --query 'Summaries[0].ChangeSetName' \
            --output text)

          # Describe Change Set
          ./infra/cloudformation/scripts/describe-changeset.sh "$STACK_NAME" "$CHANGESET_NAME"

          # Execute Change Set
          echo "yes" | ./infra/cloudformation/scripts/execute-changeset.sh "$STACK_NAME" "$CHANGESET_NAME"

          # Wait for completion
          aws cloudformation wait stack-create-complete --stack-name "$STACK_NAME" 2>/dev/null || \
          aws cloudformation wait stack-update-complete --stack-name "$STACK_NAME"

          echo "‚úÖ Auth Stack deployed successfully"

  # App Account: Monitoring Stack (Phase 6)
  deploy-app-monitoring:
    name: Deploy App Monitoring Stack
    needs: [upload-templates, deploy-app-auth]
    runs-on: ubuntu-latest
    if: ${{ always() && github.event.inputs.account == 'app' && (github.event.inputs.stack == 'monitoring' || github.event.inputs.stack == 'all') && (needs.deploy-app-auth.result == 'success' || github.event.inputs.stack == 'monitoring') }}
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}-infra

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::897167645238:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Monitoring Stack
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          STACK_NAME="${{ env.PROJECT_NAME }}-${ENV}-app-monitoring-stack"
          TEMPLATE="infra/app/cloudformation/stacks/09-monitoring/main.yaml"
          PARAMETERS="infra/app/cloudformation/parameters/${ENV}/09-monitoring-stack-params.json"

          echo "================================================"
          echo "Deploying Monitoring Stack"
          echo "================================================"
          echo "Stack: $STACK_NAME"
          echo "Template: $TEMPLATE"
          echo "Parameters: $PARAMETERS"

          chmod +x infra/cloudformation/scripts/*.sh

          # Create Change Set
          ./infra/cloudformation/scripts/create-changeset.sh "$STACK_NAME" "$TEMPLATE" "$PARAMETERS" "$ENV"

          # Get Change Set name
          CHANGESET_NAME=$(aws cloudformation list-change-sets \
            --stack-name "$STACK_NAME" \
            --query 'Summaries[0].ChangeSetName' \
            --output text)

          # Describe Change Set
          ./infra/cloudformation/scripts/describe-changeset.sh "$STACK_NAME" "$CHANGESET_NAME"

          # Execute Change Set
          echo "yes" | ./infra/cloudformation/scripts/execute-changeset.sh "$STACK_NAME" "$CHANGESET_NAME"

          # Wait for completion
          aws cloudformation wait stack-create-complete --stack-name "$STACK_NAME" 2>/dev/null || \
          aws cloudformation wait stack-update-complete --stack-name "$STACK_NAME"

          echo "‚úÖ Monitoring Stack deployed successfully"

  # Deployment Summary
  deployment-summary:
    name: Deployment Summary
    needs: [deploy-common-network, deploy-app-security, deploy-app-database, deploy-app-compute, deploy-app-storage, deploy-app-auth, deploy-app-monitoring]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Display Deployment Summary
        run: |
          echo "================================================"
          echo "Deployment Summary"
          echo "================================================"
          echo "Account: ${{ github.event.inputs.account || 'common' }}"
          echo "Environment: ${{ github.event.inputs.environment || 'dev' }}"
          echo "Stack: ${{ github.event.inputs.stack || 'network' }}"
          echo ""
          echo "Job Results:"
          echo "  - Common Network: ${{ needs.deploy-common-network.result || 'skipped' }}"
          echo "  - App Security: ${{ needs.deploy-app-security.result || 'skipped' }}"
          echo "  - App Database: ${{ needs.deploy-app-database.result || 'skipped' }}"
          echo "  - App Compute: ${{ needs.deploy-app-compute.result || 'skipped' }}"
          echo "  - App Storage: ${{ needs.deploy-app-storage.result || 'skipped' }}"
          echo "  - App Auth: ${{ needs.deploy-app-auth.result || 'skipped' }}"
          echo "  - App Monitoring: ${{ needs.deploy-app-monitoring.result || 'skipped' }}"
          echo "================================================"

          # Determine overall status
          FAILED=0
          if [ "${{ needs.deploy-common-network.result }}" == "failure" ]; then FAILED=1; fi
          if [ "${{ needs.deploy-app-security.result }}" == "failure" ]; then FAILED=1; fi
          if [ "${{ needs.deploy-app-database.result }}" == "failure" ]; then FAILED=1; fi
          if [ "${{ needs.deploy-app-compute.result }}" == "failure" ]; then FAILED=1; fi
          if [ "${{ needs.deploy-app-storage.result }}" == "failure" ]; then FAILED=1; fi
          if [ "${{ needs.deploy-app-auth.result }}" == "failure" ]; then FAILED=1; fi
          if [ "${{ needs.deploy-app-monitoring.result }}" == "failure" ]; then FAILED=1; fi

          if [ "$FAILED" == "1" ]; then
            echo "‚ùå Deployment failed. Check the logs above for details."
            exit 1
          else
            echo "‚úÖ Deployment completed successfully!"
          fi
