name: Infrastructure CI/CD

on:
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - 'infra/cloudformation/**'
      - '.github/workflows/infra-deploy.yml'
  pull_request:
    branches:
      - main
      - master
      - develop
    paths:
      - 'infra/cloudformation/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - staging
          - production
      phase:
        description: 'Phase to deploy'
        required: true
        type: choice
        options:
          - phase1
          - phase2
          - phase3
          - phase4
          - phase5
          - all

permissions:
  id-token: write  # OIDC認証に必要
  contents: read

env:
  AWS_REGION: 'ap-northeast-1'
  PROJECT_NAME: 'niigata-kaigo'

jobs:
  validate:
    name: Validate CloudFormation Templates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::897167645238:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install cfn-lint
        run: pip install cfn-lint

      - name: Lint CloudFormation templates
        run: |
          cfn-lint infra/cloudformation/**/*.yaml --ignore-checks W,E0000

      - name: Validate CloudFormation templates
        run: |
          for template in infra/cloudformation/production/*/*.yaml infra/cloudformation/staging/*/*.yaml; do
            if [ -f "$template" ]; then
              echo "Validating $template"
              aws cloudformation validate-template --template-body file://$template > /dev/null
            fi
          done

  # Phase 1: 監査・ネットワーク基盤
  deploy-staging-phase1:
    name: Deploy Phase 1 to Staging (Audit & Network)
    needs: validate
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: staging-infra

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::897167645238:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy CloudTrail Stack
        run: |
          echo "CloudTrailスタックデプロイ"
          bash infra/cloudformation/scripts/deploy.sh staging 01_audit cloudtrail-stack <<< "yes"

      - name: Deploy AWS Config Stack
        run: |
          echo "AWS Configスタックデプロイ"
          bash infra/cloudformation/scripts/deploy.sh staging 01_audit aws-config-stack <<< "yes"

      - name: Deploy VPC Core Stack
        run: |
          echo "VPC Coreスタックデプロイ"
          bash infra/cloudformation/scripts/deploy.sh staging 02_network vpc-core-stack <<< "yes"

      - name: Deploy Subnets Stack
        run: |
          echo "Subnetsスタックデプロイ"
          bash infra/cloudformation/scripts/deploy.sh staging 02_network subnets-stack <<< "yes"

      - name: Deploy NAT Gateways Stack
        run: |
          echo "NAT Gatewaysスタックデプロイ"
          bash infra/cloudformation/scripts/deploy.sh staging 02_network nat-gateways-stack <<< "yes"

      - name: Deploy Route Tables Stack
        run: |
          echo "Route Tablesスタックデプロイ"
          bash infra/cloudformation/scripts/deploy.sh staging 02_network route-tables-stack <<< "yes"

      - name: Deployment notification
        if: always()
        run: |
          echo "Deployment status: ${{ job.status }}"
          echo "Environment: staging"
          echo "Phase: Phase 1 (Audit & Network)"

  # Phase 2: セキュリティ
  deploy-staging-phase2:
    name: Deploy Phase 2 to Staging (Security)
    needs: deploy-staging-phase1
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: staging-infra

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::897167645238:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy KMS Stack
        run: |
          echo "KMSスタックデプロイ"
          bash infra/cloudformation/scripts/deploy.sh staging 03_security kms-stack <<< "yes"

      - name: Deploy Security Groups Stack
        run: |
          echo "Security Groupsスタックデプロイ"
          bash infra/cloudformation/scripts/deploy.sh staging 03_security security-groups-stack <<< "yes"

      - name: Deployment notification
        if: always()
        run: |
          echo "Deployment status: ${{ job.status }}"
          echo "Environment: staging"
          echo "Phase: Phase 2 (Security)"

  # Phase 3: データ層
  deploy-staging-phase3:
    name: Deploy Phase 3 to Staging (Data)
    needs: deploy-staging-phase2
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: staging-infra

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::897167645238:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy RDS Stack
        run: |
          echo "RDSスタックデプロイ"
          bash infra/cloudformation/scripts/deploy.sh staging 05_data rds-stack <<< "yes"

      - name: Deployment notification
        if: always()
        run: |
          echo "Deployment status: ${{ job.status }}"
          echo "Environment: staging"
          echo "Phase: Phase 3 (Data)"

  # Phase 4: コンピューティング
  deploy-staging-phase4:
    name: Deploy Phase 4 to Staging (Compute)
    needs: deploy-staging-phase2
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: staging-infra

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::897167645238:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy ALB Stack
        run: |
          echo "ALBスタックデプロイ"
          bash infra/cloudformation/scripts/deploy.sh staging 04_compute alb-stack <<< "yes"

      - name: Deploy ECS Stack
        run: |
          echo "ECSスタックデプロイ"
          bash infra/cloudformation/scripts/deploy.sh staging 04_compute ecs-stack <<< "yes"

      - name: Deployment notification
        if: always()
        run: |
          echo "Deployment status: ${{ job.status }}"
          echo "Environment: staging"
          echo "Phase: Phase 4 (Compute)"

  # Phase 5: ストレージ・認証
  deploy-staging-phase5:
    name: Deploy Phase 5 to Staging (Storage & Auth)
    needs: deploy-staging-phase2
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: staging-infra

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::897167645238:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy S3 Stack
        run: |
          echo "S3スタックデプロイ"
          bash infra/cloudformation/scripts/deploy.sh staging 06_storage s3-stack <<< "yes"

      - name: Deploy Cognito User Pool
        run: |
          echo "Cognito User Poolスタックデプロイ"
          bash infra/cloudformation/scripts/deploy.sh staging 07_cognito cognito-user-pool <<< "yes"

      - name: Deploy Cognito Identity Pool
        run: |
          echo "Cognito Identity Poolスタックデプロイ"
          bash infra/cloudformation/scripts/deploy.sh staging 07_cognito cognito-identity-pool <<< "yes"

      - name: Deploy Cognito DynamoDB Tables
        run: |
          echo "Cognito DynamoDB Tablesスタックデプロイ"
          bash infra/cloudformation/scripts/deploy.sh staging 07_cognito cognito-dynamodb-tables <<< "yes"

      - name: Deploy Cognito Lambda Triggers
        run: |
          echo "Cognito Lambda Triggersスタックデプロイ"
          bash infra/cloudformation/scripts/deploy.sh staging 07_cognito cognito-lambda-triggers <<< "yes"

      - name: Deployment notification
        if: always()
        run: |
          echo "Deployment status: ${{ job.status }}"
          echo "Environment: staging"
          echo "Phase: Phase 5 (Storage & Auth)"

  # Production deployment (manual trigger only)
  deploy-production:
    name: Deploy to Production
    needs: validate
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    environment:
      name: production-infra

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::897167645238:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Determine phase to deploy
        id: determine-phase
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PHASE="${{ github.event.inputs.phase }}"
            ENV="${{ github.event.inputs.environment }}"
          else
            # Default to phase1 for push events
            PHASE="phase1"
            ENV="production"
          fi
          echo "phase=$PHASE" >> $GITHUB_OUTPUT
          echo "environment=$ENV" >> $GITHUB_OUTPUT

      - name: Deploy Phase
        run: |
          PHASE="${{ steps.determine-phase.outputs.phase }}"
          ENV="${{ steps.determine-phase.outputs.environment }}"

          if [ "$PHASE" == "all" ]; then
            echo "Deploying all phases in order..."
            bash infra/cloudformation/scripts/deploy-phase.sh $ENV phase1
            bash infra/cloudformation/scripts/deploy-phase.sh $ENV phase2
            bash infra/cloudformation/scripts/deploy-phase.sh $ENV phase3
            bash infra/cloudformation/scripts/deploy-phase.sh $ENV phase4
            bash infra/cloudformation/scripts/deploy-phase.sh $ENV phase5
          else
            echo "Deploying $PHASE to $ENV..."
            bash infra/cloudformation/scripts/deploy-phase.sh $ENV $PHASE
          fi

      - name: Deployment notification
        if: always()
        run: |
          echo "Deployment status: ${{ job.status }}"
          echo "Environment: ${{ steps.determine-phase.outputs.environment }}"
          echo "Phase: ${{ steps.determine-phase.outputs.phase }}"

  # Manual workflow dispatch handler
  deploy-manual:
    name: Manual Deployment
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}-infra

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::897167645238:role/GitHubActionsDeployRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Phase
        run: |
          PHASE="${{ github.event.inputs.phase }}"
          ENV="${{ github.event.inputs.environment }}"

          if [ "$PHASE" == "all" ]; then
            echo "Deploying all phases in order..."
            bash infra/cloudformation/scripts/deploy-phase.sh $ENV phase1
            bash infra/cloudformation/scripts/deploy-phase.sh $ENV phase2
            bash infra/cloudformation/scripts/deploy-phase.sh $ENV phase3
            bash infra/cloudformation/scripts/deploy-phase.sh $ENV phase4
            bash infra/cloudformation/scripts/deploy-phase.sh $ENV phase5
          else
            echo "Deploying $PHASE to $ENV..."
            bash infra/cloudformation/scripts/deploy-phase.sh $ENV $PHASE
          fi

      - name: Deployment notification
        if: always()
        run: |
          echo "Deployment status: ${{ job.status }}"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Phase: ${{ github.event.inputs.phase }}"
