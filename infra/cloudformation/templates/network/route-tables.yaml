AWSTemplateFormatVersion: '2010-09-09'
Description: 'Route Tables Stack for Niigata Kaigo Subsystem - Production Environment'

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: 'Stack Dependencies'
        Parameters:
          - VPCStackName
          - SubnetsStackName
          - NATGatewaysStackName
      - Label:
          default: 'Environment Configuration'
        Parameters:
          - EnvironmentName
          - ProjectName

Parameters:
  VPCStackName:
    Type: String
    Default: niigata-kaigo-prod-vpc-core-stack
    Description: Name of the VPC Core stack

  SubnetsStackName:
    Type: String
    Default: niigata-kaigo-prod-subnets-stack
    Description: Name of the Subnets stack

  NATGatewaysStackName:
    Type: String
    Default: niigata-kaigo-prod-nat-gateways-stack
    Description: Name of the NAT Gateways stack

  EnvironmentName:
    Type: String
    Default: production
    Description: Environment name

  ProjectName:
    Type: String
    Default: niigata-kaigo
    Description: Project name for tagging

Resources:
  # ========================================
  # Public Route Table
  # ========================================

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !ImportValue
        Fn::Sub: '${VPCStackName}-VPCId'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${EnvironmentName}-public-rt'
        - Key: Type
          Value: Public
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Project
          Value: !Ref ProjectName
        - Key: ManagedBy
          Value: CloudFormation

  # Route to Internet Gateway
  PublicRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !ImportValue
        Fn::Sub: '${VPCStackName}-InternetGatewayId'

  # Associate Public Subnets with Public Route Table
  PublicSubnet1aRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !ImportValue
        Fn::Sub: '${SubnetsStackName}-PublicSubnet1aId'
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet1cRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !ImportValue
        Fn::Sub: '${SubnetsStackName}-PublicSubnet1cId'
      RouteTableId: !Ref PublicRouteTable

  # ========================================
  # Private Route Tables (AZ-specific)
  # ========================================

  # Private Route Table for AZ 1a
  PrivateRouteTable1a:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !ImportValue
        Fn::Sub: '${VPCStackName}-VPCId'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${EnvironmentName}-private-rt-1a'
        - Key: Type
          Value: Private
        - Key: AZ
          Value: ap-northeast-1a
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Project
          Value: !Ref ProjectName
        - Key: ManagedBy
          Value: CloudFormation

  # Route to NAT Gateway 1a
  PrivateRoute1a:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable1a
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !ImportValue
        Fn::Sub: '${NATGatewaysStackName}-NATGateway1aId'

  # Associate Private App Subnet 1a
  PrivateAppSubnet1aRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !ImportValue
        Fn::Sub: '${SubnetsStackName}-PrivateAppSubnet1aId'
      RouteTableId: !Ref PrivateRouteTable1a

  # Associate Private DB Subnet 1a
  PrivateDBSubnet1aRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !ImportValue
        Fn::Sub: '${SubnetsStackName}-PrivateDBSubnet1aId'
      RouteTableId: !Ref PrivateRouteTable1a

  # Associate Private Cache Subnet 1a
  PrivateCacheSubnet1aRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !ImportValue
        Fn::Sub: '${SubnetsStackName}-PrivateCacheSubnet1aId'
      RouteTableId: !Ref PrivateRouteTable1a

  # Private Route Table for AZ 1c
  PrivateRouteTable1c:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !ImportValue
        Fn::Sub: '${VPCStackName}-VPCId'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${EnvironmentName}-private-rt-1c'
        - Key: Type
          Value: Private
        - Key: AZ
          Value: ap-northeast-1c
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Project
          Value: !Ref ProjectName
        - Key: ManagedBy
          Value: CloudFormation

  # Route to NAT Gateway 1c
  PrivateRoute1c:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable1c
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !ImportValue
        Fn::Sub: '${NATGatewaysStackName}-NATGateway1cId'

  # Associate Private App Subnet 1c
  PrivateAppSubnet1cRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !ImportValue
        Fn::Sub: '${SubnetsStackName}-PrivateAppSubnet1cId'
      RouteTableId: !Ref PrivateRouteTable1c

  # Associate Private DB Subnet 1c
  PrivateDBSubnet1cRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !ImportValue
        Fn::Sub: '${SubnetsStackName}-PrivateDBSubnet1cId'
      RouteTableId: !Ref PrivateRouteTable1c

  # Associate Private Cache Subnet 1c
  PrivateCacheSubnet1cRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !ImportValue
        Fn::Sub: '${SubnetsStackName}-PrivateCacheSubnet1cId'
      RouteTableId: !Ref PrivateRouteTable1c

Outputs:
  PublicRouteTableId:
    Description: Public Route Table ID
    Value: !Ref PublicRouteTable
    Export:
      Name: !Sub '${AWS::StackName}-PublicRouteTableId'

  PrivateRouteTable1aId:
    Description: Private Route Table 1a ID
    Value: !Ref PrivateRouteTable1a
    Export:
      Name: !Sub '${AWS::StackName}-PrivateRouteTable1aId'

  PrivateRouteTable1cId:
    Description: Private Route Table 1c ID
    Value: !Ref PrivateRouteTable1c
    Export:
      Name: !Sub '${AWS::StackName}-PrivateRouteTable1cId'
