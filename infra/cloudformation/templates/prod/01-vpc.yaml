AWSTemplateFormatVersion: '2010-09-09'
Description: >
  新潟市介護保険事業所システム - VPC (本番環境)
  CIDR: 10.1.0.0/16, Multi-AZ (ap-northeast-1a, 1c)

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "プロジェクト設定"
        Parameters:
          - ProjectName
          - Environment
      - Label:
          default: "ネットワーク設定"
        Parameters:
          - VpcCIDR
          - AvailabilityZone1
          - AvailabilityZone2
      - Label:
          default: "サブネット設定"
        Parameters:
          - PublicSubnet1CIDR
          - PublicSubnet2CIDR
          - PrivateAppSubnet1CIDR
          - PrivateAppSubnet2CIDR
          - PrivateDBSubnet1CIDR
          - PrivateDBSubnet2CIDR
          - PrivateCacheSubnet1CIDR
          - PrivateCacheSubnet2CIDR

Parameters:
  ProjectName:
    Type: String
    Default: niigata-kaigo
    Description: プロジェクト名
    AllowedPattern: ^[a-z][a-z0-9-]*$
    ConstraintDescription: 小文字英数字とハイフンのみ使用可能

  Environment:
    Type: String
    Default: prod
    Description: 環境名
    AllowedValues:
      - prod
      - staging
    ConstraintDescription: prod または staging を指定してください

  VpcCIDR:
    Type: String
    Default: 10.1.0.0/16
    Description: VPCのCIDRブロック
    AllowedPattern: ^(10\.(1|2)\.)0\.0/16$
    ConstraintDescription: 10.1.0.0/16 (prod) または 10.2.0.0/16 (staging) を指定してください

  AvailabilityZone1:
    Type: AWS::EC2::AvailabilityZone::Name
    Default: ap-northeast-1a
    Description: 最初のアベイラビリティゾーン

  AvailabilityZone2:
    Type: AWS::EC2::AvailabilityZone::Name
    Default: ap-northeast-1c
    Description: 2番目のアベイラビリティゾーン

  PublicSubnet1CIDR:
    Type: String
    Default: 10.1.1.0/24
    Description: パブリックサブネット1のCIDR
    AllowedPattern: ^(10\.(1|2)\.)1\.0/24$

  PublicSubnet2CIDR:
    Type: String
    Default: 10.1.2.0/24
    Description: パブリックサブネット2のCIDR
    AllowedPattern: ^(10\.(1|2)\.)2\.0/24$

  PrivateAppSubnet1CIDR:
    Type: String
    Default: 10.1.11.0/24
    Description: プライベートアプリサブネット1のCIDR
    AllowedPattern: ^(10\.(1|2)\.)11\.0/24$

  PrivateAppSubnet2CIDR:
    Type: String
    Default: 10.1.12.0/24
    Description: プライベートアプリサブネット2のCIDR
    AllowedPattern: ^(10\.(1|2)\.)12\.0/24$

  PrivateDBSubnet1CIDR:
    Type: String
    Default: 10.1.21.0/24
    Description: プライベートDBサブネット1のCIDR
    AllowedPattern: ^(10\.(1|2)\.)21\.0/24$

  PrivateDBSubnet2CIDR:
    Type: String
    Default: 10.1.22.0/24
    Description: プライベートDBサブネット2のCIDR
    AllowedPattern: ^(10\.(1|2)\.)22\.0/24$

  PrivateCacheSubnet1CIDR:
    Type: String
    Default: 10.1.31.0/24
    Description: プライベートキャッシュサブネット1のCIDR
    AllowedPattern: ^(10\.(1|2)\.)31\.0/24$

  PrivateCacheSubnet2CIDR:
    Type: String
    Default: 10.1.32.0/24
    Description: プライベートキャッシュサブネット2のCIDR
    AllowedPattern: ^(10\.(1|2)\.)32\.0/24$

  VpcFlowLogsRetentionDays:
    Type: Number
    Default: 90
    Description: VPCフローログの保持期間（日）
    AllowedValues: [1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, 3653]

Resources:
  # VPC
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCIDR
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-vpc'
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  # インターネットゲートウェイ
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-igw'
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  AttachInternetGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # パブリックサブネット
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnet1CIDR
      AvailabilityZone: !Ref AvailabilityZone1
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-public-subnet-1'
        - Key: Type
          Value: Public
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnet2CIDR
      AvailabilityZone: !Ref AvailabilityZone2
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-public-subnet-2'
        - Key: Type
          Value: Public
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  # プライベートアプリサブネット
  PrivateAppSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateAppSubnet1CIDR
      AvailabilityZone: !Ref AvailabilityZone1
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-private-app-subnet-1'
        - Key: Type
          Value: Private-App
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  PrivateAppSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateAppSubnet2CIDR
      AvailabilityZone: !Ref AvailabilityZone2
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-private-app-subnet-2'
        - Key: Type
          Value: Private-App
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  # プライベートDBサブネット
  PrivateDBSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateDBSubnet1CIDR
      AvailabilityZone: !Ref AvailabilityZone1
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-private-db-subnet-1'
        - Key: Type
          Value: Private-DB
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  PrivateDBSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateDBSubnet2CIDR
      AvailabilityZone: !Ref AvailabilityZone2
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-private-db-subnet-2'
        - Key: Type
          Value: Private-DB
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  # プライベートキャッシュサブネット
  PrivateCacheSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateCacheSubnet1CIDR
      AvailabilityZone: !Ref AvailabilityZone1
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-private-cache-subnet-1'
        - Key: Type
          Value: Private-Cache
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  PrivateCacheSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateCacheSubnet2CIDR
      AvailabilityZone: !Ref AvailabilityZone2
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-private-cache-subnet-2'
        - Key: Type
          Value: Private-Cache
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  # Elastic IP for NAT Gateway 1
  NatGateway1EIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachInternetGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-nat-eip-1'
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  # Elastic IP for NAT Gateway 2
  NatGateway2EIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachInternetGateway
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-nat-eip-2'
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  # NAT Gateway 1 (AZ1)
  NatGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGateway1EIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-nat-1'
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  # NAT Gateway 2 (AZ2)
  NatGateway2:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGateway2EIP.AllocationId
      SubnetId: !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-nat-2'
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  # パブリックルートテーブル
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-public-rt'
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachInternetGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  # プライベートルートテーブル1 (AZ1用)
  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-private-rt-1'
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  PrivateRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway1

  PrivateAppSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateAppSubnet1
      RouteTableId: !Ref PrivateRouteTable1

  PrivateDBSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateDBSubnet1
      RouteTableId: !Ref PrivateRouteTable1

  PrivateCacheSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateCacheSubnet1
      RouteTableId: !Ref PrivateRouteTable1

  # プライベートルートテーブル2 (AZ2用)
  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-private-rt-2'
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  PrivateRoute2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway2

  PrivateAppSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateAppSubnet2
      RouteTableId: !Ref PrivateRouteTable2

  PrivateDBSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateDBSubnet2
      RouteTableId: !Ref PrivateRouteTable2

  PrivateCacheSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateCacheSubnet2
      RouteTableId: !Ref PrivateRouteTable2

  # VPCエンドポイント - S3 (Gateway型)
  S3VPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.s3'
      VpcEndpointType: Gateway
      RouteTableIds:
        - !Ref PrivateRouteTable1
        - !Ref PrivateRouteTable2

  # VPCエンドポイント - DynamoDB (Gateway型)
  DynamoDBVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.dynamodb'
      VpcEndpointType: Gateway
      RouteTableIds:
        - !Ref PrivateRouteTable1
        - !Ref PrivateRouteTable2

  # VPCフローログ用CloudWatch Logsロググループ
  VpcFlowLogsGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/vpc/${ProjectName}-${Environment}'
      RetentionInDays: !Ref VpcFlowLogsRetentionDays

  # VPCフローログ用IAMロール
  VpcFlowLogsRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-${Environment}-vpc-flow-logs-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: vpc-flow-logs.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CloudWatchLogPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                Resource: !GetAtt VpcFlowLogsGroup.Arn
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-vpc-flow-logs-role'
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

  # VPCフローログ
  VpcFlowLog:
    Type: AWS::EC2::FlowLog
    Properties:
      ResourceType: VPC
      ResourceId: !Ref VPC
      TrafficType: ALL
      LogDestinationType: cloud-watch-logs
      LogGroupName: !Ref VpcFlowLogsGroup
      DeliverLogsPermissionArn: !GetAtt VpcFlowLogsRole.Arn
      LogFormat: '${version} ${account-id} ${interface-id} ${srcaddr} ${dstaddr} ${srcport} ${dstport} ${protocol} ${packets} ${bytes} ${start} ${end} ${action} ${log-status}'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-vpc-flow-log'
        - Key: Environment
          Value: !Ref Environment
        - Key: ManagedBy
          Value: CloudFormation

Outputs:
  VpcId:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: !Sub '${ProjectName}-${Environment}-VpcId'

  VpcCIDR:
    Description: VPC CIDR Block
    Value: !GetAtt VPC.CidrBlock
    Export:
      Name: !Sub '${ProjectName}-${Environment}-VpcCIDR'

  PublicSubnet1Id:
    Description: パブリックサブネット1 ID
    Value: !Ref PublicSubnet1
    Export:
      Name: !Sub '${ProjectName}-${Environment}-PublicSubnet1Id'

  PublicSubnet2Id:
    Description: パブリックサブネット2 ID
    Value: !Ref PublicSubnet2
    Export:
      Name: !Sub '${ProjectName}-${Environment}-PublicSubnet2Id'

  PrivateAppSubnet1Id:
    Description: プライベートアプリサブネット1 ID
    Value: !Ref PrivateAppSubnet1
    Export:
      Name: !Sub '${ProjectName}-${Environment}-PrivateAppSubnet1Id'

  PrivateAppSubnet2Id:
    Description: プライベートアプリサブネット2 ID
    Value: !Ref PrivateAppSubnet2
    Export:
      Name: !Sub '${ProjectName}-${Environment}-PrivateAppSubnet2Id'

  PrivateDBSubnet1Id:
    Description: プライベートDBサブネット1 ID
    Value: !Ref PrivateDBSubnet1
    Export:
      Name: !Sub '${ProjectName}-${Environment}-PrivateDBSubnet1Id'

  PrivateDBSubnet2Id:
    Description: プライベートDBサブネット2 ID
    Value: !Ref PrivateDBSubnet2
    Export:
      Name: !Sub '${ProjectName}-${Environment}-PrivateDBSubnet2Id'

  PrivateCacheSubnet1Id:
    Description: プライベートキャッシュサブネット1 ID
    Value: !Ref PrivateCacheSubnet1
    Export:
      Name: !Sub '${ProjectName}-${Environment}-PrivateCacheSubnet1Id'

  PrivateCacheSubnet2Id:
    Description: プライベートキャッシュサブネット2 ID
    Value: !Ref PrivateCacheSubnet2
    Export:
      Name: !Sub '${ProjectName}-${Environment}-PrivateCacheSubnet2Id'

  PublicSubnets:
    Description: パブリックサブネット (カンマ区切り)
    Value: !Join [',', [!Ref PublicSubnet1, !Ref PublicSubnet2]]
    Export:
      Name: !Sub '${ProjectName}-${Environment}-PublicSubnets'

  PrivateAppSubnets:
    Description: プライベートアプリサブネット (カンマ区切り)
    Value: !Join [',', [!Ref PrivateAppSubnet1, !Ref PrivateAppSubnet2]]
    Export:
      Name: !Sub '${ProjectName}-${Environment}-PrivateAppSubnets'

  PrivateDBSubnets:
    Description: プライベートDBサブネット (カンマ区切り)
    Value: !Join [',', [!Ref PrivateDBSubnet1, !Ref PrivateDBSubnet2]]
    Export:
      Name: !Sub '${ProjectName}-${Environment}-PrivateDBSubnets'

  PrivateCacheSubnets:
    Description: プライベートキャッシュサブネット (カンマ区切り)
    Value: !Join [',', [!Ref PrivateCacheSubnet1, !Ref PrivateCacheSubnet2]]
    Export:
      Name: !Sub '${ProjectName}-${Environment}-PrivateCacheSubnets'

  NatGateway1Id:
    Description: NAT Gateway 1 ID
    Value: !Ref NatGateway1
    Export:
      Name: !Sub '${ProjectName}-${Environment}-NatGateway1Id'

  NatGateway2Id:
    Description: NAT Gateway 2 ID
    Value: !Ref NatGateway2
    Export:
      Name: !Sub '${ProjectName}-${Environment}-NatGateway2Id'

  VpcFlowLogsGroupName:
    Description: VPCフローログのCloudWatch Logsグループ名
    Value: !Ref VpcFlowLogsGroup
    Export:
      Name: !Sub '${ProjectName}-${Environment}-VpcFlowLogsGroup'
