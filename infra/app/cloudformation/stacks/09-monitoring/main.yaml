AWSTemplateFormatVersion: '2010-09-09'
Description: 'Monitoring Stack - SNS Topics, Log Groups, VPC Flow Logs, CloudWatch Alarms, AWS Backup'

Parameters:
  EnvironmentName:
    Type: String
    Description: Environment name (dev, staging, production)
    AllowedValues:
      - dev
      - staging
      - production

  ProjectName:
    Type: String
    Description: Project name for resource naming

  # SNS Topics Parameters
  AlertEmailAddress:
    Type: String
    Description: Email address for application alerts (Critical, Warning, Info)
    Default: infra-alerts@example.com

  SlackWebhookUrl:
    Type: String
    Description: Slack Webhook URL for application alerts
    Default: https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK
    NoEcho: true

  # Log Groups Parameters
  LogRetentionDays:
    Type: Number
    Description: Log retention days for application logs
    Default: 90
    AllowedValues: [1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, 3653]

  # VPC Flow Logs Parameters
  VPCId:
    Type: String
    Description: VPC ID for Flow Logs

  FlowLogsRetentionDays:
    Type: Number
    Description: VPC Flow Logs retention days for GCAS requirement
    Default: 90
    AllowedValues: [1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, 3653]

  # CloudWatch Alarms Parameters
  LoadBalancerFullName:
    Type: String
    Description: Full name of the ALB
    Default: ""

  TargetGroupFullName:
    Type: String
    Description: Full name of the Target Group
    Default: ""

  ECSClusterName:
    Type: String
    Description: Name of the ECS Cluster
    Default: ""

  ECSServiceName:
    Type: String
    Description: Name of the ECS Service
    Default: ""

  DBInstanceId:
    Type: String
    Description: RDS DB Instance ID
    Default: ""

  ReplicationGroupId:
    Type: String
    Description: ElastiCache Replication Group ID
    Default: ""

  # Alarm Thresholds
  ALBUnhealthyHostThreshold:
    Type: Number
    Description: Threshold for unhealthy hosts
    Default: 1

  ECSCPUThreshold:
    Type: Number
    Description: Threshold for ECS CPU utilization (%)
    Default: 80

  ECSMemoryThreshold:
    Type: Number
    Description: Threshold for ECS memory utilization (%)
    Default: 80

  RDSCPUThreshold:
    Type: Number
    Description: Threshold for RDS CPU utilization (%)
    Default: 80

  RDSConnectionsThreshold:
    Type: Number
    Description: Threshold for RDS connections
    Default: 80

  RedisCPUThreshold:
    Type: Number
    Description: Threshold for Redis CPU utilization (%)
    Default: 75

  RedisMemoryThreshold:
    Type: Number
    Description: Threshold for Redis memory utilization (%)
    Default: 80

  # AWS Backup Parameters
  KMSKeyId:
    Type: String
    Description: KMS Key ID for backup encryption

  BackupSchedule:
    Type: String
    Description: Cron expression for backup schedule
    Default: "cron(0 17 * * ? *)"

  DeleteAfterDays:
    Type: Number
    Description: Days to retain backups
    Default: 7

  BackupWindowMinutes:
    Type: Number
    Description: Backup window in minutes
    Default: 60

  CompletionWindowMinutes:
    Type: Number
    Description: Completion window in minutes
    Default: 120

  MoveToColdStorageAfterDays:
    Type: Number
    Description: Days to move to cold storage (0 = disabled)
    Default: 30

  TemplateBucketName:
    Type: String
    Description: S3 bucket name where nested stack templates are stored

Resources:
  # ==============================================================================
  # SNS Topics Stack (Foundation)
  # ==============================================================================
  SNSTopicsStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://${TemplateBucketName}.s3.${AWS::Region}.amazonaws.com/app/templates/monitoring/app-sns-topics.yaml'
      Parameters:
        EnvironmentName: !Ref EnvironmentName
        ProjectName: !Ref ProjectName
        AlertEmailAddress: !Ref AlertEmailAddress
        SlackWebhookUrl: !Ref SlackWebhookUrl
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${EnvironmentName}-sns-topics-stack'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Project
          Value: !Ref ProjectName

  # ==============================================================================
  # Log Groups Stack (Foundation)
  # ==============================================================================
  LogGroupsStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://${TemplateBucketName}.s3.${AWS::Region}.amazonaws.com/app/templates/monitoring/app-log-groups.yaml'
      Parameters:
        EnvironmentName: !Ref EnvironmentName
        ProjectName: !Ref ProjectName
        LogRetentionDays: !Ref LogRetentionDays
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${EnvironmentName}-log-groups-stack'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Project
          Value: !Ref ProjectName

  # ==============================================================================
  # VPC Flow Logs Stack (GCAS Requirement)
  # ==============================================================================
  VPCFlowLogsStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://${TemplateBucketName}.s3.${AWS::Region}.amazonaws.com/app/templates/monitoring/vpc-flow-logs.yaml'
      Parameters:
        EnvironmentName: !Ref EnvironmentName
        ProjectName: !Ref ProjectName
        VPCId: !Ref VPCId
        FlowLogsRetentionDays: !Ref FlowLogsRetentionDays
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${EnvironmentName}-vpc-flow-logs-stack'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Project
          Value: !Ref ProjectName
        - Key: Compliance
          Value: GCAS

  # ==============================================================================
  # CloudWatch Alarms Stack
  # ==============================================================================
  CloudWatchAlarmsStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: SNSTopicsStack
    Properties:
      TemplateURL: !Sub 'https://${TemplateBucketName}.s3.${AWS::Region}.amazonaws.com/app/templates/monitoring/cloudwatch-alarms.yaml'
      Parameters:
        EnvironmentName: !Ref EnvironmentName
        ProjectName: !Ref ProjectName
        SNSTopicArn: !GetAtt SNSTopicsStack.Outputs.CriticalAlertTopicArn
        LoadBalancerFullName: !Ref LoadBalancerFullName
        TargetGroupFullName: !Ref TargetGroupFullName
        ECSClusterName: !Ref ECSClusterName
        ECSServiceName: !Ref ECSServiceName
        DBInstanceId: !Ref DBInstanceId
        ReplicationGroupId: !Ref ReplicationGroupId
        ALBUnhealthyHostThreshold: !Ref ALBUnhealthyHostThreshold
        ECSCPUThreshold: !Ref ECSCPUThreshold
        ECSMemoryThreshold: !Ref ECSMemoryThreshold
        RDSCPUThreshold: !Ref RDSCPUThreshold
        RDSConnectionsThreshold: !Ref RDSConnectionsThreshold
        RedisCPUThreshold: !Ref RedisCPUThreshold
        RedisMemoryThreshold: !Ref RedisMemoryThreshold
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${EnvironmentName}-cloudwatch-alarms-stack'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Project
          Value: !Ref ProjectName

  # ==============================================================================
  # AWS Backup Stack
  # ==============================================================================
  AWSBackupStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://${TemplateBucketName}.s3.${AWS::Region}.amazonaws.com/app/templates/monitoring/aws-backup.yaml'
      Parameters:
        EnvironmentName: !Ref EnvironmentName
        ProjectName: !Ref ProjectName
        KMSKeyId: !Ref KMSKeyId
        BackupSchedule: !Ref BackupSchedule
        DeleteAfterDays: !Ref DeleteAfterDays
        BackupWindowMinutes: !Ref BackupWindowMinutes
        CompletionWindowMinutes: !Ref CompletionWindowMinutes
        MoveToColdStorageAfterDays: !Ref MoveToColdStorageAfterDays
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${EnvironmentName}-backup-stack'
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Project
          Value: !Ref ProjectName

Outputs:
  # SNS Topics Outputs
  CriticalAlertTopicArn:
    Description: Critical Alert SNS Topic ARN
    Value: !GetAtt SNSTopicsStack.Outputs.CriticalAlertTopicArn
    Export:
      Name: !Sub '${ProjectName}-${EnvironmentName}-CriticalAlertTopicArn'

  WarningAlertTopicArn:
    Description: Warning Alert SNS Topic ARN
    Value: !GetAtt SNSTopicsStack.Outputs.WarningAlertTopicArn
    Export:
      Name: !Sub '${ProjectName}-${EnvironmentName}-WarningAlertTopicArn'

  InfoAlertTopicArn:
    Description: Info Alert SNS Topic ARN
    Value: !GetAtt SNSTopicsStack.Outputs.InfoAlertTopicArn
    Export:
      Name: !Sub '${ProjectName}-${EnvironmentName}-InfoAlertTopicArn'

  # Log Groups Outputs
  ProviderBackendLogGroupArn:
    Description: Provider Backend Log Group ARN
    Value: !GetAtt LogGroupsStack.Outputs.ProviderBackendLogGroupArn
    Export:
      Name: !Sub '${ProjectName}-${EnvironmentName}-ProviderBackendLogGroupArn'

  StaffBackendLogGroupArn:
    Description: Staff Backend Log Group ARN
    Value: !GetAtt LogGroupsStack.Outputs.StaffBackendLogGroupArn
    Export:
      Name: !Sub '${ProjectName}-${EnvironmentName}-StaffBackendLogGroupArn'

  BatchLogGroupArn:
    Description: Batch Log Group ARN
    Value: !GetAtt LogGroupsStack.Outputs.BatchLogGroupArn
    Export:
      Name: !Sub '${ProjectName}-${EnvironmentName}-BatchLogGroupArn'

  # VPC Flow Logs Outputs
  VPCFlowLogsLogGroupArn:
    Description: VPC Flow Logs CloudWatch Logs Group ARN
    Value: !GetAtt VPCFlowLogsStack.Outputs.VPCFlowLogsLogGroupArn
    Export:
      Name: !Sub '${ProjectName}-${EnvironmentName}-VPCFlowLogsLogGroupArn'

  VPCFlowLogId:
    Description: VPC Flow Log ID
    Value: !GetAtt VPCFlowLogsStack.Outputs.VPCFlowLogId
    Export:
      Name: !Sub '${ProjectName}-${EnvironmentName}-VPCFlowLogId'

  # Backup Outputs
  BackupVaultName:
    Description: Name of the Backup Vault
    Value: !GetAtt AWSBackupStack.Outputs.BackupVaultName
    Export:
      Name: !Sub '${ProjectName}-${EnvironmentName}-backup-vault'

  BackupVaultArn:
    Description: ARN of the Backup Vault
    Value: !GetAtt AWSBackupStack.Outputs.BackupVaultArn
    Export:
      Name: !Sub '${ProjectName}-${EnvironmentName}-backup-vault-arn'

  BackupPlanId:
    Description: ID of the Backup Plan
    Value: !GetAtt AWSBackupStack.Outputs.BackupPlanId
    Export:
      Name: !Sub '${ProjectName}-${EnvironmentName}-backup-plan-id'

  BackupPlanArn:
    Description: ARN of the Backup Plan
    Value: !GetAtt AWSBackupStack.Outputs.BackupPlanArn
    Export:
      Name: !Sub '${ProjectName}-${EnvironmentName}-backup-plan-arn'

  BackupNotificationTopicArn:
    Description: ARN of the Backup Notification SNS Topic
    Value: !GetAtt AWSBackupStack.Outputs.BackupNotificationTopicArn
    Export:
      Name: !Sub '${ProjectName}-${EnvironmentName}-backup-notification-topic-arn'
